<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- Inform modern browsers that this page supports both dark and light color schemes,
  and the page author prefers light. --><meta name="color-scheme" content="dark light">
<script>
  // If `prefers-color-scheme` is not supported, fall back to light mode.
  // i.e. In this case, inject the `light` CSS before the others, with
  // no media filter so that it will be downloaded with highest priority.
  if (window.matchMedia("(prefers-color-scheme: dark)").media === "not all") {
    document.documentElement.style.display = "none";
    document.head.insertAdjacentHTML(
      "beforeend",
      "<link id=\"css\" rel=\"stylesheet\" href=\"https://bootswatch.com/3/flatly/bootstrap.css\" onload=\"document.documentElement.style.display = ''\">"
    );
  }
</script><title>03: server_functions.R • GoContactR</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- Flatly Theme - Light  --><link id="css-light" rel="stylesheet" href="https://bootswatch.com/3/flatly/bootstrap.css" media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)">
<!-- Darkly Theme - Dark --><link id="css-dark" rel="stylesheet" href="https://bootswatch.com/3/darkly/bootstrap.css" media="(prefers-color-scheme: dark)">
<!-- preferably CSS --><link rel="stylesheet" href="../preferably.css">
<link id="css-code-light" rel="stylesheet" href="../code-color-scheme-light.css" media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)">
<link id="css-code-dark" rel="stylesheet" href="../code-color-scheme-dark.css" media="(prefers-color-scheme: dark)">
<!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="03: server_functions.R">
<meta property="og:description" content="GoContactR">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">GoContactR</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">Home</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Scripts
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/a01_global.html">01 global.R</a>
    </li>
    <li>
      <a href="../articles/a02_server.html">02 server.R</a>
    </li>
    <li>
      <a href="../articles/a03_server_functions.html">03 server_functions.R</a>
    </li>
    <li>
      <a href="../articles/a03.1_server_functions_for_CIV.html">03.1 server_functions_for_CIV.R</a>
    </li>
    <li>
      <a href="../articles/a03.2_server_functions_for_COG.html">03.2 server_functions_for_COG.R</a>
    </li>
    <li>
      <a href="../articles/a03.3_server_functions_for_SAMPLE.html">03.3 server_functions_for_SAMPLE.R</a>
    </li>
    <li>
      <a href="../articles/a03.4_server_functions_for_UGA.html">03.4 server_functions_for_UGA.R</a>
    </li>
    <li>
      <a href="../articles/a04_ui.html">04 ui.R</a>
    </li>
    <li>
      <a href="../articles/a05_report.html">05 report.Rmd</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Report outputs
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/gocontactr_report_html_page.html">HTML page</a>
    </li>
    <li>
      <a href="../articles/gocontactr_report_html_slides.html">HTML slides</a>
    </li>
  </ul>
</li>
<li>
  <a href="../articles/a06_video_walkthroughs.html">Walkthroughs</a>
</li>
<li>
  <a href="https://gocontactr.shinyapps.io/sample">View Sample App</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/kendavidn/GoContactR/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
        
        


      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="a03_server_functions_files/header-attrs-2.8/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>03: server_functions.R</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/kendavidn/GoContactR/blob/master/vignettes/a03_server_functions.Rmd"><code>vignettes/a03_server_functions.Rmd</code></a></small>
      <div class="hidden name"><code>a03_server_functions.Rmd</code></div>

    </div>

    
    
<div id="source-and-load-country-specific-server-functions" class="section level1">
<h1 class="hasAnchor">
<a href="#source-and-load-country-specific-server-functions" class="anchor"></a>Source and load country-specific server functions</h1>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<span class="co"># ~  Source and load country-specific server functions -----</span>
<span class="co"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></code></pre></div>
<p>Here we source two functions related to reading in and transforming the source data, namely read_file_raw and read_file_transformed. We also source the UI elements required to load in the source data. This is the only part of the app that changes between countries. There are currently two versions of functions/reactives/UI elements that are sourced in this script. - One version creates UI elements to enter Go.Data credentials and fetches the Go.Data data - The other version creates UI elements to upload KoboCollect csvs.</p>
<div id="read_file_filtered" class="section level2">
<h2 class="hasAnchor">
<a href="#read_file_filtered" class="anchor"></a>read_file_filtered</h2>
<p>The ‘read_file_filtered’ function takes in data from read_file_transformed_reactive It also takes in a date_of_review variable. It filters out contacts who had not begun followup by the selected date_of_review Also, for contacts being followed, “future” are relabelled as such. The output of read_file_filtered is a df that feed most graphs in the app.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">read_file_filtered</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">contacts_df_long_transformed</span>, <span class="va">todays_date</span><span class="op">)</span> <span class="op">{</span>
  <span class="co">## takes no inputs for now</span>
  
  
  <span class="va">all_cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">contacts_df_long_transformed</span><span class="op">)</span>
  
  <span class="co">## note that this needs to match the columns on which filters are created</span>
  <span class="co">## in the output$filters section</span>
  
  <span class="va">cols_to_filter</span> <span class="op">&lt;-</span> 
    <span class="va">contacts_df_long_transformed</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co">## not sure why but tibble doesn't work</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="fu">any_of</span><span class="op">(</span><span class="va">cols_to_exclude_from_filters</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="co">## no filters for columns that are all NA</span>
    <span class="fu">janitor</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/janitor/man/remove_empty.html">remove_empty</a></span><span class="op">(</span>which <span class="op">=</span> <span class="st">"cols"</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="op">)</span>
  
  
  
  <span class="co">## dont filter unless asked to, obviously</span>
  <span class="kw">if</span> <span class="op">(</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">filter_or_not</span><span class="op">)</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="va">input</span><span class="op">$</span><span class="va">filter_or_not</span> <span class="op">==</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">{</span>
    
    <span class="co">## the filtering syntax works for dataframes, but not tibbles, for some reason</span>
    <span class="va">temp</span> <span class="op">&lt;-</span> <span class="va">contacts_df_long_transformed</span> 
    
    
    <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">all_cols</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
      
      <span class="va">col_df</span> <span class="op">&lt;-</span> <span class="va">temp</span><span class="op">[</span><span class="va">all_cols</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>
      <span class="va">col_name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">col_df</span><span class="op">)</span>
      <span class="va">col_vector</span> <span class="op">&lt;-</span> <span class="fu">pull</span><span class="op">(</span><span class="va">col_df</span><span class="op">)</span>
      <span class="va">values_to_keep</span> <span class="op">&lt;-</span> <span class="va">input</span><span class="op">[[</span><span class="va">all_cols</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">]</span>
      <span class="va">na_id</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"na_"</span>, <span class="va">all_cols</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>
      <span class="va">keep_na</span> <span class="op">&lt;-</span> <span class="va">input</span><span class="op">[[</span><span class="va">na_id</span><span class="op">]</span><span class="op">]</span>

      <span class="co">## only filter on those in the cols_to_filter group.</span>
      <span class="kw">if</span> <span class="op">(</span><span class="va">col_name</span> <span class="op">%in%</span> <span class="va">cols_to_filter</span><span class="op">)</span> <span class="op">{</span>
        
        <span class="co">## FACTOR OR CHARACTER COLUMNS ~~~~~~~~~~~~~~~~~~~</span>
        <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html">is.factor</a></span><span class="op">(</span><span class="va">col_vector</span><span class="op">)</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">is.character</a></span><span class="op">(</span><span class="va">col_vector</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
          
          <span class="co">## keep values selected by the respective UI element</span>
          <span class="va">temp</span> <span class="op">&lt;-</span> <span class="va">temp</span><span class="op">[</span><span class="va">col_vector</span> <span class="op">%in%</span> <span class="va">values_to_keep</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">col_vector</span><span class="op">)</span>, <span class="op">]</span>

          <span class="co">## drop NAs if asked to do so</span>
          <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">keep_na</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="va">keep_na</span> <span class="op">==</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="va">temp</span> <span class="op">&lt;-</span> <span class="va">temp</span> <span class="op">%&gt;%</span> <span class="fu">drop_na</span><span class="op">(</span><span class="va">col_name</span><span class="op">)</span>
          
          <span class="co">## NUMERIC COLUMNS  ~~~~~~~~~~~~~~~~~~~</span>
        <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">is.numeric</a></span><span class="op">(</span><span class="va">col_vector</span><span class="op">)</span> <span class="op">|</span> <span class="fu"><a href="http://lubridate.tidyverse.org/reference/date_utils.html">is.Date</a></span><span class="op">(</span><span class="va">col_vector</span><span class="op">)</span> <span class="op">)</span> <span class="op">{</span>
          
          <span class="co">## keep values greater than the minimum and less than maximum</span>
          <span class="co">## as indicated by user on drag string</span>
          <span class="va">temp</span> <span class="op">&lt;-</span> <span class="va">temp</span><span class="op">[</span><span class="op">(</span><span class="va">col_vector</span> <span class="op">&gt;=</span> <span class="va">values_to_keep</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&amp;</span> 
                         <span class="va">col_vector</span> <span class="op">&lt;=</span> <span class="va">values_to_keep</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>
                         <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">col_vector</span><span class="op">)</span>, <span class="op">]</span>
          <span class="co">## drop NAs if asked to do so</span>
          <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">keep_na</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="va">keep_na</span> <span class="op">==</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="va">temp</span> <span class="op">&lt;-</span> <span class="va">temp</span> <span class="op">%&gt;%</span> <span class="fu">drop_na</span><span class="op">(</span><span class="va">col_name</span><span class="op">)</span>
        <span class="op">}</span>
      <span class="op">}</span>
    <span class="op">}</span>
   
    <span class="va">contacts_df_long_transformed</span> <span class="op">&lt;-</span> <span class="va">temp</span>
  <span class="op">}</span>
  

  
  <span class="va">contacts_df_long</span> <span class="op">&lt;-</span>
    <span class="va">contacts_df_long_transformed</span> <span class="op">%&gt;%</span>
    <span class="co"># keep only those for whom follow-up had begun by the date of review</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">row_id</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">follow_up_date</span><span class="op">)</span> <span class="op">&lt;=</span> <span class="va">todays_date</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="co">## add future follow-up.</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>follow_up_status <span class="op">=</span> <span class="fu">if_else</span><span class="op">(</span><span class="va">follow_up_date</span> <span class="op">&gt;</span> <span class="va">todays_date</span>,
                                      <span class="st">"Future follow-up"</span>,
                                      <span class="va">follow_up_status</span>
    <span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>follow_up_status_simple <span class="op">=</span> <span class="fu">if_else</span><span class="op">(</span><span class="va">follow_up_date</span> <span class="op">&gt;</span> <span class="va">todays_date</span>,
                                             <span class="st">"Future follow-up"</span>,
                                             <span class="va">follow_up_status_simple</span>
    <span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="co"># add legend colors</span>
    <span class="co"># legend_df is defined in global.R</span>
    <span class="fu">left_join</span><span class="op">(</span><span class="va">legend_df</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"follow_up_status"</span> <span class="op">=</span> <span class="st">"breaks"</span><span class="op">)</span><span class="op">)</span>
  
  <span class="co">## return</span>
  <span class="va">contacts_df_long</span>
<span class="op">}</span></code></pre></div>
</div>
</div>
<div id="data-overview-plots" class="section level1">
<h1 class="hasAnchor">
<a href="#data-overview-plots" class="anchor"></a>Data overview plots</h1>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<span class="co"># ~  Data overview plots ------------------</span>
<span class="co"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></code></pre></div>
<div id="data_completeness_plot" class="section level2">
<h2 class="hasAnchor">
<a href="#data_completeness_plot" class="anchor"></a>data_completeness_plot</h2>
<p>Here we output a visualization of the entire long dataframe. Uses the viz_dat function</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">data_completeness_plot</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">contacts_df_long_transformed</span><span class="op">)</span><span class="op">{</span>
  
  <span class="va">contacts_df_long_transformed</span> <span class="op">%&gt;%</span> 
    <span class="op">{</span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">500</span><span class="op">)</span> <span class="fu">sample_n</span><span class="op">(</span><span class="va">.</span>, <span class="fl">500</span><span class="op">)</span> <span class="kw">else</span> <span class="va">.</span><span class="op">}</span> <span class="op">%&gt;%</span> <span class="co"># sample if too large</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="op">-</span><span class="va">row_id</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="co">## remove synthetic cols </span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="fu">any_of</span><span class="op">(</span>x<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"synthetic_var_to_preserve_row_order"</span>,
                        <span class="st">"sort_number"</span>, <span class="st">"counter"</span>, <span class="st">"row_id"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="co">## group of columns to remove</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">matches</a></span><span class="op">(</span><span class="st">"autres_symptomes"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu">visdat</span><span class="fu">::</span><span class="fu"><a href="http://visdat.njtierney.com//reference/vis_dat.html">vis_dat</a></span><span class="op">(</span>sort_type <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://rdrr.io/pkg/paletteer/man/ggplot2-scales-discrete.html">scale_fill_paletteer_d</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"NineteenEightyR::sonny"</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">theme</span><span class="op">(</span>axis.text.x <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">60</span>, hjust <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>,<span class="op">)</span> <span class="op">+</span>
    <span class="fu">scale_y_continuous</span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>, limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="cn">NA</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
    <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Summary of uploaded dataframe (two dataframes merged)"</span>, 
         subtitle <span class="op">=</span> <span class="st">"Data types and missingness are shown."</span><span class="op">)</span><span class="op">+</span> 
    <span class="fu">theme</span><span class="op">(</span>title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span><span class="op">)</span>
  
<span class="op">}</span></code></pre></div>
</div>
<div id="data_cardinality_plot" class="section level2">
<h2 class="hasAnchor">
<a href="#data_cardinality_plot" class="anchor"></a>data_cardinality_plot</h2>
<p>This is a plot using the ‘inspect_cat’ function of the inspectdf package</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">data_cardinality_plot</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">contacts_df_long_transformed</span><span class="op">)</span><span class="op">{</span>
  
  <span class="va">contacts_df_long_transformed</span> <span class="op">%&gt;%</span> 
    <span class="op">{</span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">500</span><span class="op">)</span> <span class="fu">sample_n</span><span class="op">(</span><span class="va">.</span>, <span class="fl">500</span><span class="op">)</span> <span class="kw">else</span> <span class="va">.</span><span class="op">}</span> <span class="op">%&gt;%</span> <span class="co"># sample if too large</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="fu">any_of</span><span class="op">(</span>x<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"sort_number"</span>, <span class="st">"counter"</span>, <span class="st">"row_id"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu">inspectdf</span><span class="fu">::</span><span class="fu"><a href="https://alastairrushworth.github.io/inspectdf/reference/inspect_cat.html">inspect_cat</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://alastairrushworth.github.io/inspectdf/reference/show_plot.html">show_plot</a></span><span class="op">(</span>col_palette <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">+</span> 
    <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Freq. of categorical vars in dataset"</span><span class="op">)</span>
  
<span class="op">}</span></code></pre></div>
</div>
<div id="reactable_table" class="section level2">
<h2 class="hasAnchor">
<a href="#reactable_table" class="anchor"></a>reactable_table</h2>
<p>Here, we output the entire long table for easy viewing, or searching</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">reactable_table</span> <span class="op">&lt;-</span> 
  <span class="kw">function</span><span class="op">(</span><span class="va">contacts_df_long_transformed</span><span class="op">)</span><span class="op">{</span>
    
    <span class="va">contacts_df_long_transformed</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">matches</a></span><span class="op">(</span><span class="st">"first_name|last_name"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co"># remove names. anonymity</span>
      <span class="fu"><a href="https://glin.github.io/reactable/reference/reactable.html">reactable</a></span><span class="op">(</span>searchable <span class="op">=</span> <span class="cn">TRUE</span>,
                striped <span class="op">=</span> <span class="cn">TRUE</span>,
                highlight <span class="op">=</span> <span class="cn">TRUE</span>,
                filterable <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
  <span class="op">}</span>   </code></pre></div>
</div>
</div>
<div id="generate-downloadable-report" class="section level1">
<h1 class="hasAnchor">
<a href="#generate-downloadable-report" class="anchor"></a>Generate downloadable report</h1>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<span class="co"># ~  Generate downloadable report --------------------</span>
<span class="co"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></code></pre></div>
<div id="download_report_function" class="section level2">
<h2 class="hasAnchor">
<a href="#download_report_function" class="anchor"></a>download_report_function</h2>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">download_report_function</span> <span class="op">&lt;-</span> 
  <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/downloadHandler.html">downloadHandler</a></span><span class="op">(</span>
  
    <span class="co">## Can't pass this in as a regular argument for some reason. See https://community.rstudio.com/t/switching-between-output-formats-while-generating-downloadable-rmarkdown-reports-from-shiny/71429</span>
  
  filename <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span><span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"gocontactr_report."</span>, <span class="kw"><a href="https://rdrr.io/r/base/switch.html">switch</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">report_format</span>, 
                                                            <span class="st">"pdf"</span><span class="op">=</span> <span class="st">"pdf"</span>, 
                                                            <span class="st">"docx"</span><span class="op">=</span> <span class="st">"docx"</span>, 
                                                            <span class="st">"html (page)"</span><span class="op">=</span> <span class="st">"html"</span>,
                                                            <span class="st">"html (slides)"</span> <span class="op">=</span> <span class="st">"html"</span>,
                                                            <span class="st">"pptx"</span> <span class="op">=</span> <span class="st">"pptx"</span><span class="op">)</span><span class="op">)</span>
    <span class="op">}</span>,
  
  
  content <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">file</span><span class="op">)</span> <span class="op">{</span>
    
    <span class="co">## encapsulate content function in file tracker</span>
    <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/withProgress.html">withProgress</a></span><span class="op">(</span>message <span class="op">=</span> <span class="st">"Creating GoContactR Report"</span>, 
                 detail <span class="op">=</span> <span class="st">"Initiating"</span>, <span class="op">{</span>
      
      <span class="va">temp_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempdir</a></span><span class="op">(</span><span class="op">)</span>
      
      <span class="va">rmd_old_path</span> <span class="op">&lt;-</span> <span class="st">"markdown/report.Rmd"</span> 
      <span class="va">rmd_new_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">temp_dir</span>, <span class="st">"report.Rmd"</span><span class="op">)</span>
      
      <span class="va">docx_template_old_path</span> <span class="op">&lt;-</span> <span class="st">"markdown/docx_template.docx"</span>
      <span class="va">docx_template_new_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">temp_dir</span>, <span class="st">"docx_template.docx"</span><span class="op">)</span>
      
      <span class="va">pptx_template_old_path</span> <span class="op">&lt;-</span> <span class="st">"markdown/pptx_template.pptx"</span>
      <span class="va">pptx_template_new_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">temp_dir</span>, <span class="st">"pptx_template.pptx"</span><span class="op">)</span>
      
      <span class="co"># Copy Rmd and templates to a temp dir. before knitting, in case we don't have write permissions to the current working dir (which can happen when deployed).</span>
      <span class="fu"><a href="https://rdrr.io/r/base/files.html">file.copy</a></span><span class="op">(</span>from <span class="op">=</span> <span class="va">rmd_old_path</span>, to <span class="op">=</span> <span class="va">rmd_new_path</span>, overwrite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
      <span class="fu"><a href="https://rdrr.io/r/base/files.html">file.copy</a></span><span class="op">(</span>from <span class="op">=</span> <span class="va">docx_template_old_path</span>, to <span class="op">=</span> <span class="va">docx_template_new_path</span>, overwrite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
      <span class="fu"><a href="https://rdrr.io/r/base/files.html">file.copy</a></span><span class="op">(</span>from <span class="op">=</span> <span class="va">pptx_template_old_path</span>, to <span class="op">=</span> <span class="va">pptx_template_new_path</span>, overwrite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
      
      
      <span class="co"># Set up params for Rmd</span>
      <span class="va">params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span>
      <span class="co">## normally I would pass all these params in as arguments to the function, </span>
      <span class="co">## but they don't seem to work when I do this</span>
      <span class="va">params</span><span class="op">$</span><span class="va">rendered_by_shiny</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span>
      <span class="va">params</span><span class="op">$</span><span class="va">contacts_df_long</span> <span class="op">&lt;-</span> <span class="fu">read_file_filtered_reactive</span><span class="op">(</span><span class="op">)</span>
      <span class="va">params</span><span class="op">$</span><span class="va">todays_date</span> <span class="op">&lt;-</span> <span class="va">input</span><span class="op">$</span><span class="va">select_date_of_review</span>
      <span class="va">params</span><span class="op">$</span><span class="va">report_format</span> <span class="op">&lt;-</span> <span class="va">input</span><span class="op">$</span><span class="va">report_format</span>
      

      <span class="kw">if</span> <span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">report_format</span> <span class="op">==</span> <span class="st">"pdf"</span><span class="op">)</span><span class="op">{</span>
        <span class="co"># if output format is pdf</span>
        <span class="co"># first create paged html</span>
        <span class="va">html_doc</span> <span class="op">&lt;-</span> <span class="fu">rmarkdown</span><span class="fu">::</span><span class="fu"><a href="https://pkgs.rstudio.com/rmarkdown/reference/render.html">render</a></span><span class="op">(</span>
          input <span class="op">=</span> <span class="va">rmd_new_path</span>,
          output_format <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/pagedreport/man/paged_windmill.html">paged_windmill</a></span><span class="op">(</span>logo <span class="op">=</span> <span class="st">"markdown/logo.svg"</span>, 
                                                        logo_to_white <span class="op">=</span> <span class="cn">TRUE</span>,
                                                        front_img <span class="op">=</span> <span class="st">"markdown/front_img.jpg"</span>,
                                                        img_to_dark <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
          params <span class="op">=</span> <span class="va">params</span>,
          envir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/environment.html">new.env</a></span><span class="op">(</span>parent <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/environment.html">globalenv</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="co"># child of the global environment (this isolates the code in the document from the code in this app). Not sure why. Rstudio says so,</span>
        <span class="op">)</span>
        <span class="co"># then covert paged html to pdf</span>
        <span class="fu">pagedown</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pagedown/man/chrome_print.html">chrome_print</a></span><span class="op">(</span><span class="va">html_doc</span>, <span class="va">file</span>, extra_args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"--disable-gpu"</span>, 
                                                              <span class="st">"--no-sandbox"</span><span class="op">)</span>, 
                               async <span class="op">=</span> <span class="cn">TRUE</span> <span class="co">## not sure if relevant</span>
                               <span class="op">)</span>
        
      <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
        <span class="co">#browser()</span>
      <span class="co"># for other output formats knit directly to output file</span>
      <span class="fu">rmarkdown</span><span class="fu">::</span><span class="fu"><a href="https://pkgs.rstudio.com/rmarkdown/reference/render.html">render</a></span><span class="op">(</span>
        input <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">temp_dir</span>, <span class="st">"report.Rmd"</span><span class="op">)</span>,
        output_file <span class="op">=</span> <span class="va">file</span>,
        output_format <span class="op">=</span> <span class="kw"><a href="https://rdrr.io/r/base/switch.html">switch</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">report_format</span>, 
                               <span class="st">"docx"</span><span class="op">=</span> <span class="fu"><a href="https://davidgohel.github.io/officedown/reference/rdocx_document.html">rdocx_document</a></span><span class="op">(</span>toc <span class="op">=</span> <span class="cn">TRUE</span>, 
                                                      reference_docx <span class="op">=</span> <span class="va">docx_template_new_path</span><span class="op">)</span>, 
                               <span class="st">"html (page)"</span><span class="op">=</span> <span class="fu"><a href="https://pkgs.rstudio.com/rmarkdown/reference/html_document.html">html_document</a></span><span class="op">(</span>theme <span class="op">=</span> <span class="st">"cerulean"</span>, 
                                                     toc <span class="op">=</span> <span class="cn">TRUE</span>,
                                                     toc_depth <span class="op">=</span> <span class="fl">3</span>,
                                                     toc_float <span class="op">=</span> <span class="cn">TRUE</span>, 
                                                     self_contained <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
                               <span class="st">"html (slides)"</span><span class="op">=</span> <span class="fu"><a href="https://pkgs.rstudio.com/rmarkdown/reference/slidy_presentation.html">slidy_presentation</a></span><span class="op">(</span>slide_level <span class="op">=</span> <span class="fl">3</span>, 
                                                                   footer <span class="op">=</span> <span class="st">"World Health Organization Regional Office for Africa"</span>, 
                                                                   self_contained <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
                               <span class="st">"pptx"</span> <span class="op">=</span> <span class="fu"><a href="https://davidgohel.github.io/officedown/reference/rpptx_document.html">rpptx_document</a></span><span class="op">(</span>reference_doc <span class="op">=</span> <span class="va">pptx_template_new_path</span>, 
                                                       slide_level <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>
                               <span class="op">)</span>,
        params <span class="op">=</span> <span class="va">params</span>,
        envir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/environment.html">new.env</a></span><span class="op">(</span>parent <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/environment.html">globalenv</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="co"># child of the global environment (this isolates the code in the document from the code in this app). Not sure why. Rstudio says so,</span>
      <span class="op">)</span>
        
      <span class="op">}</span>

      
      
    <span class="op">}</span><span class="op">)</span>
    
  <span class="op">}</span>
<span class="op">)</span>
  
<span class="op">}</span></code></pre></div>
</div>
</div>
<div id="outputs-pertaining-to-all-contacts" class="section level1">
<h1 class="hasAnchor">
<a href="#outputs-pertaining-to-all-contacts" class="anchor"></a>OUTPUTS PERTAINING TO ALL CONTACTS</h1>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<span class="co"># ~ OUTPUTS PERTAINING TO ALL CONTACTS ----</span>
<span class="co">#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></code></pre></div>
</div>
<div id="value-boxes" class="section level1">
<h1 class="hasAnchor">
<a href="#value-boxes" class="anchor"></a>Value boxes</h1>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<span class="co"># ~ Value boxes  --------------------</span>
<span class="co"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></code></pre></div>
<p>Below we define the value-box functions and return their outputs. These functions return an HTML Shiny value-box when the report_format parameter is “shiny”, and a ggplot-based value-box otherwise. Like most of the remaining functions that the app uses, these take in two primary inputs: the long contacts dataframe (one row per follow-up-day), and the date of review. ## new_contacts_per_day_value_box</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## here we count the number of new contacts registered per day,</span>
<span class="co">## based on follow-up start date</span>
<span class="va">new_contacts_per_day_value_box</span> <span class="op">&lt;-</span> 
  <span class="kw">function</span><span class="op">(</span><span class="va">contacts_df_long</span>, <span class="va">todays_date</span>, <span class="va">report_format</span> <span class="op">=</span> <span class="st">"shiny"</span><span class="op">)</span><span class="op">{</span>
    
      <span class="va">data_to_plot</span> <span class="op">&lt;-</span> 
        <span class="va">contacts_df_long</span> <span class="op">%&gt;%</span>
        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">follow_up_day</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span> 
        <span class="fu">count</span><span class="op">(</span><span class="va">follow_up_start_date</span><span class="op">)</span> <span class="op">%&gt;%</span> 
        <span class="fu">complete</span><span class="op">(</span>follow_up_start_date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.Date.html">seq.Date</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">.</span><span class="op">$</span><span class="va">follow_up_start_date</span><span class="op">)</span>, 
                                       to <span class="op">=</span> <span class="va">todays_date</span>, 
                                       by <span class="op">=</span> <span class="st">"day"</span><span class="op">)</span>, 
                 fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span>
      
      <span class="co">## for labels</span>
      <span class="va">cases_last_day</span> <span class="op">&lt;-</span> 
        <span class="va">data_to_plot</span> <span class="op">%&gt;%</span> 
        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">follow_up_start_date</span> <span class="op">==</span> <span class="va">todays_date</span><span class="op">)</span> <span class="op">%&gt;%</span> 
        <span class="va">.</span><span class="op">$</span><span class="va">n</span>
      
      <span class="va">date_last_day</span> <span class="op">&lt;-</span> 
        <span class="va">todays_date</span> <span class="op">%&gt;%</span> 
        <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">format.Date</a></span><span class="op">(</span><span class="st">"%b %d"</span><span class="op">)</span>
      
      <span class="co">## different output format for shiny vs others</span>
      <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">==</span> <span class="st">"shiny"</span><span class="op">)</span><span class="op">{</span>
        
        <span class="va">highchart_to_plot</span> <span class="op">&lt;-</span> 
          <span class="va">data_to_plot</span> <span class="op">%&gt;%</span> 
          <span class="fu"><a href="http://jkunst.com/highcharter/reference/hchart.html">hchart</a></span><span class="op">(</span><span class="st">"column"</span>, <span class="fu"><a href="http://jkunst.com/highcharter/reference/hcaes.html">hcaes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">follow_up_start_date</span>, y <span class="op">=</span> <span class="va">n</span><span class="op">)</span>, name <span class="op">=</span> <span class="st">"No. contacts"</span><span class="op">)</span> <span class="op">%&gt;%</span> 
          <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_size.html">hc_size</a></span><span class="op">(</span>height <span class="op">=</span> <span class="fl">85</span><span class="op">)</span> <span class="op">%&gt;%</span> 
          <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_credits.html">hc_credits</a></span><span class="op">(</span>enabled <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">%&gt;%</span> 
          <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_add_theme.html">hc_add_theme</a></span><span class="op">(</span><span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_theme_538.html">hc_theme_sparkline_vb</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> 
      
        <span class="va">output_valuebox</span> <span class="op">&lt;-</span> 
          <span class="co">## valueboxspark is a custom function defined in misc_functions</span>
          <span class="fu">valueBoxSpark</span><span class="op">(</span>
          value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/htmltools/man/HTML.html">HTML</a></span><span class="op">(</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op">(</span><span class="st">"{cases_last_day} &lt;font size='1'&gt; in past day ({date_last_day}) &lt;/font&gt;"</span><span class="op">)</span><span class="op">)</span>,
          title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/chartr.html">toupper</a></span><span class="op">(</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op">(</span><span class="st">"New contacts"</span><span class="op">)</span><span class="op">)</span>,
          sparkobj <span class="op">=</span> <span class="va">highchart_to_plot</span>,
          info <span class="op">=</span> <span class="st">"Bars show the no. of new contacts per day (based on first date of follow-up)"</span>,
          subtitle <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/htmltools/man/HTML.html">HTML</a></span><span class="op">(</span><span class="st">"&lt;font size='1'&gt; &lt;/font&gt;"</span><span class="op">)</span>,
          <span class="co">#icon = icon("calendar-day"),</span>
          width <span class="op">=</span> <span class="fl">2</span>,
          color <span class="op">=</span> <span class="st">"aqua"</span>,
          href <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span>
      
      <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
        
        <span class="va">output_valuebox</span> <span class="op">&lt;-</span> 
          <span class="va">data_to_plot</span> <span class="op">%&gt;%</span> 
          <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
          <span class="fu">geom_col</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span> <span class="va">follow_up_start_date</span>, y <span class="op">=</span> <span class="va">n</span><span class="op">)</span>, fill <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span> <span class="op">+</span> 
          <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"**NEW CONTACTS**"</span>, 
               subtitle <span class="op">=</span> <span class="fu">glue</span><span class="fu">::</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op">(</span><span class="st">"**{cases_last_day}** in past day ({date_last_day})"</span><span class="op">)</span>, 
               x <span class="op">=</span> <span class="st">""</span>,
               y <span class="op">=</span> <span class="st">""</span><span class="op">)</span> <span class="op">+</span> 
          <span class="fu">scale_x_date</span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">data_to_plot</span><span class="op">$</span><span class="va">follow_up_start_date</span><span class="op">)</span>,  
                                  <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">data_to_plot</span><span class="op">$</span><span class="va">follow_up_start_date</span><span class="op">)</span><span class="op">)</span>, 
                       labels <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">.x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">format.Date</a></span><span class="op">(</span><span class="va">.x</span>, format <span class="op">=</span> <span class="st">"%b %d, '%y"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
          <span class="fu">theme_classic</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
          <span class="fu">theme</span><span class="op">(</span>panel.background <span class="op">=</span> <span class="fu">element_rect</span><span class="op">(</span><span class="st">"#00BAEA"</span><span class="op">)</span>, 
                plot.background <span class="op">=</span> <span class="fu">element_rect</span><span class="op">(</span><span class="st">"#00BAEA"</span><span class="op">)</span>, 
                plot.title <span class="op">=</span> <span class="fu">ggtext</span><span class="fu">::</span><span class="fu"><a href="https://wilkelab.org/ggtext/reference/element_textbox.html">element_textbox</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"white"</span>, size <span class="op">=</span> <span class="fl">15</span><span class="op">)</span>,
                plot.subtitle <span class="op">=</span> <span class="fu">ggtext</span><span class="fu">::</span><span class="fu"><a href="https://wilkelab.org/ggtext/reference/element_textbox.html">element_textbox</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"white"</span>, size <span class="op">=</span> <span class="fl">13</span><span class="op">)</span>, 
                panel.grid.major <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>, 
                axis.line <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>, 
                axis.text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">10</span>, color <span class="op">=</span> <span class="st">"white"</span>, face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>, 
                axis.text.x <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">.8</span><span class="op">)</span>,
                axis.ticks.length <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">.2</span>, <span class="st">"cm"</span><span class="op">)</span>, 
                axis.ticks <span class="op">=</span> <span class="fu">element_line</span><span class="op">(</span>color <span class="op">=</span> <span class="st">"white"</span>, size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> 
      <span class="op">}</span>
      
      
      <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">output_valuebox</span><span class="op">)</span>
      
      
    
  <span class="op">}</span></code></pre></div>
<div id="cumulative_contacts_value_box" class="section level2">
<h2 class="hasAnchor">
<a href="#cumulative_contacts_value_box" class="anchor"></a>cumulative_contacts_value_box</h2>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cumulative_contacts_value_box</span> <span class="op">&lt;-</span> 
  <span class="kw">function</span><span class="op">(</span><span class="va">contacts_df_long</span>, <span class="va">todays_date</span>, <span class="va">report_format</span> <span class="op">=</span> <span class="st">"shiny"</span><span class="op">)</span><span class="op">{</span>
  
    <span class="co">## we count cumulative contacts with the same variable we used to count</span>
    <span class="co">## </span>
    <span class="va">data_to_plot</span> <span class="op">&lt;-</span> 
      <span class="va">contacts_df_long</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">contact_id</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">slice_head</span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">follow_up_start_date</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">count</span><span class="op">(</span><span class="va">follow_up_start_date</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">complete</span><span class="op">(</span>follow_up_start_date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.Date.html">seq.Date</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">.</span><span class="op">$</span><span class="va">follow_up_start_date</span><span class="op">)</span>, 
                                           to <span class="op">=</span> <span class="va">todays_date</span>, 
                                           by <span class="op">=</span> <span class="st">"day"</span><span class="op">)</span>, 
               fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>cum_n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html">cumsum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span>
    
    <span class="va">cases_last_day</span> <span class="op">&lt;-</span> 
      <span class="va">data_to_plot</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">follow_up_start_date</span> <span class="op">==</span> <span class="va">todays_date</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="va">.</span><span class="op">$</span><span class="va">cum_n</span>
    
    <span class="va">date_last_day</span> <span class="op">&lt;-</span> 
      <span class="va">todays_date</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">format.Date</a></span><span class="op">(</span><span class="st">"%b %d"</span><span class="op">)</span>
    
    
    <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">==</span> <span class="st">"shiny"</span><span class="op">)</span><span class="op">{</span>
      
      <span class="va">highchart_to_plot</span> <span class="op">&lt;-</span> 
        <span class="va">data_to_plot</span> <span class="op">%&gt;%</span> 
        <span class="fu"><a href="http://jkunst.com/highcharter/reference/hchart.html">hchart</a></span><span class="op">(</span><span class="st">"column"</span>, <span class="fu"><a href="http://jkunst.com/highcharter/reference/hcaes.html">hcaes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">follow_up_start_date</span>, y <span class="op">=</span> <span class="va">cum_n</span><span class="op">)</span>, name <span class="op">=</span> <span class="st">"Cumul. contacts"</span><span class="op">)</span> <span class="op">%&gt;%</span> 
        <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_size.html">hc_size</a></span><span class="op">(</span>height <span class="op">=</span> <span class="fl">85</span><span class="op">)</span> <span class="op">%&gt;%</span> 
        <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_credits.html">hc_credits</a></span><span class="op">(</span>enabled <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">%&gt;%</span> 
        <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_add_theme.html">hc_add_theme</a></span><span class="op">(</span><span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_theme_538.html">hc_theme_sparkline_vb</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> 
    
      <span class="va">output_valuebox</span> <span class="op">&lt;-</span> 
        <span class="fu">valueBoxSpark</span><span class="op">(</span>
        value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/htmltools/man/HTML.html">HTML</a></span><span class="op">(</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op">(</span><span class="st">"{cases_last_day} &lt;font size='1'&gt; by {date_last_day} &lt;/font&gt;"</span><span class="op">)</span><span class="op">)</span>,
        title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/chartr.html">toupper</a></span><span class="op">(</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op">(</span><span class="st">"Cumul. contacts"</span><span class="op">)</span><span class="op">)</span>,
        sparkobj <span class="op">=</span> <span class="va">highchart_to_plot</span>,
        info <span class="op">=</span> <span class="st">"Bars show the cumulative contacts as at each day."</span>,
        subtitle <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/htmltools/man/HTML.html">HTML</a></span><span class="op">(</span><span class="st">" &lt;font size='1'&gt; &lt;/font&gt;"</span><span class="op">)</span>,
        <span class="co">#icon = icon("calendar-alt"),</span>
        width <span class="op">=</span> <span class="fl">2</span>,
        color <span class="op">=</span> <span class="st">"teal"</span>,
        href <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span>
    
    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
    
    
    <span class="co">## ggplot version for rmarkdown</span>
    <span class="va">output_valuebox</span> <span class="op">&lt;-</span> 
      <span class="va">data_to_plot</span> <span class="op">%&gt;%</span> 
      <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
      <span class="fu">geom_col</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span> <span class="va">follow_up_start_date</span>, y <span class="op">=</span> <span class="va">cum_n</span><span class="op">)</span>, fill <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span> <span class="op">+</span> 
      <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"**CUMUL. CONTACTS**"</span>, 
           subtitle <span class="op">=</span> <span class="fu">glue</span><span class="fu">::</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op">(</span><span class="st">"**{cases_last_day}** by {date_last_day}"</span><span class="op">)</span>, 
           x <span class="op">=</span> <span class="st">""</span>,
           y <span class="op">=</span> <span class="st">""</span><span class="op">)</span> <span class="op">+</span> 
      <span class="fu">scale_x_date</span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">data_to_plot</span><span class="op">$</span><span class="va">follow_up_start_date</span><span class="op">)</span>,  
                              <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">data_to_plot</span><span class="op">$</span><span class="va">follow_up_start_date</span><span class="op">)</span><span class="op">)</span>, 
                   labels <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">.x</span> <span class="op">)</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">format.Date</a></span><span class="op">(</span><span class="va">.x</span>, format <span class="op">=</span> <span class="st">"%b %d, '%y"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
      <span class="fu">theme_classic</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
      <span class="fu">theme</span><span class="op">(</span>panel.background <span class="op">=</span> <span class="fu">element_rect</span><span class="op">(</span><span class="st">"#0EC6C5"</span><span class="op">)</span>, 
            plot.background <span class="op">=</span> <span class="fu">element_rect</span><span class="op">(</span><span class="st">"#0EC6C5"</span><span class="op">)</span>, 
            plot.title <span class="op">=</span> <span class="fu">ggtext</span><span class="fu">::</span><span class="fu"><a href="https://wilkelab.org/ggtext/reference/element_textbox.html">element_textbox</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"white"</span>, size <span class="op">=</span> <span class="fl">15</span><span class="op">)</span>,
            plot.subtitle <span class="op">=</span> <span class="fu">ggtext</span><span class="fu">::</span><span class="fu"><a href="https://wilkelab.org/ggtext/reference/element_textbox.html">element_textbox</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"white"</span>, size <span class="op">=</span> <span class="fl">13</span><span class="op">)</span>, 
            panel.grid.major <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>, 
            axis.line <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>, 
            axis.text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">10</span>, color <span class="op">=</span> <span class="st">"white"</span>, face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>, 
            axis.text.x <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">.8</span><span class="op">)</span>,
            axis.ticks.length <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">.2</span>, <span class="st">"cm"</span><span class="op">)</span>, 
            axis.ticks <span class="op">=</span> <span class="fu">element_line</span><span class="op">(</span>color <span class="op">=</span> <span class="st">"white"</span>, size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> 
    <span class="op">}</span>
    
    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">output_valuebox</span><span class="op">)</span>
    
  <span class="op">}</span></code></pre></div>
</div>
<div id="contacts_under_surveillance_value_box" class="section level2">
<h2 class="hasAnchor">
<a href="#contacts_under_surveillance_value_box" class="anchor"></a>contacts_under_surveillance_value_box</h2>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">contacts_under_surveillance_value_box</span> <span class="op">&lt;-</span> 
  <span class="kw">function</span><span class="op">(</span><span class="va">contacts_df_long</span>, <span class="va">todays_date</span>, <span class="va">report_format</span> <span class="op">=</span> <span class="st">"shiny"</span><span class="op">)</span><span class="op">{</span>
    
    <span class="va">data_to_plot</span> <span class="op">&lt;-</span> 
      <span class="va">contacts_df_long</span> <span class="op">%&gt;%</span>
      <span class="fu">count</span><span class="op">(</span><span class="va">follow_up_date</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="co"># drop follow'ups past today's date</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">follow_up_date</span> <span class="op">&lt;=</span> <span class="va">todays_date</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">complete</span><span class="op">(</span>follow_up_date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.Date.html">seq.Date</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">contacts_df_long</span><span class="op">$</span><span class="va">follow_up_date</span><span class="op">)</span>, 
                                     to <span class="op">=</span> <span class="va">todays_date</span>, 
                                     by <span class="op">=</span> <span class="st">"day"</span><span class="op">)</span>, 
               fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span>
    
    
    <span class="va">cases_last_day</span> <span class="op">&lt;-</span> 
      <span class="va">data_to_plot</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">follow_up_date</span> <span class="op">==</span> <span class="va">todays_date</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="va">.</span><span class="op">$</span><span class="va">n</span>
    
    <span class="va">date_last_day</span> <span class="op">&lt;-</span> 
      <span class="va">todays_date</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">format.Date</a></span><span class="op">(</span><span class="st">"%b %d"</span><span class="op">)</span>
    
    <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">==</span> <span class="st">"shiny"</span><span class="op">)</span><span class="op">{</span>

    <span class="va">highchart_to_plot</span> <span class="op">&lt;-</span> 
      <span class="va">data_to_plot</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hchart.html">hchart</a></span><span class="op">(</span><span class="st">"column"</span>, <span class="fu"><a href="http://jkunst.com/highcharter/reference/hcaes.html">hcaes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">follow_up_date</span>, y <span class="op">=</span> <span class="va">n</span><span class="op">)</span>, name <span class="op">=</span> <span class="st">"No. under surveillance"</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_size.html">hc_size</a></span><span class="op">(</span>height <span class="op">=</span> <span class="fl">85</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_credits.html">hc_credits</a></span><span class="op">(</span>enabled <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_add_theme.html">hc_add_theme</a></span><span class="op">(</span><span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_theme_538.html">hc_theme_sparkline_vb</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> 
    
    <span class="va">output_valuebox</span> <span class="op">&lt;-</span> 
      <span class="fu">valueBoxSpark</span><span class="op">(</span>
      value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/htmltools/man/HTML.html">HTML</a></span><span class="op">(</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op">(</span><span class="st">"{cases_last_day} &lt;font size='1'&gt; as at {date_last_day} &lt;/font&gt;"</span><span class="op">)</span><span class="op">)</span>,
      title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/chartr.html">toupper</a></span><span class="op">(</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op">(</span><span class="st">"No. under surveillance"</span><span class="op">)</span><span class="op">)</span>,
      sparkobj <span class="op">=</span> <span class="va">highchart_to_plot</span>,
      info <span class="op">=</span> <span class="st">" Bars show the number that should be under surveillance on each day, based on date of last contact with a case"</span>,
      subtitle <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/htmltools/man/HTML.html">HTML</a></span><span class="op">(</span><span class="st">" &lt;font size='1'&gt; &lt;/font&gt;"</span><span class="op">)</span>,
      <span class="co">#icon = icon("binoculars"),</span>
      width <span class="op">=</span> <span class="fl">2</span>,
      color <span class="op">=</span> <span class="st">"purple"</span>,
      href <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span>
    
    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
    
    <span class="co">## ggplot version for rmarkdown</span>
      <span class="va">output_valuebox</span> <span class="op">&lt;-</span> 
      <span class="va">data_to_plot</span> <span class="op">%&gt;%</span> 
      <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
      <span class="fu">geom_col</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span> <span class="va">follow_up_date</span>, y <span class="op">=</span> <span class="va">n</span><span class="op">)</span>, fill <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span> <span class="op">+</span> 
      <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"**NO. UNDER SURVEILLANCE**"</span>, 
           subtitle <span class="op">=</span> <span class="fu">glue</span><span class="fu">::</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op">(</span><span class="st">"**{cases_last_day}** as at {date_last_day}"</span><span class="op">)</span>, 
           x <span class="op">=</span> <span class="st">""</span>,
           y <span class="op">=</span> <span class="st">""</span><span class="op">)</span> <span class="op">+</span> 
      <span class="fu">scale_x_date</span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">data_to_plot</span><span class="op">$</span><span class="va">follow_up_date</span><span class="op">)</span>,  
                              <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">data_to_plot</span><span class="op">$</span><span class="va">follow_up_date</span><span class="op">)</span><span class="op">)</span>, 
                   labels <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">.x</span> <span class="op">)</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">format.Date</a></span><span class="op">(</span><span class="va">.x</span>, format <span class="op">=</span> <span class="st">"%b %d, '%y"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
      <span class="fu">theme_classic</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
      <span class="fu">theme</span><span class="op">(</span>panel.background <span class="op">=</span> <span class="fu">element_rect</span><span class="op">(</span><span class="st">"#51539B"</span><span class="op">)</span>, 
            plot.background <span class="op">=</span> <span class="fu">element_rect</span><span class="op">(</span><span class="st">"#51539B"</span><span class="op">)</span>, 
            plot.title <span class="op">=</span> <span class="fu">ggtext</span><span class="fu">::</span><span class="fu"><a href="https://wilkelab.org/ggtext/reference/element_textbox.html">element_textbox</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"white"</span>, size <span class="op">=</span> <span class="fl">15</span><span class="op">)</span>,
            plot.subtitle <span class="op">=</span> <span class="fu">ggtext</span><span class="fu">::</span><span class="fu"><a href="https://wilkelab.org/ggtext/reference/element_textbox.html">element_textbox</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"white"</span>, size <span class="op">=</span> <span class="fl">13</span><span class="op">)</span>, 
            panel.grid.major <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>, 
            axis.line <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>, 
            axis.text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">10</span>, color <span class="op">=</span> <span class="st">"white"</span>, face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>, 
            axis.text.x <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">.8</span><span class="op">)</span>,
            axis.ticks.length <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">.2</span>, <span class="st">"cm"</span><span class="op">)</span>, 
            axis.ticks <span class="op">=</span> <span class="fu">element_line</span><span class="op">(</span>color <span class="op">=</span> <span class="st">"white"</span>, size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> 
    <span class="op">}</span>
    
    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">output_valuebox</span><span class="op">)</span>
    
    
  <span class="op">}</span></code></pre></div>
</div>
<div id="pct_contacts_followed_value_box" class="section level2">
<h2 class="hasAnchor">
<a href="#pct_contacts_followed_value_box" class="anchor"></a>pct_contacts_followed_value_box</h2>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">pct_contacts_followed_value_box</span> <span class="op">&lt;-</span> 
  <span class="kw">function</span><span class="op">(</span><span class="va">contacts_df_long</span>, <span class="va">todays_date</span>, <span class="va">report_format</span> <span class="op">=</span> <span class="st">"shiny"</span><span class="op">)</span><span class="op">{</span>
    

    <span class="va">data_to_plot</span> <span class="op">&lt;-</span> 
      <span class="va">contacts_df_long</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">follow_up_date</span> <span class="op">&lt;=</span> <span class="va">todays_date</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">count</span><span class="op">(</span><span class="va">follow_up_date</span>, <span class="va">follow_up_status_simple</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">bind_rows</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>follow_up_status_simple <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Seen"</span>, <span class="st">"Not seen"</span><span class="op">)</span>, 
                n <span class="op">=</span> <span class="fl">0</span>,
                follow_up_date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="st">"2100-01-01"</span><span class="op">)</span>
                <span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">complete</span><span class="op">(</span>follow_up_date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.Date.html">seq.Date</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">contacts_df_long</span><span class="op">$</span><span class="va">follow_up_date</span><span class="op">)</span>, 
                                         to <span class="op">=</span> <span class="va">todays_date</span>, 
                                         by <span class="op">=</span> <span class="st">"day"</span><span class="op">)</span>, 
               <span class="va">follow_up_status_simple</span>,
               fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">follow_up_date</span> <span class="op">!=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="st">"2100-01-01"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="co">## remove not generated follow-ups. Not relevant for this calculation </span>
      <span class="co">## specific to Go.Data data</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">follow_up_status_simple</span> <span class="op">!=</span> <span class="st">"Not generated"</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">follow_up_date</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>total <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>prop <span class="op">=</span> <span class="va">n</span><span class="op">/</span><span class="va">total</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>pct <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fl">100</span><span class="op">*</span><span class="va">prop</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>pct_paste <span class="op">=</span> <span class="fu"><a href="https://scales.r-lib.org/reference/label_percent.html">percent</a></span><span class="op">(</span><span class="va">prop</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">follow_up_status_simple</span> <span class="op">==</span> <span class="st">"Seen"</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>hc_ttip <span class="op">=</span> <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op">(</span><span class="st">"&lt;b&gt;Date:&lt;/b&gt; {format.Date(follow_up_date,  format = '%a %b %d, %Y')}&lt;br&gt;
                        &lt;b&gt;{follow_up_status_simple}:&lt;/b&gt; {pct_paste} ({n} of {total} )
                        "</span><span class="op">)</span><span class="op">)</span>
    
    <span class="va">pct_last_day</span> <span class="op">&lt;-</span> 
      <span class="va">data_to_plot</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">follow_up_date</span> <span class="op">==</span> <span class="va">todays_date</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="va">.</span><span class="op">$</span><span class="va">pct_paste</span>
    
    <span class="va">date_last_day</span> <span class="op">&lt;-</span> 
      <span class="va">todays_date</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">format.Date</a></span><span class="op">(</span><span class="st">"%b %d"</span><span class="op">)</span>
    
    <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">==</span> <span class="st">"shiny"</span><span class="op">)</span><span class="op">{</span>
      
    <span class="va">highchart_to_plot</span> <span class="op">&lt;-</span> 
      <span class="va">data_to_plot</span> <span class="op">%&gt;%</span>  
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hchart.html">hchart</a></span><span class="op">(</span><span class="st">"area"</span>, <span class="fu"><a href="http://jkunst.com/highcharter/reference/hcaes.html">hcaes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">follow_up_date</span>, y <span class="op">=</span> <span class="va">pct</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_tooltip.html">hc_tooltip</a></span><span class="op">(</span>formatter <span class="op">=</span> <span class="fu"><a href="http://jkunst.com/highcharter/reference/highcharter-exports.html">JS</a></span><span class="op">(</span><span class="st">"function(){return(this.point.hc_ttip)}"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_size.html">hc_size</a></span><span class="op">(</span>height <span class="op">=</span> <span class="fl">85</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_credits.html">hc_credits</a></span><span class="op">(</span>enabled <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_add_theme.html">hc_add_theme</a></span><span class="op">(</span><span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_theme_538.html">hc_theme_sparkline_vb</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> 
    
    <span class="va">output_valuebox</span> <span class="op">&lt;-</span> 
      <span class="fu">valueBoxSpark</span><span class="op">(</span>
      value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/htmltools/man/HTML.html">HTML</a></span><span class="op">(</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op">(</span><span class="st">"{pct_last_day} &lt;font size='1'&gt; on {date_last_day} &lt;/font&gt;"</span><span class="op">)</span><span class="op">)</span>,
      title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/chartr.html">toupper</a></span><span class="op">(</span><span class="st">"% contacts followed"</span><span class="op">)</span>,
      sparkobj <span class="op">=</span> <span class="va">highchart_to_plot</span>,
      info <span class="op">=</span> <span class="st">"Line plot shows the percentage followed on each day"</span>,
      subtitle <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/htmltools/man/HTML.html">HTML</a></span><span class="op">(</span><span class="st">" &lt;font size='1'&gt; &lt;/font&gt;"</span><span class="op">)</span>,
      <span class="co">#icon = icon("check-square"),</span>
      width <span class="op">=</span> <span class="fl">2</span>,
      color <span class="op">=</span> <span class="st">"yellow"</span>,
      href <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span>
    
    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
    
    <span class="co">## ggplot version for rmarkdown</span>
    <span class="va">output_valuebox</span> <span class="op">&lt;-</span> 
      <span class="va">data_to_plot</span> <span class="op">%&gt;%</span> 
      <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
      <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span> <span class="va">follow_up_date</span>, y <span class="op">=</span> <span class="va">pct</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"white"</span>, 
                size <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span> 
      <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"**% CONTACTS FOLLOWED**"</span>, 
           subtitle <span class="op">=</span> <span class="fu">glue</span><span class="fu">::</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op">(</span><span class="st">"**{pct_last_day}** on {date_last_day}"</span><span class="op">)</span>, 
           x <span class="op">=</span> <span class="st">""</span>,
           y <span class="op">=</span> <span class="st">""</span><span class="op">)</span> <span class="op">+</span> 
      <span class="fu">scale_x_date</span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">data_to_plot</span><span class="op">$</span><span class="va">follow_up_date</span><span class="op">)</span>,  
                              <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">data_to_plot</span><span class="op">$</span><span class="va">follow_up_date</span><span class="op">)</span><span class="op">)</span>, 
                   labels <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">.x</span> <span class="op">)</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">format.Date</a></span><span class="op">(</span><span class="va">.x</span>, format <span class="op">=</span> <span class="st">"%b %d, '%y"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
      <span class="fu">theme_classic</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
      <span class="fu">theme</span><span class="op">(</span>panel.background <span class="op">=</span> <span class="fu">element_rect</span><span class="op">(</span><span class="st">"#F88F26"</span><span class="op">)</span>, 
            plot.background <span class="op">=</span> <span class="fu">element_rect</span><span class="op">(</span><span class="st">"#F88F26"</span><span class="op">)</span>, 
            plot.title <span class="op">=</span> <span class="fu">ggtext</span><span class="fu">::</span><span class="fu"><a href="https://wilkelab.org/ggtext/reference/element_textbox.html">element_textbox</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"white"</span>, size <span class="op">=</span> <span class="fl">15</span><span class="op">)</span>,
            plot.subtitle <span class="op">=</span> <span class="fu">ggtext</span><span class="fu">::</span><span class="fu"><a href="https://wilkelab.org/ggtext/reference/element_textbox.html">element_textbox</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"white"</span>, size <span class="op">=</span> <span class="fl">13</span><span class="op">)</span>, 
            panel.grid.major <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>, 
            axis.line <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>, 
            axis.text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">10</span>, color <span class="op">=</span> <span class="st">"white"</span>, face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>, 
            axis.text.x <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">.8</span><span class="op">)</span>,
            axis.ticks.length <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">.2</span>, <span class="st">"cm"</span><span class="op">)</span>, 
            axis.ticks <span class="op">=</span> <span class="fu">element_line</span><span class="op">(</span>color <span class="op">=</span> <span class="st">"white"</span>, size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> 
    <span class="op">}</span>
    
    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">output_valuebox</span><span class="op">)</span>
  <span class="op">}</span></code></pre></div>
</div>
</div>
<div id="new_contacts_today" class="section level1">
<h1 class="hasAnchor">
<a href="#new_contacts_today" class="anchor"></a>new_contacts_today</h1>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<span class="co"># ~ new_contacts_today -----------</span>
<span class="co"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></code></pre></div>
<p>The functions below show the number of contacts initiating follow-up in the last day, based on the date of last contact ## new_contacts_today_row_title</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">new_contacts_today_row_title</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">todays_date</span>, <span class="va">report_format</span> <span class="op">=</span> <span class="st">"shiny"</span><span class="op">)</span><span class="op">{</span>
  
  <span class="va">formatted_date</span> <span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">format.Date</a></span><span class="op">(</span><span class="va">todays_date</span>,
                               format <span class="op">=</span> <span class="st">"%b %d, %Y"</span><span class="op">)</span>
  
  
  <span class="va">output_text</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"New contacts (starting follow-up on "</span>, <span class="va">formatted_date</span>, <span class="st">")"</span><span class="op">)</span>
  
  <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"pptx"</span>, <span class="st">"docx"</span>, <span class="st">"pdf"</span>, <span class="st">"html (page)"</span>, <span class="st">"html (slides)"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">output_text</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://rdrr.io/r/base/rawConversion.html">charToRaw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="http://xml2.r-lib.org/reference/read_xml.html">read_html</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://rvest.tidyverse.org/reference/html_text.html">html_text2</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu">str_trim</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu">pander</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pander/man/pandoc.header.return.html">pandoc.header</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>
    <span class="co"># no need to return anything. pandoc.p prints automatically</span>
  <span class="op">}</span>
  
  <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"shiny"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/htmltools/man/builder.html">h3</a></span><span class="op">(</span><span class="va">output_text</span>,
              style <span class="op">=</span> <span class="st">"display: inline;"</span><span class="op">)</span> <span class="op">)</span>
  <span class="op">}</span>
  
  
<span class="op">}</span></code></pre></div>
<div id="new_contacts_today_bar_chart" class="section level2">
<h2 class="hasAnchor">
<a href="#new_contacts_today_bar_chart" class="anchor"></a>new_contacts_today_bar_chart</h2>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">new_contacts_today_bar_chart</span> <span class="op">&lt;-</span> 
  <span class="kw">function</span><span class="op">(</span><span class="va">contacts_df_long</span>, <span class="va">todays_date</span>, <span class="va">report_format</span> <span class="op">=</span> <span class="st">"shiny"</span><span class="op">)</span><span class="op">{</span>
    
    <span class="va">contacts_df_long_filt</span> <span class="op">&lt;-</span> 
      <span class="va">contacts_df_long</span> <span class="op">%&gt;%</span> 
      <span class="co">## new contacts (first day of followup)</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">follow_up_day</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="co">## keep only those from today</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">follow_up_date</span> <span class="op">==</span> <span class="va">todays_date</span><span class="op">)</span>  
    
    
    <span class="va">contact_admin_1</span> <span class="op">&lt;-</span>
      <span class="va">contacts_df_long_filt</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">row_id</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="co"># slice long frame</span>
      <span class="fu">slice_head</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">admin_1</span>, <span class="va">admin_2</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu">add_count</span><span class="op">(</span><span class="va">admin_1</span>, name <span class="op">=</span> <span class="st">"n_admin_1"</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>pct_admin_1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fl">100</span> <span class="op">*</span> <span class="va">n_admin_1</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span>, 
                                 digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">admin_1</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>admin_2 <span class="op">=</span> <span class="fu">fct_lump</span><span class="op">(</span>other_level <span class="op">=</span> <span class="st">"Autres"</span>, 
                                <span class="va">admin_2</span>, prop <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu">add_count</span><span class="op">(</span><span class="va">admin_2</span>, name <span class="op">=</span> <span class="st">"n_admin_2"</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>pct_admin_2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fl">100</span> <span class="op">*</span> <span class="va">n_admin_2</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span>, 
                                 digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>data_label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">n_admin_2</span>, <span class="st">" ("</span>, <span class="va">pct_admin_2</span>, <span class="st">"%"</span>, <span class="st">")"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">admin_1</span>, <span class="va">admin_2</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu">slice_head</span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="op">-</span><span class="va">n_admin_1</span>, <span class="op">-</span><span class="va">n_admin_2</span><span class="op">)</span>
    
    
    <span class="va">color_df</span> <span class="op">&lt;-</span> 
      <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>admin_1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">contact_admin_1</span><span class="op">$</span><span class="va">admin_1</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">add_column</span><span class="op">(</span>color_lvl_1 <span class="op">=</span> <span class="va">highcharter_palette</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>
    
    
    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">contact_admin_1</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span>
      <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="http://jkunst.com/highcharter/reference/highchart.html">highchart</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_title.html">hc_title</a></span><span class="op">(</span>text  <span class="op">=</span> <span class="st">"No data to plot"</span><span class="op">)</span><span class="op">)</span>
    <span class="op">}</span>
    
    
    <span class="va">subtitle</span> <span class="op">&lt;-</span>  
      <span class="va">contact_admin_1</span> <span class="op">%&gt;%</span> 
      <span class="fu">left_join</span><span class="op">(</span><span class="va">color_df</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">admin_1</span>, <span class="va">pct_admin_1</span>, <span class="va">color_lvl_1</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>sep <span class="op">=</span> <span class="fu">case_when</span><span class="op">(</span><span class="fu">row_number</span><span class="op">(</span><span class="op">)</span> <span class="op">==</span> <span class="op">(</span><span class="fu">n</span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op">~</span> <span class="st">" and "</span>,
                             <span class="fu">row_number</span><span class="op">(</span><span class="op">)</span> <span class="op">==</span> <span class="fu">n</span><span class="op">(</span><span class="op">)</span> <span class="op">~</span> <span class="st">""</span>,
                             <span class="cn">TRUE</span> <span class="op">~</span> <span class="st">","</span><span class="op">)</span>
      <span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>txt <span class="op">=</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_glue.html">str_glue</a></span><span class="op">(</span><span class="st">"&lt;strong&gt;&lt;span style='background-color: {color_lvl_1};color:white'&gt;
                                      &amp;nbsp;{admin_1}&amp;nbsp;&lt;/span&gt;&lt;/strong&gt; ({pct_admin_1}% of contacts){sep}"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">txt</span>, collapse <span class="op">=</span> <span class="st">""</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">pull</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_c.html">str_c</a></span><span class="op">(</span><span class="st">"Level 1 divisions shown: "</span>, <span class="va">.</span><span class="op">)</span>
    
    
    
    <span class="va">output_highchart</span> <span class="op">&lt;-</span> 
      <span class="va">contact_admin_1</span> <span class="op">%&gt;%</span> 
      <span class="fu">left_join</span><span class="op">(</span><span class="va">color_df</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hchart.html">hchart</a></span><span class="op">(</span><span class="st">"bar"</span>, <span class="fu"><a href="http://jkunst.com/highcharter/reference/hcaes.html">hcaes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">admin_2</span> , y <span class="op">=</span> <span class="va">n_admin_2</span>, color <span class="op">=</span> <span class="va">color_lvl_1</span><span class="op">)</span>,
             size <span class="op">=</span> <span class="fl">4</span>,
             name <span class="op">=</span> <span class="st">"n"</span>,
             dataLabels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>enabled <span class="op">=</span> <span class="cn">TRUE</span>,
                               formatter <span class="op">=</span> <span class="fu"><a href="http://jkunst.com/highcharter/reference/highcharter-exports.html">JS</a></span><span class="op">(</span><span class="st">"function(){return(this.point.data_label)}"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_legend.html">hc_legend</a></span><span class="op">(</span>enabled <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_plotOptions.html">hc_plotOptions</a></span><span class="op">(</span>series <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>groupPadding <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_subtitle.html">hc_subtitle</a></span><span class="op">(</span>text <span class="op">=</span> <span class="va">subtitle</span>, useHTML <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_xAxis.html">hc_xAxis</a></span><span class="op">(</span>title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>text <span class="op">=</span> <span class="st">"Admin level 2"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_yAxis.html">hc_yAxis</a></span><span class="op">(</span>title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>text <span class="op">=</span> <span class="st">"Number of contacts"</span><span class="op">)</span><span class="op">)</span>
    
    
    
    <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"pptx"</span>, <span class="st">"docx"</span>, <span class="st">"pdf"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
      
      <span class="va">output_highchart</span> <span class="op">&lt;-</span>
        <span class="va">output_highchart</span> <span class="op">%&gt;%</span> 
        <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_exporting.html">hc_exporting</a></span><span class="op">(</span>enabled <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_plotOptions.html">hc_plotOptions</a></span><span class="op">(</span>series <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>animation <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
        <span class="fu">html_webshot</span><span class="op">(</span><span class="op">)</span>
      <span class="co"># no need to return anything. html_webshot prints automatically</span>
    <span class="op">}</span>
    
    <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"html (page)"</span>, <span class="st">"html (slides)"</span>, <span class="st">"shiny"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
      
      <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">output_highchart</span><span class="op">)</span>
      
    <span class="op">}</span>
    
    
  <span class="op">}</span></code></pre></div>
</div>
<div id="new_contacts_today_sunburst_plot" class="section level2">
<h2 class="hasAnchor">
<a href="#new_contacts_today_sunburst_plot" class="anchor"></a>new_contacts_today_sunburst_plot</h2>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">new_contacts_today_sunburst_plot</span> <span class="op">&lt;-</span> 
  <span class="kw">function</span><span class="op">(</span><span class="va">contacts_df_long</span>, <span class="va">todays_date</span>, <span class="va">report_format</span> <span class="op">=</span> <span class="st">"shiny"</span><span class="op">)</span><span class="op">{</span>
    
    <span class="va">contacts_df_long_filt</span> <span class="op">&lt;-</span> 
      <span class="va">contacts_df_long</span> <span class="op">%&gt;%</span> 
      <span class="co">## new contacts (first day of followup)</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">follow_up_day</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="co">## keep only those from today</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">follow_up_date</span> <span class="op">==</span> <span class="va">todays_date</span><span class="op">)</span>  
    
    <span class="va">contact_admin_1</span> <span class="op">&lt;-</span>
      <span class="va">contacts_df_long_filt</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">row_id</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="co"># slice long frame</span>
      <span class="fu">slice_head</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">admin_1</span>, <span class="va">admin_2</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu">add_count</span><span class="op">(</span><span class="va">admin_1</span>, name <span class="op">=</span> <span class="st">"n_admin_1"</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>pct_admin_1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fl">100</span> <span class="op">*</span> <span class="va">n_admin_1</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span>, 
                                 digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>admin_1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">admin_1</span>, 
                              <span class="st">" ("</span>, <span class="va">pct_admin_1</span>, <span class="st">"%"</span>, <span class="st">")"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">admin_1</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>admin_2 <span class="op">=</span> <span class="fu">fct_lump</span><span class="op">(</span>other_level <span class="op">=</span> <span class="st">"Autres"</span>, 
                                <span class="va">admin_2</span>, prop <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu">add_count</span><span class="op">(</span><span class="va">admin_2</span>, name <span class="op">=</span> <span class="st">"n_admin_2"</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>pct_admin_2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fl">100</span> <span class="op">*</span> <span class="va">n_admin_2</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span>, 
                                 digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>admin_2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">admin_2</span>, <span class="st">" ("</span>, <span class="va">pct_admin_2</span>, <span class="st">"%"</span>, <span class="st">")"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">admin_1</span>, <span class="va">admin_2</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu">slice_head</span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="op">-</span><span class="va">n_admin_1</span><span class="op">)</span>
    
    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">contact_admin_1</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span>
      <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="http://jkunst.com/highcharter/reference/highchart.html">highchart</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_title.html">hc_title</a></span><span class="op">(</span>text  <span class="op">=</span> <span class="st">"No data to plot"</span><span class="op">)</span><span class="op">)</span>
    <span class="op">}</span>
    
    <span class="va">color_df</span> <span class="op">&lt;-</span> 
      <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>admin_1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">contact_admin_1</span><span class="op">$</span><span class="va">admin_1</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">add_column</span><span class="op">(</span>color_lvl_1 <span class="op">=</span> <span class="va">highcharter_palette</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>
    
    <span class="va">contact_admin_1_list</span> <span class="op">&lt;-</span> 
      <span class="va">contact_admin_1</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/data_to_hierarchical.html">data_to_hierarchical</a></span><span class="op">(</span>group_vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">admin_1</span>, 
                                          <span class="va">admin_2</span><span class="op">)</span>, 
                           size_var <span class="op">=</span> <span class="va">n_admin_2</span>, 
                           colors<span class="op">=</span> <span class="va">color_df</span><span class="op">$</span><span class="va">color_lvl_1</span><span class="op">)</span>
    
    
    <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Type: "</span>, <span class="st">"n = "</span><span class="op">)</span>
    <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"{point.name}"</span>, <span class="st">"{point.value}"</span><span class="op">)</span>
    <span class="va">tltip</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://jkunst.com/highcharter/reference/tooltip_table.html">tooltip_table</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span>
    
    
    <span class="va">output_highchart</span> <span class="op">&lt;-</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/highchart.html">highchart</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_chart.html">hc_chart</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"sunburst"</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_add_series.html">hc_add_series</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">contact_admin_1_list</span>,
                    allowDrillToNode <span class="op">=</span> <span class="cn">TRUE</span>,
                    levelIsConstant <span class="op">=</span> <span class="cn">FALSE</span>,
                    <span class="co">#textOverflow = "clip",</span>
                    levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>level <span class="op">=</span> <span class="fl">1</span>,
                                       dataLabels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>enabled <span class="op">=</span> <span class="cn">TRUE</span>,
                                                         color <span class="op">=</span> <span class="st">"#FFFFFF"</span>,
                                                         style <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>textOverflow <span class="op">=</span> <span class="st">"clip"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, 
                                  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>level <span class="op">=</span> <span class="fl">2</span>, 
                                       dataLabels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>enabled <span class="op">=</span> <span class="cn">TRUE</span>, 
                                                         color <span class="op">=</span> <span class="st">"#FFFFFF"</span>,
                                                         style <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>textOverflow <span class="op">=</span> <span class="st">"clip"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, 
                                  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>level <span class="op">=</span> <span class="fl">3</span>,
                                       dataLabels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>enabled <span class="op">=</span> <span class="cn">TRUE</span>, 
                                                         color <span class="op">=</span> <span class="st">"#FFFFFF"</span>,
                                                         style <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>textOverflow <span class="op">=</span> <span class="st">"clip"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_plotOptions.html">hc_plotOptions</a></span><span class="op">(</span>sunburst <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>dataLabels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>enabled <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_tooltip.html">hc_tooltip</a></span><span class="op">(</span>useHTML <span class="op">=</span> <span class="cn">TRUE</span>, 
                 headerFormat <span class="op">=</span> <span class="st">""</span>, pointFormat <span class="op">=</span> <span class="va">tltip</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_exporting.html">hc_exporting</a></span><span class="op">(</span>enabled <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
    
    <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"pptx"</span>, <span class="st">"docx"</span>, <span class="st">"pdf"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
      
      <span class="va">output_highchart</span> <span class="op">&lt;-</span>
        <span class="va">output_highchart</span> <span class="op">%&gt;%</span> 
        <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_exporting.html">hc_exporting</a></span><span class="op">(</span>enabled <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_plotOptions.html">hc_plotOptions</a></span><span class="op">(</span>series <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>animation <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
        <span class="fu">html_webshot</span><span class="op">(</span><span class="op">)</span>
      <span class="co"># no need to return anything. html_webshot prints automatically</span>
    <span class="op">}</span>
    
    <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"html (page)"</span>, <span class="st">"html (slides)"</span>, <span class="st">"shiny"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
      
      <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">output_highchart</span><span class="op">)</span>
      
    <span class="op">}</span>
    
  <span class="op">}</span></code></pre></div>
</div>
<div id="new_contacts_today_table" class="section level2">
<h2 class="hasAnchor">
<a href="#new_contacts_today_table" class="anchor"></a>new_contacts_today_table</h2>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">new_contacts_today_table</span> <span class="op">&lt;-</span> 
  <span class="kw">function</span><span class="op">(</span><span class="va">contacts_df_long</span>, <span class="va">todays_date</span>, <span class="va">report_format</span> <span class="op">=</span> <span class="st">"shiny"</span><span class="op">)</span><span class="op">{</span>
    
    <span class="va">contacts_df_long_filt</span> <span class="op">&lt;-</span> 
      <span class="va">contacts_df_long</span> <span class="op">%&gt;%</span> 
      <span class="co">## new contacts (first day of followup)</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">follow_up_day</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="co">## keep only those from today</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">follow_up_date</span> <span class="op">==</span> <span class="va">todays_date</span><span class="op">)</span>  
    
    <span class="va">data_to_plot</span> <span class="op">&lt;-</span> 
      <span class="va">contacts_df_long_filt</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">row_id</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="co"># slice long frame</span>
      <span class="fu">slice_head</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">admin_1</span>, <span class="va">admin_2</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu">count</span><span class="op">(</span><span class="va">admin_1</span>, <span class="va">admin_2</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">admin_1</span>, <span class="va">admin_2</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>percent <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fl">100</span> <span class="op">*</span> <span class="va">n</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">admin_1</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>admin_1_sum <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>admin_1_percent <span class="op">=</span> <span class="va">admin_1_sum</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="op">-</span><span class="va">admin_1_percent</span>, <span class="op">-</span><span class="va">n</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span>`Admin level 1` <span class="op">=</span> <span class="va">admin_1</span>, 
             `Admin level 2` <span class="op">=</span> <span class="va">admin_2</span>, 
             `New contacts today` <span class="op">=</span> <span class="va">n</span>,
             `%` <span class="op">=</span> <span class="va">percent</span><span class="op">)</span>
    
    
    
    
    <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"shiny"</span>,<span class="st">"html (page)"</span>, <span class="st">"html (slides)"</span>, <span class="st">"pdf"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
      
      <span class="va">output_table</span> <span class="op">&lt;-</span>  
        <span class="va">data_to_plot</span> <span class="op">%&gt;%</span>
        <span class="fu"><a href="https://glin.github.io/reactable/reference/reactable.html">reactable</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>`New contacts today` <span class="op">=</span> <span class="fu"><a href="https://glin.github.io/reactable/reference/colDef.html">colDef</a></span><span class="op">(</span>cell <span class="op">=</span> <span class="fu"><a href="https://kcuilla.github.io/reactablefmtr/reference/data_bars_gradient.html">data_bars_gradient</a></span><span class="op">(</span><span class="va">data_to_plot</span>, 
                                                                                     colors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">peach</span>, <span class="va">bright_yellow_crayola</span><span class="op">)</span>,
                                                                                     background <span class="op">=</span> <span class="st">"transparent"</span><span class="op">)</span>,
                                                           style <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>fontFamily <span class="op">=</span> <span class="st">"Courier"</span>, whiteSpace <span class="op">=</span> <span class="st">"pre"</span>, fontSize <span class="op">=</span> <span class="fl">13</span><span class="op">)</span><span class="op">)</span>, 
                                 `Admin level 1` <span class="op">=</span> <span class="fu"><a href="https://glin.github.io/reactable/reference/colDef.html">colDef</a></span><span class="op">(</span>style <span class="op">=</span> <span class="fu"><a href="http://jkunst.com/highcharter/reference/highcharter-exports.html">JS</a></span><span class="op">(</span><span class="st">"function(rowInfo, colInfo, state) {
                                                          var firstSorted = state.sorted[0]
                                                          // Merge cells if unsorted or sorting by admin_1
                                                          if (!firstSorted || firstSorted.id === 'Admin level 1') {
                                                          var prevRow = state.pageRows[rowInfo.viewIndex - 1]
                                                          if (prevRow &amp;&amp; rowInfo.row['Admin level 1'] === prevRow['Admin level 1']) {
                                                          return { visibility: 'hidden' }
                                                          }
                                                          }}"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,
                  striped <span class="op">=</span> <span class="cn">TRUE</span>,
                  highlight <span class="op">=</span> <span class="cn">TRUE</span>,
                  defaultPageSize <span class="op">=</span> <span class="fl">15</span><span class="op">)</span>
    <span class="op">}</span>
    
    
    <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"pptx"</span>,<span class="st">"docx"</span>, <span class="st">"pdf"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
      
      <span class="va">output_table</span> <span class="op">&lt;-</span> 
        <span class="va">data_to_plot</span> <span class="op">%&gt;%</span> 
        <span class="fu">janitor</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/janitor/man/adorn_totals.html">adorn_totals</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
        <span class="fu"><a href="https://hughjonesd.github.io/huxtable/reference/huxtable.html">huxtable</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
        <span class="fu"><a href="https://hughjonesd.github.io/huxtable/reference/set-multiple.html">set_all_padding</a></span><span class="op">(</span><span class="fl">0.5</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu"><a href="https://hughjonesd.github.io/huxtable/reference/merge_repeated_rows.html">merge_repeated_rows</a></span><span class="op">(</span>col <span class="op">=</span> <span class="st">"Admin level 1"</span><span class="op">)</span> <span class="op">%&gt;%</span> 
        <span class="fu"><a href="https://hughjonesd.github.io/huxtable/reference/themes.html">theme_blue</a></span><span class="op">(</span><span class="op">)</span>
      
    <span class="op">}</span>
    
    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">output_table</span><span class="op">)</span>
    
    
  <span class="op">}</span></code></pre></div>
</div>
<div id="new_contacts_today_text" class="section level2">
<h2 class="hasAnchor">
<a href="#new_contacts_today_text" class="anchor"></a>new_contacts_today_text</h2>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">new_contacts_today_text</span> <span class="op">&lt;-</span> 
  <span class="kw">function</span><span class="op">(</span><span class="va">contacts_df_long</span>, <span class="va">todays_date</span>, <span class="va">report_format</span> <span class="op">=</span> <span class="st">"shiny"</span><span class="op">)</span><span class="op">{</span>
    
    <span class="va">contacts_df_long_filt</span> <span class="op">&lt;-</span> 
      <span class="va">contacts_df_long</span> <span class="op">%&gt;%</span> 
      <span class="co">## new contacts (first day of followup)</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">follow_up_day</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="co">## keep only those from today</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">follow_up_date</span> <span class="op">==</span> <span class="va">todays_date</span><span class="op">)</span>  
    

    <span class="va">data_to_plot</span> <span class="op">&lt;-</span> 
      <span class="va">contacts_df_long_filt</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">row_id</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="co"># slice long frame</span>
      <span class="fu">slice_head</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">admin_1</span>, <span class="va">admin_2</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu">count</span><span class="op">(</span><span class="va">admin_1</span>, <span class="va">admin_2</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">admin_1</span>, <span class="va">admin_2</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>percent <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fl">100</span> <span class="op">*</span> <span class="va">n</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">admin_1</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>admin_1_sum <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>admin_1_percent <span class="op">=</span> <span class="va">admin_1_sum</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">admin_1</span>, 
             <span class="va">admin_1_sum</span>,
             <span class="va">admin_1_percent</span>,
             <span class="va">admin_2</span>, 
             admin_2_sum <span class="op">=</span> <span class="va">n</span>,
             admin_2_percent <span class="op">=</span> <span class="va">percent</span><span class="op">)</span>
    
    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data_to_plot</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span>
      <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">" "</span><span class="op">)</span> <span class="op">)</span>
    <span class="op">}</span>
    
    
    <span class="va">admin_1_w_most_contacts</span> <span class="op">&lt;-</span> 
      <span class="va">data_to_plot</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="op">-</span><span class="va">admin_1_percent</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="va">.</span><span class="op">$</span><span class="va">admin_1</span> <span class="op">%&gt;%</span> <span class="va">.</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>
    
    <span class="va">n_contacts_in_admin_1_w_most_contacts</span> <span class="op">&lt;-</span> 
      <span class="va">data_to_plot</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="op">-</span><span class="va">admin_1_percent</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="va">.</span><span class="op">$</span><span class="va">admin_1_sum</span> <span class="op">%&gt;%</span> <span class="va">.</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>
    
    <span class="va">pct_contacts_in_admin_1_w_most_contacts</span> <span class="op">&lt;-</span> 
      <span class="va">data_to_plot</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="op">-</span><span class="va">admin_1_percent</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="va">.</span><span class="op">$</span><span class="va">admin_1_percent</span> <span class="op">%&gt;%</span> <span class="va">.</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">%&gt;%</span> 
      <span class="fu">magrittr</span><span class="fu">::</span><span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">multiply_by</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">.</span>, <span class="st">"%"</span><span class="op">)</span>
    
    
    <span class="va">info</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"&lt;br&gt;
            &lt;span style='color: rgb(97, 189, 109);'&gt;ℹ:&lt;/span&gt;
            &lt;font size='1'&gt;The table and plots show the count of the new contacts (contacts commencing follow-up)
            on the selected date of review. Follow-up begins the day after the last interaction with a confirmed or suspected case &lt;/font&gt;"</span><span class="op">)</span>
    
    <span class="va">str1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op">(</span><span class="st">"&lt;br&gt;The level 1 division with the most new contacts in the past day is &lt;b&gt; {admin_1_w_most_contacts}&lt;/b&gt;, 
                 with &lt;b&gt;{n_contacts_in_admin_1_w_most_contacts}&lt;/b&gt; contacts (&lt;b&gt;{pct_contacts_in_admin_1_w_most_contacts}&lt;/b&gt; of the total)"</span> <span class="op">)</span>
    
    <span class="va">output_text</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/htmltools/man/HTML.html">HTML</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">info</span>, <span class="va">str1</span>, sep <span class="op">=</span> <span class="st">'&lt;br/&gt;'</span><span class="op">)</span><span class="op">)</span>
    
    
    <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"pptx"</span>, <span class="st">"docx"</span>, <span class="st">"pdf"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
      <span class="va">output_text</span> <span class="op">%&gt;%</span>
        <span class="fu"><a href="https://rdrr.io/r/base/rawConversion.html">charToRaw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu"><a href="http://xml2.r-lib.org/reference/read_xml.html">read_html</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu"><a href="https://rvest.tidyverse.org/reference/html_text.html">html_text2</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu">str_trim</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu">pander</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pander/man/pandoc.p.return.html">pandoc.p</a></span><span class="op">(</span><span class="op">)</span>
      <span class="co"># no need to return anything. pandoc.p prints automatically</span>
    <span class="op">}</span>
    
    <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"shiny"</span>, <span class="st">"html (page)"</span>, <span class="st">"html (slides)"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
      <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">output_text</span><span class="op">)</span>
    <span class="op">}</span>
    
    
  <span class="op">}</span></code></pre></div>
</div>
</div>
<div id="new_contacts_historical" class="section level1">
<h1 class="hasAnchor">
<a href="#new_contacts_historical" class="anchor"></a>new_contacts_historical</h1>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<span class="co"># ~ new_contacts_historical-----------</span>
<span class="co"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></code></pre></div>
<p>Functions showing how the number of new contacts (contacts initiating follow-up on the given day) ## new_contacts_historical_row_title</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">new_contacts_historical_row_title</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">report_format</span> <span class="op">=</span> <span class="st">"shiny"</span><span class="op">)</span><span class="op">{</span>
  <span class="co">## doesn't need to a function at the moment. </span>
  <span class="co">## But we leave it there in case we want to take in an input or two</span>
  
  
  <span class="va">output_text</span> <span class="op">&lt;-</span> <span class="st">"New contacts, trend over time"</span>
  
  <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"pptx"</span>, <span class="st">"docx"</span>, <span class="st">"pdf"</span>, <span class="st">"html (page)"</span>, <span class="st">"html (slides)"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">output_text</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://rdrr.io/r/base/rawConversion.html">charToRaw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="http://xml2.r-lib.org/reference/read_xml.html">read_html</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://rvest.tidyverse.org/reference/html_text.html">html_text2</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu">str_trim</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu">pander</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pander/man/pandoc.header.return.html">pandoc.header</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>
    <span class="co"># no need to return anything. pandoc.p prints automatically</span>
  <span class="op">}</span>
  
  <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"shiny"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/htmltools/man/builder.html">h3</a></span><span class="op">(</span><span class="va">output_text</span>,
              style <span class="op">=</span> <span class="st">"display: inline;"</span><span class="op">)</span> <span class="op">)</span>
  <span class="op">}</span>
  
<span class="op">}</span></code></pre></div>
<div id="new_contacts_historical_bar_chart" class="section level2">
<h2 class="hasAnchor">
<a href="#new_contacts_historical_bar_chart" class="anchor"></a>new_contacts_historical_bar_chart</h2>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">new_contacts_historical_bar_chart</span> <span class="op">&lt;-</span> 
  <span class="kw">function</span><span class="op">(</span><span class="va">contacts_df_long</span>, <span class="va">todays_date</span>, <span class="va">report_format</span> <span class="op">=</span> <span class="st">"shiny"</span><span class="op">)</span><span class="op">{</span>
    
    <span class="va">contacts_df_long_filt</span> <span class="op">&lt;-</span> 
      <span class="va">contacts_df_long</span> <span class="op">%&gt;%</span> 
      <span class="co">## filter out dates that are past the input days date ("future follow-up" rows)</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">follow_up_date</span> <span class="op">&lt;=</span> <span class="va">todays_date</span><span class="op">)</span> <span class="op">%&gt;%</span>    
      <span class="co">## new contacts (first day of followup)</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">follow_up_day</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span>
      
    
    <span class="va">data_to_plot</span> <span class="op">&lt;-</span> 
      <span class="va">contacts_df_long_filt</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">admin_1</span>, <span class="va">follow_up_date</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">follow_up_date</span>, <span class="va">admin_1</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">count</span><span class="op">(</span><span class="va">admin_1</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">admin_1</span>, <span class="va">follow_up_date</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">bind_rows</span><span class="op">(</span><span class="fu">tibble</span><span class="op">(</span>follow_up_date <span class="op">=</span>  <span class="fu"><a href="https://rdrr.io/r/base/seq.Date.html">seq.Date</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">.</span><span class="op">$</span><span class="va">follow_up_date</span><span class="op">)</span>, 
                                                  to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">.</span><span class="op">$</span><span class="va">follow_up_date</span><span class="op">)</span>, 
                                                  by <span class="op">=</span> <span class="st">"day"</span><span class="op">)</span>, 
                       admin_1 <span class="op">=</span> <span class="st">"temporary"</span>
      <span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">complete</span><span class="op">(</span><span class="va">follow_up_date</span>, <span class="va">admin_1</span>, fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">admin_1</span> <span class="op">!=</span> <span class="st">"temporary"</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="co"># admin_1 with the most cases should be at the top</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">admin_1</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>total <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>admin_1 <span class="op">=</span> <span class="fu">fct_rev</span><span class="op">(</span><span class="fu">fct_reorder</span><span class="op">(</span><span class="va">admin_1</span>, <span class="va">total</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
    
    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data_to_plot</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span>
      <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="http://jkunst.com/highcharter/reference/highchart.html">highchart</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_title.html">hc_title</a></span><span class="op">(</span>text  <span class="op">=</span> <span class="st">"No data to plot"</span><span class="op">)</span><span class="op">)</span>
    <span class="op">}</span>
    
    <span class="va">output_highchart</span> <span class="op">&lt;-</span> 
      <span class="va">data_to_plot</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hchart.html">hchart</a></span><span class="op">(</span><span class="st">"column"</span>, <span class="fu"><a href="http://jkunst.com/highcharter/reference/hcaes.html">hcaes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">follow_up_date</span>, y <span class="op">=</span> <span class="va">n</span>, group <span class="op">=</span> <span class="va">admin_1</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_yAxis.html">hc_yAxis</a></span><span class="op">(</span>visible <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_plotOptions.html">hc_plotOptions</a></span><span class="op">(</span>column <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>stacking <span class="op">=</span> <span class="st">"normal"</span>, 
                                   pointPadding <span class="op">=</span> <span class="fl">0</span>, 
                                   groupPadding <span class="op">=</span> <span class="fl">0</span>, 
                                   borderWidth<span class="op">=</span> <span class="fl">0.05</span>,
                                   stickyTracking <span class="op">=</span> <span class="cn">T</span>
      <span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_plotOptions.html">hc_plotOptions</a></span><span class="op">(</span>column <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>states <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>inactive <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>opacity <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_xAxis.html">hc_xAxis</a></span><span class="op">(</span>title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>text <span class="op">=</span> <span class="st">"Date"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_yAxis.html">hc_yAxis</a></span><span class="op">(</span>title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>text <span class="op">=</span> <span class="st">"No of new contacts beginning follow-up"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_exporting.html">hc_exporting</a></span><span class="op">(</span>enabled <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
    
    
    <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"pptx"</span>, <span class="st">"docx"</span>, <span class="st">"pdf"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
      
      <span class="va">output_highchart</span> <span class="op">&lt;-</span>
        <span class="va">output_highchart</span> <span class="op">%&gt;%</span> 
        <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_exporting.html">hc_exporting</a></span><span class="op">(</span>enabled <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_plotOptions.html">hc_plotOptions</a></span><span class="op">(</span>series <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>animation <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
        <span class="fu">html_webshot</span><span class="op">(</span><span class="op">)</span>
      <span class="co"># no need to return anything. html_webshot prints automatically</span>
    <span class="op">}</span>
    
    <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"html (page)"</span>, <span class="st">"html (slides)"</span>, <span class="st">"shiny"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
      
      <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">output_highchart</span><span class="op">)</span>
      
    <span class="op">}</span>
    
  <span class="op">}</span></code></pre></div>
</div>
<div id="new_contacts_historical_bar_chart_relative" class="section level2">
<h2 class="hasAnchor">
<a href="#new_contacts_historical_bar_chart_relative" class="anchor"></a>new_contacts_historical_bar_chart_relative</h2>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">new_contacts_historical_bar_chart_relative</span> <span class="op">&lt;-</span> 
  <span class="kw">function</span><span class="op">(</span><span class="va">contacts_df_long</span>, <span class="va">todays_date</span>, <span class="va">report_format</span> <span class="op">=</span> <span class="st">"shiny"</span><span class="op">)</span><span class="op">{</span>
    
    <span class="va">contacts_df_long_filt</span> <span class="op">&lt;-</span> 
      <span class="va">contacts_df_long</span> <span class="op">%&gt;%</span> 
            <span class="co">## filter out dates that are past the input days date ("future follow-up" rows)</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">follow_up_date</span> <span class="op">&lt;=</span> <span class="va">todays_date</span><span class="op">)</span> <span class="op">%&gt;%</span>    
      <span class="co">## new contacts (first day of followup)</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">follow_up_day</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span>
    
    
    <span class="va">data_to_plot</span> <span class="op">&lt;-</span> 
      <span class="va">contacts_df_long_filt</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">admin_1</span>, <span class="va">follow_up_date</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">follow_up_date</span>, <span class="va">admin_1</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">count</span><span class="op">(</span><span class="va">admin_1</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">follow_up_date</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>prop <span class="op">=</span> <span class="va">n</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>prop <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">prop</span>, digits <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">admin_1</span>, <span class="va">follow_up_date</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">bind_rows</span><span class="op">(</span><span class="fu">tibble</span><span class="op">(</span>follow_up_date <span class="op">=</span>  <span class="fu"><a href="https://rdrr.io/r/base/seq.Date.html">seq.Date</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">.</span><span class="op">$</span><span class="va">follow_up_date</span><span class="op">)</span>, 
                                                  to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">.</span><span class="op">$</span><span class="va">follow_up_date</span><span class="op">)</span>, 
                                                  by <span class="op">=</span> <span class="st">"day"</span><span class="op">)</span>, 
                       admin_1 <span class="op">=</span> <span class="st">"temporary"</span>
      <span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">complete</span><span class="op">(</span><span class="va">follow_up_date</span>, <span class="va">admin_1</span>, fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">0</span>, prop <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">admin_1</span> <span class="op">!=</span> <span class="st">"temporary"</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="co"># admin_1 with the most cases should be at the top</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">admin_1</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>total <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>admin_1 <span class="op">=</span> <span class="fu">fct_rev</span><span class="op">(</span><span class="fu">fct_reorder</span><span class="op">(</span><span class="va">admin_1</span>, <span class="va">total</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
    
    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data_to_plot</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span>
      <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="http://jkunst.com/highcharter/reference/highchart.html">highchart</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_title.html">hc_title</a></span><span class="op">(</span>text  <span class="op">=</span> <span class="st">"No data to plot"</span><span class="op">)</span><span class="op">)</span>
    <span class="op">}</span>
    
    <span class="va">output_highchart</span> <span class="op">&lt;-</span> 
      <span class="va">data_to_plot</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hchart.html">hchart</a></span><span class="op">(</span><span class="st">"column"</span>, <span class="fu"><a href="http://jkunst.com/highcharter/reference/hcaes.html">hcaes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">follow_up_date</span>, y <span class="op">=</span> <span class="va">prop</span>, group <span class="op">=</span> <span class="va">admin_1</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_yAxis.html">hc_yAxis</a></span><span class="op">(</span>visible <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_plotOptions.html">hc_plotOptions</a></span><span class="op">(</span>column <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>stacking <span class="op">=</span> <span class="st">"normal"</span>, 
                                   pointPadding <span class="op">=</span> <span class="fl">0</span>, 
                                   groupPadding <span class="op">=</span> <span class="fl">0</span>, 
                                   borderWidth<span class="op">=</span> <span class="fl">0.05</span>,
                                   stickyTracking <span class="op">=</span> <span class="cn">T</span>
      <span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_plotOptions.html">hc_plotOptions</a></span><span class="op">(</span>column <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>states <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>inactive <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>opacity <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_xAxis.html">hc_xAxis</a></span><span class="op">(</span>title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>text <span class="op">=</span> <span class="st">"Date"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_yAxis.html">hc_yAxis</a></span><span class="op">(</span>title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>text <span class="op">=</span> <span class="st">"New contacts beginning follow-up, normalized to 1"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_exporting.html">hc_exporting</a></span><span class="op">(</span>enabled <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
    
    
    <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"pptx"</span>, <span class="st">"docx"</span>, <span class="st">"pdf"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
      
      <span class="va">output_highchart</span> <span class="op">&lt;-</span>
        <span class="va">output_highchart</span> <span class="op">%&gt;%</span> 
        <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_exporting.html">hc_exporting</a></span><span class="op">(</span>enabled <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_plotOptions.html">hc_plotOptions</a></span><span class="op">(</span>series <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>animation <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
        <span class="fu">html_webshot</span><span class="op">(</span><span class="op">)</span>
      <span class="co"># no need to return anything. html_webshot prints automatically</span>
    <span class="op">}</span>
    
    <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"html (page)"</span>, <span class="st">"html (slides)"</span>, <span class="st">"shiny"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
      
      <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">output_highchart</span><span class="op">)</span>
      
    <span class="op">}</span>
    
  <span class="op">}</span></code></pre></div>
</div>
<div id="new_contacts_historical_text" class="section level2">
<h2 class="hasAnchor">
<a href="#new_contacts_historical_text" class="anchor"></a>new_contacts_historical_text</h2>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">new_contacts_historical_text</span> <span class="op">&lt;-</span> 
  <span class="kw">function</span><span class="op">(</span><span class="va">contacts_df_long</span>, <span class="va">todays_date</span>, <span class="va">report_format</span> <span class="op">=</span> <span class="st">"shiny"</span><span class="op">)</span><span class="op">{</span>
    
    <span class="va">contacts_df_long_filt</span> <span class="op">&lt;-</span> 
      <span class="va">contacts_df_long</span> <span class="op">%&gt;%</span> 
            <span class="co">## filter out dates that are past the input days date ("future follow-up" rows)</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">follow_up_date</span> <span class="op">&lt;=</span> <span class="va">todays_date</span><span class="op">)</span> <span class="op">%&gt;%</span>    
      <span class="co">## new contacts (first day of followup)</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">follow_up_day</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span>
    
    
    <span class="va">data_to_plot</span> <span class="op">&lt;-</span> 
      <span class="va">contacts_df_long_filt</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">admin_1</span>, <span class="va">follow_up_date</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">follow_up_date</span>, <span class="va">admin_1</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">count</span><span class="op">(</span><span class="va">admin_1</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">admin_1</span>, <span class="va">follow_up_date</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">bind_rows</span><span class="op">(</span><span class="fu">tibble</span><span class="op">(</span>follow_up_date <span class="op">=</span>  <span class="fu"><a href="https://rdrr.io/r/base/seq.Date.html">seq.Date</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">.</span><span class="op">$</span><span class="va">follow_up_date</span><span class="op">)</span>, 
                                                  to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">.</span><span class="op">$</span><span class="va">follow_up_date</span><span class="op">)</span>, 
                                                  by <span class="op">=</span> <span class="st">"day"</span><span class="op">)</span>, 
                       admin_1 <span class="op">=</span> <span class="st">"temporary"</span>
      <span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">complete</span><span class="op">(</span><span class="va">follow_up_date</span>, <span class="va">admin_1</span>, fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">admin_1</span> <span class="op">!=</span> <span class="st">"temporary"</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="co"># admin_1 with the most cases should be at the top</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">admin_1</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>total <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>admin_1 <span class="op">=</span> <span class="fu">fct_rev</span><span class="op">(</span><span class="fu">fct_reorder</span><span class="op">(</span><span class="va">admin_1</span>, <span class="va">total</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
    
    
    <span class="va">max_n_new_contacts</span> <span class="op">&lt;-</span> 
      <span class="va">data_to_plot</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">follow_up_date</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>total_that_day <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">slice_head</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="op">-</span><span class="va">total_that_day</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="va">.</span><span class="op">$</span><span class="va">total_that_day</span> <span class="op">%&gt;%</span> 
      <span class="va">.</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>
    
    <span class="va">date_of_max_n_new_contacts</span> <span class="op">&lt;-</span> 
      <span class="va">data_to_plot</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">follow_up_date</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>total_that_day <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">slice_head</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="op">-</span><span class="va">total_that_day</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="va">.</span><span class="op">$</span><span class="va">follow_up_date</span> <span class="op">%&gt;%</span> 
      <span class="va">.</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>  <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">format.Date</a></span><span class="op">(</span><span class="st">"%b %d, %Y"</span><span class="op">)</span>
    
    
    
    <span class="va">info</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"&lt;br&gt;
            &lt;span style='color: rgb(97, 189, 109);'&gt;ℹ:&lt;/span&gt;
            &lt;font size='1'&gt;
            The plots show the number of new contacts on each day, that is, the number of contacts on their first day of follow-up.
            &lt;/font&gt;"</span><span class="op">)</span>
    <span class="va">str1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op">(</span><span class="st">"&lt;br&gt;The day on which the highest number of new contacts commenced follow-up was &lt;b&gt;{date_of_max_n_new_contacts}&lt;/b&gt;, 
                 with &lt;b&gt;{max_n_new_contacts}&lt;/b&gt; contacts that day."</span> <span class="op">)</span>
    
    <span class="va">output_text</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/htmltools/man/HTML.html">HTML</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">info</span>, <span class="va">str1</span>, sep <span class="op">=</span> <span class="st">'&lt;br/&gt;'</span><span class="op">)</span><span class="op">)</span>
    
    <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"pptx"</span>,<span class="st">"docx"</span>, <span class="st">"pdf"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
      
      <span class="va">output_text</span> <span class="op">&lt;-</span> 
        <span class="va">output_text</span> <span class="op">%&gt;%</span> 
        <span class="fu"><a href="https://rdrr.io/r/base/rawConversion.html">charToRaw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
        <span class="fu"><a href="http://xml2.r-lib.org/reference/read_xml.html">read_html</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
        <span class="fu"><a href="https://rvest.tidyverse.org/reference/html_text.html">html_text2</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
        <span class="fu">str_trim</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
        <span class="fu">pander</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pander/man/pandoc.p.return.html">pandoc.p</a></span><span class="op">(</span><span class="op">)</span>
      <span class="co"># no need to return anything. pandoc.p prints automatically</span>
    <span class="op">}</span>
    
    <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"shiny"</span>, <span class="st">"html (page)"</span>, <span class="st">"html (slides)"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
      <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">output_text</span><span class="op">)</span>
    <span class="op">}</span>
    
    
  <span class="op">}</span></code></pre></div>
</div>
</div>
<div id="cumul_contacts_today" class="section level1">
<h1 class="hasAnchor">
<a href="#cumul_contacts_today" class="anchor"></a>cumul_contacts_today</h1>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<span class="co"># ~ cumul_contacts_today  --------------------</span>
<span class="co"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></code></pre></div>
<p>Below we call the contacts_per_admin_1 functions. These show the distribution of contacts over admin level 1 and admin level 2. ## cumul_contacts_today_row_title</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cumul_contacts_today_row_title</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">todays_date</span>, <span class="va">report_format</span> <span class="op">=</span> <span class="st">"shiny"</span><span class="op">)</span><span class="op">{</span>

  <span class="va">formatted_date</span> <span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">format.Date</a></span><span class="op">(</span><span class="va">todays_date</span>,
                               format <span class="op">=</span> <span class="st">"%b %d, %Y"</span><span class="op">)</span>
  
  <span class="va">output_text</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Total/cumulative contacts (as at "</span>, <span class="va">formatted_date</span>, <span class="st">")"</span><span class="op">)</span>
  
  <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"pptx"</span>, <span class="st">"docx"</span>, <span class="st">"pdf"</span>, <span class="st">"html (page)"</span>, <span class="st">"html (slides)"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">output_text</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://rdrr.io/r/base/rawConversion.html">charToRaw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="http://xml2.r-lib.org/reference/read_xml.html">read_html</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://rvest.tidyverse.org/reference/html_text.html">html_text2</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu">str_trim</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu">pander</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pander/man/pandoc.header.return.html">pandoc.header</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>
    <span class="co"># no need to return anything. pandoc.p prints automatically</span>
  <span class="op">}</span>
  
  <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"shiny"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/htmltools/man/builder.html">h3</a></span><span class="op">(</span><span class="va">output_text</span>,
              style <span class="op">=</span> <span class="st">"display: inline;"</span><span class="op">)</span> <span class="op">)</span>
  <span class="op">}</span>
   
<span class="op">}</span></code></pre></div>
<div id="cumul_contacts_today_bar_chart" class="section level2">
<h2 class="hasAnchor">
<a href="#cumul_contacts_today_bar_chart" class="anchor"></a>cumul_contacts_today_bar_chart</h2>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cumul_contacts_today_bar_chart</span> <span class="op">&lt;-</span> 
  <span class="kw">function</span><span class="op">(</span><span class="va">contacts_df_long</span>, <span class="va">report_format</span> <span class="op">=</span> <span class="st">"shiny"</span><span class="op">)</span><span class="op">{</span>
    
    
    <span class="va">contact_admin_1</span> <span class="op">&lt;-</span>
      <span class="va">contacts_df_long</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">row_id</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="co"># slice long frame</span>
      <span class="fu">slice_head</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">admin_1</span>, <span class="va">admin_2</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu">add_count</span><span class="op">(</span><span class="va">admin_1</span>, name <span class="op">=</span> <span class="st">"n_admin_1"</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>pct_admin_1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fl">100</span> <span class="op">*</span> <span class="va">n_admin_1</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span>, 
                                 digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">admin_1</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>admin_2 <span class="op">=</span> <span class="fu">fct_lump</span><span class="op">(</span>other_level <span class="op">=</span> <span class="st">"Autres"</span>, 
                                <span class="va">admin_2</span>, prop <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu">add_count</span><span class="op">(</span><span class="va">admin_2</span>, name <span class="op">=</span> <span class="st">"n_admin_2"</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>pct_admin_2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fl">100</span> <span class="op">*</span> <span class="va">n_admin_2</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span>, 
                                 digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>data_label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">n_admin_2</span>, <span class="st">" ("</span>, <span class="va">pct_admin_2</span>, <span class="st">"%"</span>, <span class="st">")"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">admin_1</span>, <span class="va">admin_2</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu">slice_head</span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="op">-</span><span class="va">n_admin_1</span>, <span class="op">-</span><span class="va">n_admin_2</span><span class="op">)</span>
    
    
    <span class="va">color_df</span> <span class="op">&lt;-</span> 
      <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>admin_1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">contact_admin_1</span><span class="op">$</span><span class="va">admin_1</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">add_column</span><span class="op">(</span>color_lvl_1 <span class="op">=</span> <span class="va">highcharter_palette</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>
    
    
    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">contact_admin_1</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span>
      <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="http://jkunst.com/highcharter/reference/highchart.html">highchart</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_title.html">hc_title</a></span><span class="op">(</span>text  <span class="op">=</span> <span class="st">"No data to plot"</span><span class="op">)</span><span class="op">)</span>
    <span class="op">}</span>
    
    
    <span class="va">subtitle</span> <span class="op">&lt;-</span>  
      <span class="va">contact_admin_1</span> <span class="op">%&gt;%</span> 
      <span class="fu">left_join</span><span class="op">(</span><span class="va">color_df</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">admin_1</span>, <span class="va">pct_admin_1</span>, <span class="va">color_lvl_1</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>sep <span class="op">=</span> <span class="fu">case_when</span><span class="op">(</span><span class="fu">row_number</span><span class="op">(</span><span class="op">)</span> <span class="op">==</span> <span class="op">(</span><span class="fu">n</span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op">~</span> <span class="st">" and "</span>,
                             <span class="fu">row_number</span><span class="op">(</span><span class="op">)</span> <span class="op">==</span> <span class="fu">n</span><span class="op">(</span><span class="op">)</span> <span class="op">~</span> <span class="st">""</span>,
                             <span class="cn">TRUE</span> <span class="op">~</span> <span class="st">","</span><span class="op">)</span>
      <span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>txt <span class="op">=</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_glue.html">str_glue</a></span><span class="op">(</span><span class="st">"&lt;strong&gt;&lt;span style='background-color: {color_lvl_1};color:white'&gt;
                                      &amp;nbsp;{admin_1}&amp;nbsp;&lt;/span&gt;&lt;/strong&gt; ({pct_admin_1}% of contacts){sep}"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">txt</span>, collapse <span class="op">=</span> <span class="st">""</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">pull</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_c.html">str_c</a></span><span class="op">(</span><span class="st">"Level 1 divisions shown: "</span>, <span class="va">.</span><span class="op">)</span>
    
    
    
    <span class="va">output_highchart</span> <span class="op">&lt;-</span> 
      <span class="va">contact_admin_1</span> <span class="op">%&gt;%</span> 
      <span class="fu">left_join</span><span class="op">(</span><span class="va">color_df</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hchart.html">hchart</a></span><span class="op">(</span><span class="st">"bar"</span>, <span class="fu"><a href="http://jkunst.com/highcharter/reference/hcaes.html">hcaes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">admin_2</span> , y <span class="op">=</span> <span class="va">n_admin_2</span>, color <span class="op">=</span> <span class="va">color_lvl_1</span><span class="op">)</span>,
             size <span class="op">=</span> <span class="fl">4</span>,
             name <span class="op">=</span> <span class="st">"n"</span>,
             dataLabels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>enabled <span class="op">=</span> <span class="cn">TRUE</span>,
                               formatter <span class="op">=</span> <span class="fu"><a href="http://jkunst.com/highcharter/reference/highcharter-exports.html">JS</a></span><span class="op">(</span><span class="st">"function(){return(this.point.data_label)}"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_legend.html">hc_legend</a></span><span class="op">(</span>enabled <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_plotOptions.html">hc_plotOptions</a></span><span class="op">(</span>series <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>groupPadding <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_subtitle.html">hc_subtitle</a></span><span class="op">(</span>text <span class="op">=</span> <span class="va">subtitle</span>, useHTML <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_xAxis.html">hc_xAxis</a></span><span class="op">(</span>title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>text <span class="op">=</span> <span class="st">"Admin level 2"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_yAxis.html">hc_yAxis</a></span><span class="op">(</span>title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>text <span class="op">=</span> <span class="st">"Number of contacts"</span><span class="op">)</span><span class="op">)</span>
    
    
    
    <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"pptx"</span>, <span class="st">"docx"</span>, <span class="st">"pdf"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
      
      <span class="va">output_highchart</span> <span class="op">&lt;-</span>
        <span class="va">output_highchart</span> <span class="op">%&gt;%</span> 
        <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_exporting.html">hc_exporting</a></span><span class="op">(</span>enabled <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_plotOptions.html">hc_plotOptions</a></span><span class="op">(</span>series <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>animation <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
        <span class="fu">html_webshot</span><span class="op">(</span><span class="op">)</span>
      <span class="co"># no need to return anything. html_webshot prints automatically</span>
    <span class="op">}</span>
    
    <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"html (page)"</span>, <span class="st">"html (slides)"</span>, <span class="st">"shiny"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
      
      <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">output_highchart</span><span class="op">)</span>
      
    <span class="op">}</span>
    
    
  <span class="op">}</span></code></pre></div>
</div>
<div id="cumul_contacts_today_sunburst_plot" class="section level2">
<h2 class="hasAnchor">
<a href="#cumul_contacts_today_sunburst_plot" class="anchor"></a>cumul_contacts_today_sunburst_plot</h2>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cumul_contacts_today_sunburst_plot</span> <span class="op">&lt;-</span> 
  <span class="kw">function</span><span class="op">(</span><span class="va">contacts_df_long</span>, <span class="va">report_format</span> <span class="op">=</span> <span class="st">"shiny"</span><span class="op">)</span><span class="op">{</span>
    
    
    <span class="va">contact_admin_1</span> <span class="op">&lt;-</span>
      <span class="va">contacts_df_long</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">row_id</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="co"># slice long frame</span>
      <span class="fu">slice_head</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">admin_1</span>, <span class="va">admin_2</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu">add_count</span><span class="op">(</span><span class="va">admin_1</span>, name <span class="op">=</span> <span class="st">"n_admin_1"</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>pct_admin_1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fl">100</span> <span class="op">*</span> <span class="va">n_admin_1</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span>, 
                                 digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>admin_1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">admin_1</span>, 
                              <span class="st">" ("</span>, <span class="va">pct_admin_1</span>, <span class="st">"%"</span>, <span class="st">")"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">admin_1</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>admin_2 <span class="op">=</span> <span class="fu">fct_lump</span><span class="op">(</span>other_level <span class="op">=</span> <span class="st">"Autres"</span>, 
                                <span class="va">admin_2</span>, prop <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu">add_count</span><span class="op">(</span><span class="va">admin_2</span>, name <span class="op">=</span> <span class="st">"n_admin_2"</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>pct_admin_2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fl">100</span> <span class="op">*</span> <span class="va">n_admin_2</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span>, 
                                 digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>admin_2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">admin_2</span>, <span class="st">" ("</span>, <span class="va">pct_admin_2</span>, <span class="st">"%"</span>, <span class="st">")"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">admin_1</span>, <span class="va">admin_2</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu">slice_head</span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="op">-</span><span class="va">n_admin_1</span><span class="op">)</span>
    
    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">contact_admin_1</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span>
      <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="http://jkunst.com/highcharter/reference/highchart.html">highchart</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_title.html">hc_title</a></span><span class="op">(</span>text  <span class="op">=</span> <span class="st">"No data to plot"</span><span class="op">)</span><span class="op">)</span>
    <span class="op">}</span>
    
    <span class="va">color_df</span> <span class="op">&lt;-</span> 
      <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>admin_1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">contact_admin_1</span><span class="op">$</span><span class="va">admin_1</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">add_column</span><span class="op">(</span>color_lvl_1 <span class="op">=</span> <span class="va">highcharter_palette</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>
    
    <span class="va">contact_admin_1_list</span> <span class="op">&lt;-</span> 
      <span class="va">contact_admin_1</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/data_to_hierarchical.html">data_to_hierarchical</a></span><span class="op">(</span>group_vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">admin_1</span>, 
                                          <span class="va">admin_2</span><span class="op">)</span>, 
                           size_var <span class="op">=</span> <span class="va">n_admin_2</span>, 
                           colors<span class="op">=</span> <span class="va">color_df</span><span class="op">$</span><span class="va">color_lvl_1</span><span class="op">)</span>
    
    
    <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Type: "</span>, <span class="st">"n = "</span><span class="op">)</span>
    <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"{point.name}"</span>, <span class="st">"{point.value}"</span><span class="op">)</span>
    <span class="va">tltip</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://jkunst.com/highcharter/reference/tooltip_table.html">tooltip_table</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span>
    
    
    <span class="va">output_highchart</span> <span class="op">&lt;-</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/highchart.html">highchart</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_chart.html">hc_chart</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"sunburst"</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_add_series.html">hc_add_series</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">contact_admin_1_list</span>,
                    allowDrillToNode <span class="op">=</span> <span class="cn">TRUE</span>,
                    levelIsConstant <span class="op">=</span> <span class="cn">FALSE</span>,
                    <span class="co">#textOverflow = "clip",</span>
                    levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>level <span class="op">=</span> <span class="fl">1</span>,
                                       dataLabels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>enabled <span class="op">=</span> <span class="cn">TRUE</span>,
                                                         color <span class="op">=</span> <span class="st">"#FFFFFF"</span>,
                                                         style <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>textOverflow <span class="op">=</span> <span class="st">"clip"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, 
                                  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>level <span class="op">=</span> <span class="fl">2</span>, 
                                       dataLabels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>enabled <span class="op">=</span> <span class="cn">TRUE</span>, 
                                                         color <span class="op">=</span> <span class="st">"#FFFFFF"</span>,
                                                         style <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>textOverflow <span class="op">=</span> <span class="st">"clip"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, 
                                  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>level <span class="op">=</span> <span class="fl">3</span>,
                                       dataLabels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>enabled <span class="op">=</span> <span class="cn">TRUE</span>, 
                                                         color <span class="op">=</span> <span class="st">"#FFFFFF"</span>,
                                                         style <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>textOverflow <span class="op">=</span> <span class="st">"clip"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_plotOptions.html">hc_plotOptions</a></span><span class="op">(</span>sunburst <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>dataLabels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>enabled <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_tooltip.html">hc_tooltip</a></span><span class="op">(</span>useHTML <span class="op">=</span> <span class="cn">TRUE</span>, 
                 headerFormat <span class="op">=</span> <span class="st">""</span>, pointFormat <span class="op">=</span> <span class="va">tltip</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_exporting.html">hc_exporting</a></span><span class="op">(</span>enabled <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
    
    <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"pptx"</span>, <span class="st">"docx"</span>, <span class="st">"pdf"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
      
      <span class="va">output_highchart</span> <span class="op">&lt;-</span>
        <span class="va">output_highchart</span> <span class="op">%&gt;%</span> 
        <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_exporting.html">hc_exporting</a></span><span class="op">(</span>enabled <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_plotOptions.html">hc_plotOptions</a></span><span class="op">(</span>series <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>animation <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
        <span class="fu">html_webshot</span><span class="op">(</span><span class="op">)</span>
      <span class="co"># no need to return anything. html_webshot prints automatically</span>
    <span class="op">}</span>
    
    <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"html (page)"</span>, <span class="st">"html (slides)"</span>, <span class="st">"shiny"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
      
      <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">output_highchart</span><span class="op">)</span>
      
    <span class="op">}</span>
    
  <span class="op">}</span></code></pre></div>
</div>
<div id="cumul_contacts_today_table" class="section level2">
<h2 class="hasAnchor">
<a href="#cumul_contacts_today_table" class="anchor"></a>cumul_contacts_today_table</h2>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cumul_contacts_today_table</span> <span class="op">&lt;-</span> 
  <span class="kw">function</span><span class="op">(</span><span class="va">contacts_df_long</span>, <span class="va">report_format</span> <span class="op">=</span> <span class="st">"shiny"</span><span class="op">)</span><span class="op">{</span>

    
    <span class="va">data_to_plot</span> <span class="op">&lt;-</span> 
      <span class="va">contacts_df_long</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">row_id</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="co"># slice long frame</span>
      <span class="fu">slice_head</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">admin_1</span>, <span class="va">admin_2</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu">count</span><span class="op">(</span><span class="va">admin_1</span>, <span class="va">admin_2</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">admin_1</span>, <span class="va">admin_2</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>percent <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fl">100</span> <span class="op">*</span> <span class="va">n</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">admin_1</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>admin_1_sum <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>admin_1_percent <span class="op">=</span> <span class="va">admin_1_sum</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="op">-</span><span class="va">admin_1_percent</span>, <span class="op">-</span><span class="va">n</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span>`Admin level 1` <span class="op">=</span> <span class="va">admin_1</span>, 
             `Admin level 2` <span class="op">=</span> <span class="va">admin_2</span>, 
             `Total contacts` <span class="op">=</span> <span class="va">n</span>,
             `%` <span class="op">=</span> <span class="va">percent</span><span class="op">)</span>
    
    
    
    
    <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"shiny"</span>,<span class="st">"html (page)"</span>, <span class="st">"html (slides)"</span>, <span class="st">"pdf"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
      
      <span class="va">output_table</span> <span class="op">&lt;-</span>  
        <span class="va">data_to_plot</span> <span class="op">%&gt;%</span>
        <span class="fu"><a href="https://glin.github.io/reactable/reference/reactable.html">reactable</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>`Total contacts` <span class="op">=</span> <span class="fu"><a href="https://glin.github.io/reactable/reference/colDef.html">colDef</a></span><span class="op">(</span>cell <span class="op">=</span> <span class="fu"><a href="https://kcuilla.github.io/reactablefmtr/reference/data_bars_gradient.html">data_bars_gradient</a></span><span class="op">(</span><span class="va">data_to_plot</span>, 
                                                                                     colors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">peach</span>, <span class="va">bright_yellow_crayola</span><span class="op">)</span>,
                                                                                     background <span class="op">=</span> <span class="st">"transparent"</span><span class="op">)</span>,
                                                           style <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>fontFamily <span class="op">=</span> <span class="st">"Courier"</span>, whiteSpace <span class="op">=</span> <span class="st">"pre"</span>, fontSize <span class="op">=</span> <span class="fl">13</span><span class="op">)</span><span class="op">)</span>, 
                                 `Admin level 1` <span class="op">=</span> <span class="fu"><a href="https://glin.github.io/reactable/reference/colDef.html">colDef</a></span><span class="op">(</span>style <span class="op">=</span> <span class="fu"><a href="http://jkunst.com/highcharter/reference/highcharter-exports.html">JS</a></span><span class="op">(</span><span class="st">"function(rowInfo, colInfo, state) {
                                                          var firstSorted = state.sorted[0]
                                                          // Merge cells if unsorted or sorting by admin_1
                                                          if (!firstSorted || firstSorted.id === 'Admin level 1') {
                                                          var prevRow = state.pageRows[rowInfo.viewIndex - 1]
                                                          if (prevRow &amp;&amp; rowInfo.row['Admin level 1'] === prevRow['Admin level 1']) {
                                                          return { visibility: 'hidden' }
                                                          }
                                                          }}"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,
                  striped <span class="op">=</span> <span class="cn">TRUE</span>,
                  highlight <span class="op">=</span> <span class="cn">TRUE</span>,
                  defaultPageSize <span class="op">=</span> <span class="fl">15</span><span class="op">)</span>
    <span class="op">}</span>
    
    
    <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"pptx"</span>,<span class="st">"docx"</span>, <span class="st">"pdf"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
      
      <span class="va">output_table</span> <span class="op">&lt;-</span> 
        <span class="va">data_to_plot</span> <span class="op">%&gt;%</span> 
        <span class="fu">janitor</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/janitor/man/adorn_totals.html">adorn_totals</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
        <span class="fu"><a href="https://hughjonesd.github.io/huxtable/reference/huxtable.html">huxtable</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
        <span class="fu"><a href="https://hughjonesd.github.io/huxtable/reference/set-multiple.html">set_all_padding</a></span><span class="op">(</span><span class="fl">0.5</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu"><a href="https://hughjonesd.github.io/huxtable/reference/merge_repeated_rows.html">merge_repeated_rows</a></span><span class="op">(</span>col <span class="op">=</span> <span class="st">"Admin level 1"</span><span class="op">)</span> <span class="op">%&gt;%</span> 
        <span class="fu"><a href="https://hughjonesd.github.io/huxtable/reference/themes.html">theme_blue</a></span><span class="op">(</span><span class="op">)</span>
      
    <span class="op">}</span>
    
    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">output_table</span><span class="op">)</span>
    
    
  <span class="op">}</span></code></pre></div>
</div>
<div id="cumul_contacts_today_text" class="section level2">
<h2 class="hasAnchor">
<a href="#cumul_contacts_today_text" class="anchor"></a>cumul_contacts_today_text</h2>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cumul_contacts_today_text</span> <span class="op">&lt;-</span> 
  <span class="kw">function</span><span class="op">(</span><span class="va">contacts_df_long</span>, <span class="va">report_format</span> <span class="op">=</span> <span class="st">"shiny"</span><span class="op">)</span><span class="op">{</span>
  
    <span class="va">data_to_plot</span> <span class="op">&lt;-</span> 
      <span class="va">contacts_df_long</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">row_id</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="co"># slice long frame</span>
      <span class="fu">slice_head</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">admin_1</span>, <span class="va">admin_2</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu">count</span><span class="op">(</span><span class="va">admin_1</span>, <span class="va">admin_2</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">admin_1</span>, <span class="va">admin_2</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>percent <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fl">100</span> <span class="op">*</span> <span class="va">n</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">admin_1</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>admin_1_sum <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>admin_1_percent <span class="op">=</span> <span class="va">admin_1_sum</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">admin_1</span>, 
             <span class="va">admin_1_sum</span>,
             <span class="va">admin_1_percent</span>,
             <span class="va">admin_2</span>, 
             admin_2_sum <span class="op">=</span> <span class="va">n</span>,
             admin_2_percent <span class="op">=</span> <span class="va">percent</span><span class="op">)</span>
    
    <span class="va">admin_1_w_most_contacts</span> <span class="op">&lt;-</span> 
      <span class="va">data_to_plot</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="op">-</span><span class="va">admin_1_percent</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="va">.</span><span class="op">$</span><span class="va">admin_1</span> <span class="op">%&gt;%</span> <span class="va">.</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>
    
    <span class="va">n_contacts_in_admin_1_w_most_contacts</span> <span class="op">&lt;-</span> 
      <span class="va">data_to_plot</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="op">-</span><span class="va">admin_1_percent</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="va">.</span><span class="op">$</span><span class="va">admin_1_sum</span> <span class="op">%&gt;%</span> <span class="va">.</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>
    
    <span class="va">pct_contacts_in_admin_1_w_most_contacts</span> <span class="op">&lt;-</span> 
      <span class="va">data_to_plot</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="op">-</span><span class="va">admin_1_percent</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="va">.</span><span class="op">$</span><span class="va">admin_1_percent</span> <span class="op">%&gt;%</span> <span class="va">.</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">%&gt;%</span> 
      <span class="fu">magrittr</span><span class="fu">::</span><span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">multiply_by</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">.</span>, <span class="st">"%"</span><span class="op">)</span>
    
    
    <span class="va">info</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"&lt;br&gt;
            &lt;span style='color: rgb(97, 189, 109);'&gt;ℹ:&lt;/span&gt;
            &lt;font size='1'&gt;The table and plots show the count of all contacts recorded in each level 1 division since database inception. &lt;/font&gt;"</span><span class="op">)</span>
    
    <span class="va">str1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op">(</span><span class="st">"&lt;br&gt;The level 1 division with the most total contacts since database inception is &lt;b&gt; {admin_1_w_most_contacts}&lt;/b&gt;, 
                 with &lt;b&gt;{n_contacts_in_admin_1_w_most_contacts}&lt;/b&gt; contacts (&lt;b&gt;{pct_contacts_in_admin_1_w_most_contacts}&lt;/b&gt; of the total)"</span> <span class="op">)</span>
    
      
    <span class="va">output_text</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/htmltools/man/HTML.html">HTML</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">info</span>, <span class="va">str1</span>, sep <span class="op">=</span> <span class="st">'&lt;br/&gt;'</span><span class="op">)</span><span class="op">)</span>
    
    
    <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"pptx"</span>, <span class="st">"docx"</span>, <span class="st">"pdf"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
      <span class="va">output_text</span> <span class="op">%&gt;%</span>
        <span class="fu"><a href="https://rdrr.io/r/base/rawConversion.html">charToRaw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu"><a href="http://xml2.r-lib.org/reference/read_xml.html">read_html</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu"><a href="https://rvest.tidyverse.org/reference/html_text.html">html_text2</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu">str_trim</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu">pander</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pander/man/pandoc.p.return.html">pandoc.p</a></span><span class="op">(</span><span class="op">)</span>
      <span class="co"># no need to return anything. pandoc.p prints automatically</span>
    <span class="op">}</span>
    
    <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"shiny"</span>, <span class="st">"html (page)"</span>, <span class="st">"html (slides)"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
      <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">output_text</span><span class="op">)</span>
    <span class="op">}</span>
  
  
<span class="op">}</span></code></pre></div>
</div>
</div>
<div id="cumul_contacts_historical" class="section level1">
<h1 class="hasAnchor">
<a href="#cumul_contacts_historical" class="anchor"></a>cumul_contacts_historical</h1>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<span class="co"># ~ cumul_contacts_historical-----------</span>
<span class="co"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></code></pre></div>
<p>Functions showing how the number of new contacts (contacts initiating follow-up on the given day) ## cumul_contacts_historical_row_title</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cumul_contacts_historical_row_title</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">report_format</span> <span class="op">=</span> <span class="st">"shiny"</span><span class="op">)</span><span class="op">{</span>
  <span class="co">## doesn't need to a function at the moment. </span>
  <span class="co">## But we leave it there in case we want to take in an input or two</span>

  <span class="va">output_text</span> <span class="op">&lt;-</span> <span class="st">"Total/cumulative contacts, trend over time"</span>
  
  <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"pptx"</span>, <span class="st">"docx"</span>, <span class="st">"pdf"</span>, <span class="st">"html (page)"</span>, <span class="st">"html (slides)"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">output_text</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://rdrr.io/r/base/rawConversion.html">charToRaw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="http://xml2.r-lib.org/reference/read_xml.html">read_html</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://rvest.tidyverse.org/reference/html_text.html">html_text2</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu">str_trim</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu">pander</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pander/man/pandoc.header.return.html">pandoc.header</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>
    <span class="co"># no need to return anything. pandoc.p prints automatically</span>
  <span class="op">}</span>
  
  <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"shiny"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/htmltools/man/builder.html">h3</a></span><span class="op">(</span><span class="va">output_text</span>,
              style <span class="op">=</span> <span class="st">"display: inline;"</span><span class="op">)</span> <span class="op">)</span>
  <span class="op">}</span>
  
<span class="op">}</span></code></pre></div>
<div id="cumul_contacts_historical_bar_chart" class="section level2">
<h2 class="hasAnchor">
<a href="#cumul_contacts_historical_bar_chart" class="anchor"></a>cumul_contacts_historical_bar_chart</h2>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cumul_contacts_historical_bar_chart</span> <span class="op">&lt;-</span> 
  <span class="kw">function</span><span class="op">(</span><span class="va">contacts_df_long</span>, <span class="va">todays_date</span>, <span class="va">report_format</span> <span class="op">=</span> <span class="st">"shiny"</span><span class="op">)</span><span class="op">{</span>
    
    <span class="va">contacts_df_long_filt</span> <span class="op">&lt;-</span> 
      <span class="va">contacts_df_long</span> <span class="op">%&gt;%</span> 
            <span class="co">## filter out dates that are past the input days date ("future follow-up" rows)</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">follow_up_date</span> <span class="op">&lt;=</span> <span class="va">todays_date</span><span class="op">)</span>
    
    
    <span class="va">data_to_plot</span> <span class="op">&lt;-</span> 
      <span class="va">contacts_df_long_filt</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">row_id</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">slice_head</span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co">## slice long frame</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">admin_1</span>, <span class="va">follow_up_date</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">follow_up_date</span>, <span class="va">admin_1</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">count</span><span class="op">(</span><span class="va">admin_1</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">admin_1</span>, <span class="va">follow_up_date</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">bind_rows</span><span class="op">(</span><span class="fu">tibble</span><span class="op">(</span>follow_up_date <span class="op">=</span>  <span class="fu"><a href="https://rdrr.io/r/base/seq.Date.html">seq.Date</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">.</span><span class="op">$</span><span class="va">follow_up_date</span><span class="op">)</span>, 
                                                  to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">.</span><span class="op">$</span><span class="va">follow_up_date</span><span class="op">)</span>, 
                                                  by <span class="op">=</span> <span class="st">"day"</span><span class="op">)</span>, 
                       admin_1 <span class="op">=</span> <span class="st">"temporary"</span>
      <span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">complete</span><span class="op">(</span><span class="va">follow_up_date</span>, <span class="va">admin_1</span>, fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">admin_1</span> <span class="op">!=</span> <span class="st">"temporary"</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">admin_1</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>cumul <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html">cumsum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="co"># admin_1 with the most cases should be at the top</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">admin_1</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>total <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">cumul</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>admin_1 <span class="op">=</span> <span class="fu">fct_rev</span><span class="op">(</span><span class="fu">fct_reorder</span><span class="op">(</span><span class="va">admin_1</span>, <span class="va">total</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
    
    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data_to_plot</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span>
      <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="http://jkunst.com/highcharter/reference/highchart.html">highchart</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_title.html">hc_title</a></span><span class="op">(</span>text  <span class="op">=</span> <span class="st">"No data to plot"</span><span class="op">)</span><span class="op">)</span>
    <span class="op">}</span>
    
    <span class="va">output_highchart</span> <span class="op">&lt;-</span> 
      <span class="va">data_to_plot</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hchart.html">hchart</a></span><span class="op">(</span><span class="st">"column"</span>, <span class="fu"><a href="http://jkunst.com/highcharter/reference/hcaes.html">hcaes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">follow_up_date</span>, y <span class="op">=</span> <span class="va">cumul</span>, group <span class="op">=</span> <span class="va">admin_1</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_yAxis.html">hc_yAxis</a></span><span class="op">(</span>visible <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_plotOptions.html">hc_plotOptions</a></span><span class="op">(</span>column <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>stacking <span class="op">=</span> <span class="st">"normal"</span>, 
                                   pointPadding <span class="op">=</span> <span class="fl">0</span>, 
                                   groupPadding <span class="op">=</span> <span class="fl">0</span>, 
                                   borderWidth<span class="op">=</span> <span class="fl">0.05</span>,
                                   stickyTracking <span class="op">=</span> <span class="cn">T</span>
      <span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_plotOptions.html">hc_plotOptions</a></span><span class="op">(</span>column <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>states <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>inactive <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>opacity <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_xAxis.html">hc_xAxis</a></span><span class="op">(</span>title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>text <span class="op">=</span> <span class="st">"Date"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_yAxis.html">hc_yAxis</a></span><span class="op">(</span>title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>text <span class="op">=</span> <span class="st">"No. of cumulative contacts"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_exporting.html">hc_exporting</a></span><span class="op">(</span>enabled <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
    
    
    <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"pptx"</span>, <span class="st">"docx"</span>, <span class="st">"pdf"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
      
      <span class="va">output_highchart</span> <span class="op">&lt;-</span>
        <span class="va">output_highchart</span> <span class="op">%&gt;%</span> 
        <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_exporting.html">hc_exporting</a></span><span class="op">(</span>enabled <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_plotOptions.html">hc_plotOptions</a></span><span class="op">(</span>series <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>animation <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
        <span class="fu">html_webshot</span><span class="op">(</span><span class="op">)</span>
      <span class="co"># no need to return anything. html_webshot prints automatically</span>
    <span class="op">}</span>
    
    <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"html (page)"</span>, <span class="st">"html (slides)"</span>, <span class="st">"shiny"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
      
      <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">output_highchart</span><span class="op">)</span>
      
    <span class="op">}</span>
    
  <span class="op">}</span></code></pre></div>
</div>
<div id="cumul_contacts_historical_bar_chart_relative" class="section level2">
<h2 class="hasAnchor">
<a href="#cumul_contacts_historical_bar_chart_relative" class="anchor"></a>cumul_contacts_historical_bar_chart_relative</h2>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cumul_contacts_historical_bar_chart_relative</span> <span class="op">&lt;-</span> 
  <span class="kw">function</span><span class="op">(</span><span class="va">contacts_df_long</span>, <span class="va">todays_date</span>, <span class="va">report_format</span> <span class="op">=</span> <span class="st">"shiny"</span><span class="op">)</span><span class="op">{</span>
    
    <span class="va">contacts_df_long_filt</span> <span class="op">&lt;-</span> 
      <span class="va">contacts_df_long</span> <span class="op">%&gt;%</span> 
      <span class="co">## filter out dates that are past the input days date (future followups)</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">follow_up_date</span> <span class="op">&lt;=</span> <span class="va">todays_date</span><span class="op">)</span>
    
    
    <span class="va">data_to_plot</span> <span class="op">&lt;-</span> 
      <span class="va">contacts_df_long_filt</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">row_id</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">slice_head</span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co">## slice long frame</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">admin_1</span>, <span class="va">follow_up_date</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">follow_up_date</span>, <span class="va">admin_1</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">count</span><span class="op">(</span><span class="va">admin_1</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">admin_1</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>cumul <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html">cumsum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">follow_up_date</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>prop <span class="op">=</span> <span class="va">n</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>prop <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">prop</span>, digits <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">admin_1</span>, <span class="va">follow_up_date</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">bind_rows</span><span class="op">(</span><span class="fu">tibble</span><span class="op">(</span>follow_up_date <span class="op">=</span>  <span class="fu"><a href="https://rdrr.io/r/base/seq.Date.html">seq.Date</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">.</span><span class="op">$</span><span class="va">follow_up_date</span><span class="op">)</span>, 
                                                  to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">.</span><span class="op">$</span><span class="va">follow_up_date</span><span class="op">)</span>, 
                                                  by <span class="op">=</span> <span class="st">"day"</span><span class="op">)</span>, 
                       admin_1 <span class="op">=</span> <span class="st">"temporary"</span>
      <span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">complete</span><span class="op">(</span><span class="va">follow_up_date</span>, <span class="va">admin_1</span>, fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">0</span>, prop <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">admin_1</span> <span class="op">!=</span> <span class="st">"temporary"</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="co"># admin_1 with the most cases should be at the top</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">admin_1</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>total <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>admin_1 <span class="op">=</span> <span class="fu">fct_rev</span><span class="op">(</span><span class="fu">fct_reorder</span><span class="op">(</span><span class="va">admin_1</span>, <span class="va">total</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
    
    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data_to_plot</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span>
      <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="http://jkunst.com/highcharter/reference/highchart.html">highchart</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_title.html">hc_title</a></span><span class="op">(</span>text  <span class="op">=</span> <span class="st">"No data to plot"</span><span class="op">)</span><span class="op">)</span>
    <span class="op">}</span>
    
    <span class="va">output_highchart</span> <span class="op">&lt;-</span> 
      <span class="va">data_to_plot</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hchart.html">hchart</a></span><span class="op">(</span><span class="st">"column"</span>, <span class="fu"><a href="http://jkunst.com/highcharter/reference/hcaes.html">hcaes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">follow_up_date</span>, y <span class="op">=</span> <span class="va">prop</span>, group <span class="op">=</span> <span class="va">admin_1</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_yAxis.html">hc_yAxis</a></span><span class="op">(</span>visible <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_plotOptions.html">hc_plotOptions</a></span><span class="op">(</span>column <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>stacking <span class="op">=</span> <span class="st">"normal"</span>, 
                                   pointPadding <span class="op">=</span> <span class="fl">0</span>, 
                                   groupPadding <span class="op">=</span> <span class="fl">0</span>, 
                                   borderWidth<span class="op">=</span> <span class="fl">0.05</span>,
                                   stickyTracking <span class="op">=</span> <span class="cn">T</span>
      <span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_plotOptions.html">hc_plotOptions</a></span><span class="op">(</span>column <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>states <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>inactive <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>opacity <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_xAxis.html">hc_xAxis</a></span><span class="op">(</span>title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>text <span class="op">=</span> <span class="st">"Date"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_yAxis.html">hc_yAxis</a></span><span class="op">(</span>title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>text <span class="op">=</span> <span class="st">"Cumulative contacts, normalized to 1"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_exporting.html">hc_exporting</a></span><span class="op">(</span>enabled <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
    
    
    <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"pptx"</span>, <span class="st">"docx"</span>, <span class="st">"pdf"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
      
      <span class="va">output_highchart</span> <span class="op">&lt;-</span>
        <span class="va">output_highchart</span> <span class="op">%&gt;%</span> 
        <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_exporting.html">hc_exporting</a></span><span class="op">(</span>enabled <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_plotOptions.html">hc_plotOptions</a></span><span class="op">(</span>series <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>animation <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
        <span class="fu">html_webshot</span><span class="op">(</span><span class="op">)</span>
      <span class="co"># no need to return anything. html_webshot prints automatically</span>
    <span class="op">}</span>
    
    <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"html (page)"</span>, <span class="st">"html (slides)"</span>, <span class="st">"shiny"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
      
      <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">output_highchart</span><span class="op">)</span>
      
    <span class="op">}</span>
    
  <span class="op">}</span></code></pre></div>
</div>
<div id="cumul_contacts_historical_text" class="section level2">
<h2 class="hasAnchor">
<a href="#cumul_contacts_historical_text" class="anchor"></a>cumul_contacts_historical_text</h2>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cumul_contacts_historical_text</span> <span class="op">&lt;-</span> 
  <span class="kw">function</span><span class="op">(</span><span class="va">contacts_df_long</span>, <span class="va">report_format</span> <span class="op">=</span> <span class="st">"shiny"</span><span class="op">)</span><span class="op">{</span>
    
    <span class="va">data_to_plot</span> <span class="op">&lt;-</span> 
      <span class="va">contacts_df_long</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">row_id</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="co"># slice long frame</span>
      <span class="fu">slice_head</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">follow_up_date</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">count</span><span class="op">(</span><span class="va">admin_1</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">admin_1</span>, <span class="va">follow_up_date</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">admin_1</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>cumul <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html">cumsum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span>
    
    <span class="va">admin_1_w_most_contacts</span> <span class="op">&lt;-</span> 
      <span class="va">data_to_plot</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="op">-</span><span class="va">cumul</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="va">.</span><span class="op">$</span><span class="va">admin_1</span> <span class="op">%&gt;%</span> <span class="va">.</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>
    
    <span class="va">n_contacts_in_admin_1_w_most_contacts</span> <span class="op">&lt;-</span> 
      <span class="va">data_to_plot</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">admin_1</span> <span class="op">==</span> <span class="va">admin_1_w_most_contacts</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="fu">desc</span><span class="op">(</span><span class="va">follow_up_date</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="va">.</span><span class="op">$</span><span class="va">cumul</span>
    
    <span class="va">n_contacts_in_admin_1_w_most_contacts_today</span> <span class="op">&lt;-</span> 
      <span class="va">n_contacts_in_admin_1_w_most_contacts</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>
    
    
    <span class="va">str1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op">(</span><span class="st">"&lt;br&gt; Today, {admin_1_w_most_contacts} has a cumulative count of &lt;b&gt;{n_contacts_in_admin_1_w_most_contacts_today}&lt;/b&gt; contacts."</span> <span class="op">)</span>
    
    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">n_contacts_in_admin_1_w_most_contacts</span><span class="op">)</span> <span class="op">&gt;=</span>  <span class="fl">7</span><span class="op">)</span><span class="op">{</span>
      
      <span class="va">n_contacts_in_admin_1_w_most_contacts_7d_ago</span> <span class="op">&lt;-</span> 
        <span class="va">n_contacts_in_admin_1_w_most_contacts</span><span class="op">[</span><span class="fl">7</span><span class="op">]</span>
      
      <span class="va">percent_increase</span> <span class="op">&lt;-</span>  
        <span class="op">(</span><span class="va">n_contacts_in_admin_1_w_most_contacts_today</span> <span class="op">-</span> <span class="va">n_contacts_in_admin_1_w_most_contacts_7d_ago</span><span class="op">)</span> <span class="op">%&gt;%</span> 
        <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">divide_by</a></span><span class="op">(</span><span class="va">n_contacts_in_admin_1_w_most_contacts_7d_ago</span><span class="op">)</span> <span class="op">%&gt;%</span> 
        <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span> <span class="op">%&gt;%</span> 
        <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">multiply_by</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>
      
      <span class="va">str2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op">(</span><span class="st">"&lt;br&gt; Seven days ago, there were &lt;b&gt;{n_contacts_in_admin_1_w_most_contacts_7d_ago}&lt;/b&gt; contacts (a {percent_increase} % increase)"</span> <span class="op">)</span>
      
      <span class="va">str1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">str1</span>, <span class="va">str2</span><span class="op">)</span> 
    <span class="op">}</span>
    
    <span class="va">info</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"&lt;br&gt;
            &lt;span style='color: rgb(97, 189, 109);'&gt;ℹ:&lt;/span&gt;
            &lt;font size='1'&gt;The table and plots show the count of cumulative contacts over time. &lt;/font&gt;"</span><span class="op">)</span>
 
    <span class="va">output_text</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/htmltools/man/HTML.html">HTML</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">info</span>, <span class="va">str1</span>, sep <span class="op">=</span> <span class="st">'&lt;br/&gt;'</span><span class="op">)</span><span class="op">)</span>
    
    
    <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"pptx"</span>, <span class="st">"docx"</span>, <span class="st">"pdf"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
      <span class="va">output_text</span> <span class="op">%&gt;%</span>
        <span class="fu"><a href="https://rdrr.io/r/base/rawConversion.html">charToRaw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu"><a href="http://xml2.r-lib.org/reference/read_xml.html">read_html</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu"><a href="https://rvest.tidyverse.org/reference/html_text.html">html_text2</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu">str_trim</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu">pander</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pander/man/pandoc.p.return.html">pandoc.p</a></span><span class="op">(</span><span class="op">)</span>
      <span class="co"># no need to return anything. pandoc.p prints automatically</span>
    <span class="op">}</span>
    
    <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"shiny"</span>, <span class="st">"html (page)"</span>, <span class="st">"html (slides)"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
      <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">output_text</span><span class="op">)</span>
    <span class="op">}</span>
    
    
  <span class="op">}</span></code></pre></div>
</div>
</div>
<div id="active_contacts_today" class="section level1">
<h1 class="hasAnchor">
<a href="#active_contacts_today" class="anchor"></a>active_contacts_today</h1>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<span class="co"># ~ active_contacts_today  --------------------</span>
<span class="co"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></code></pre></div>
<p>Below we call the contacts_per_admin_1 functions. These show the distribution of contacts over admin level 1 and admin level 2. ## active_contacts_today_row_title</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">active_contacts_today_row_title</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">todays_date</span>, <span class="va">report_format</span> <span class="op">=</span> <span class="st">"shiny"</span><span class="op">)</span><span class="op">{</span>
  
  <span class="va">formatted_date</span> <span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">format.Date</a></span><span class="op">(</span><span class="va">todays_date</span>,
                               format <span class="op">=</span> <span class="st">"%b %d, %Y"</span><span class="op">)</span>
  
  <span class="va">output_text</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Contacts under surveillance (as at "</span>, <span class="va">formatted_date</span>, <span class="st">")"</span><span class="op">)</span>
  
  <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"pptx"</span>, <span class="st">"docx"</span>, <span class="st">"pdf"</span>, <span class="st">"html (page)"</span>, <span class="st">"html (slides)"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">output_text</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://rdrr.io/r/base/rawConversion.html">charToRaw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="http://xml2.r-lib.org/reference/read_xml.html">read_html</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://rvest.tidyverse.org/reference/html_text.html">html_text2</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu">str_trim</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu">pander</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pander/man/pandoc.header.return.html">pandoc.header</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>
    <span class="co"># no need to return anything. pandoc.p prints automatically</span>
  <span class="op">}</span>
  
  <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"shiny"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/htmltools/man/builder.html">h3</a></span><span class="op">(</span><span class="va">output_text</span>,
              style <span class="op">=</span> <span class="st">"display: inline;"</span><span class="op">)</span> <span class="op">)</span>
  <span class="op">}</span>
  
<span class="op">}</span></code></pre></div>
<div id="active_contacts_today_bar_chart" class="section level2">
<h2 class="hasAnchor">
<a href="#active_contacts_today_bar_chart" class="anchor"></a>active_contacts_today_bar_chart</h2>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">active_contacts_today_bar_chart</span> <span class="op">&lt;-</span> 
  <span class="kw">function</span><span class="op">(</span><span class="va">contacts_df_long</span>, <span class="va">todays_date</span>, <span class="va">report_format</span> <span class="op">=</span> <span class="st">"shiny"</span><span class="op">)</span><span class="op">{</span>
    
   <span class="co">## filter out dates that are past the input days date ("future follow-up" rows)</span>
    <span class="va">contacts_df_long_filt</span> <span class="op">&lt;-</span> 
      <span class="va">contacts_df_long</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">follow_up_date</span> <span class="op">==</span> <span class="va">todays_date</span><span class="op">)</span>
    
    <span class="va">contact_admin_1</span> <span class="op">&lt;-</span>
      <span class="va">contacts_df_long_filt</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">row_id</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="co"># slice long frame</span>
      <span class="fu">slice_head</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">admin_1</span>, <span class="va">admin_2</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu">add_count</span><span class="op">(</span><span class="va">admin_1</span>, name <span class="op">=</span> <span class="st">"n_admin_1"</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>pct_admin_1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fl">100</span> <span class="op">*</span> <span class="va">n_admin_1</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span>, 
                                 digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">admin_1</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>admin_2 <span class="op">=</span> <span class="fu">fct_lump</span><span class="op">(</span>other_level <span class="op">=</span> <span class="st">"Autres"</span>, 
                                <span class="va">admin_2</span>, prop <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu">add_count</span><span class="op">(</span><span class="va">admin_2</span>, name <span class="op">=</span> <span class="st">"n_admin_2"</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>pct_admin_2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fl">100</span> <span class="op">*</span> <span class="va">n_admin_2</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span>, 
                                 digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>data_label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">n_admin_2</span>, <span class="st">" ("</span>, <span class="va">pct_admin_2</span>, <span class="st">"%"</span>, <span class="st">")"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">admin_1</span>, <span class="va">admin_2</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu">slice_head</span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="op">-</span><span class="va">n_admin_1</span>, <span class="op">-</span><span class="va">n_admin_2</span><span class="op">)</span>
    
    
    <span class="va">color_df</span> <span class="op">&lt;-</span> 
      <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>admin_1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">contact_admin_1</span><span class="op">$</span><span class="va">admin_1</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">add_column</span><span class="op">(</span>color_lvl_1 <span class="op">=</span> <span class="va">highcharter_palette</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>
    
    
    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">contact_admin_1</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span>
      <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="http://jkunst.com/highcharter/reference/highchart.html">highchart</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_title.html">hc_title</a></span><span class="op">(</span>text  <span class="op">=</span> <span class="st">"No data to plot"</span><span class="op">)</span><span class="op">)</span>
    <span class="op">}</span>
    
    
    <span class="va">subtitle</span> <span class="op">&lt;-</span>  
      <span class="va">contact_admin_1</span> <span class="op">%&gt;%</span> 
      <span class="fu">left_join</span><span class="op">(</span><span class="va">color_df</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">admin_1</span>, <span class="va">pct_admin_1</span>, <span class="va">color_lvl_1</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>sep <span class="op">=</span> <span class="fu">case_when</span><span class="op">(</span><span class="fu">row_number</span><span class="op">(</span><span class="op">)</span> <span class="op">==</span> <span class="op">(</span><span class="fu">n</span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op">~</span> <span class="st">" and "</span>,
                             <span class="fu">row_number</span><span class="op">(</span><span class="op">)</span> <span class="op">==</span> <span class="fu">n</span><span class="op">(</span><span class="op">)</span> <span class="op">~</span> <span class="st">""</span>,
                             <span class="cn">TRUE</span> <span class="op">~</span> <span class="st">","</span><span class="op">)</span>
      <span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>txt <span class="op">=</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_glue.html">str_glue</a></span><span class="op">(</span><span class="st">"&lt;strong&gt;&lt;span style='background-color: {color_lvl_1};color:white'&gt;
                                      &amp;nbsp;{admin_1}&amp;nbsp;&lt;/span&gt;&lt;/strong&gt; ({pct_admin_1}% of contacts){sep}"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">txt</span>, collapse <span class="op">=</span> <span class="st">""</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">pull</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_c.html">str_c</a></span><span class="op">(</span><span class="st">"Level 1 divisions shown: "</span>, <span class="va">.</span><span class="op">)</span>
    
    
    
    <span class="va">output_highchart</span> <span class="op">&lt;-</span> 
      <span class="va">contact_admin_1</span> <span class="op">%&gt;%</span> 
      <span class="fu">left_join</span><span class="op">(</span><span class="va">color_df</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hchart.html">hchart</a></span><span class="op">(</span><span class="st">"bar"</span>, <span class="fu"><a href="http://jkunst.com/highcharter/reference/hcaes.html">hcaes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">admin_2</span> , y <span class="op">=</span> <span class="va">n_admin_2</span>, color <span class="op">=</span> <span class="va">color_lvl_1</span><span class="op">)</span>,
             size <span class="op">=</span> <span class="fl">4</span>,
             name <span class="op">=</span> <span class="st">"n"</span>,
             dataLabels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>enabled <span class="op">=</span> <span class="cn">TRUE</span>,
                               formatter <span class="op">=</span> <span class="fu"><a href="http://jkunst.com/highcharter/reference/highcharter-exports.html">JS</a></span><span class="op">(</span><span class="st">"function(){return(this.point.data_label)}"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_legend.html">hc_legend</a></span><span class="op">(</span>enabled <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_plotOptions.html">hc_plotOptions</a></span><span class="op">(</span>series <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>groupPadding <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_subtitle.html">hc_subtitle</a></span><span class="op">(</span>text <span class="op">=</span> <span class="va">subtitle</span>, useHTML <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_xAxis.html">hc_xAxis</a></span><span class="op">(</span>title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>text <span class="op">=</span> <span class="st">"Admin level 2"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_yAxis.html">hc_yAxis</a></span><span class="op">(</span>title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>text <span class="op">=</span> <span class="st">"Number under surveillance"</span><span class="op">)</span><span class="op">)</span>
    
    
    
    <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"pptx"</span>, <span class="st">"docx"</span>, <span class="st">"pdf"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
      
      <span class="va">output_highchart</span> <span class="op">&lt;-</span>
        <span class="va">output_highchart</span> <span class="op">%&gt;%</span> 
        <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_exporting.html">hc_exporting</a></span><span class="op">(</span>enabled <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_plotOptions.html">hc_plotOptions</a></span><span class="op">(</span>series <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>animation <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
        <span class="fu">html_webshot</span><span class="op">(</span><span class="op">)</span>
      <span class="co"># no need to return anything. html_webshot prints automatically</span>
    <span class="op">}</span>
    
    <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"html (page)"</span>, <span class="st">"html (slides)"</span>, <span class="st">"shiny"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
      
      <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">output_highchart</span><span class="op">)</span>
      
    <span class="op">}</span>
    
    
  <span class="op">}</span></code></pre></div>
</div>
<div id="active_contacts_today_sunburst_plot" class="section level2">
<h2 class="hasAnchor">
<a href="#active_contacts_today_sunburst_plot" class="anchor"></a>active_contacts_today_sunburst_plot</h2>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">active_contacts_today_sunburst_plot</span> <span class="op">&lt;-</span> 
  <span class="kw">function</span><span class="op">(</span><span class="va">contacts_df_long</span>, <span class="va">todays_date</span>, <span class="va">report_format</span> <span class="op">=</span> <span class="st">"shiny"</span><span class="op">)</span><span class="op">{</span>
    
    <span class="co">## filter out dates that are past the input days date ("future follow-up" rows)</span>
    <span class="va">contacts_df_long_filt</span> <span class="op">&lt;-</span> 
      <span class="va">contacts_df_long</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">follow_up_date</span> <span class="op">==</span> <span class="va">todays_date</span><span class="op">)</span>
    
    <span class="va">contact_admin_1</span> <span class="op">&lt;-</span>
      <span class="va">contacts_df_long_filt</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">row_id</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="co"># slice long frame</span>
      <span class="fu">slice_head</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">admin_1</span>, <span class="va">admin_2</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu">add_count</span><span class="op">(</span><span class="va">admin_1</span>, name <span class="op">=</span> <span class="st">"n_admin_1"</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>pct_admin_1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fl">100</span> <span class="op">*</span> <span class="va">n_admin_1</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span>, 
                                 digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>admin_1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">admin_1</span>, 
                              <span class="st">" ("</span>, <span class="va">pct_admin_1</span>, <span class="st">"%"</span>, <span class="st">")"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">admin_1</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>admin_2 <span class="op">=</span> <span class="fu">fct_lump</span><span class="op">(</span>other_level <span class="op">=</span> <span class="st">"Autres"</span>, 
                                <span class="va">admin_2</span>, prop <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu">add_count</span><span class="op">(</span><span class="va">admin_2</span>, name <span class="op">=</span> <span class="st">"n_admin_2"</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>pct_admin_2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fl">100</span> <span class="op">*</span> <span class="va">n_admin_2</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span>, 
                                 digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>admin_2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">admin_2</span>, <span class="st">" ("</span>, <span class="va">pct_admin_2</span>, <span class="st">"%"</span>, <span class="st">")"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">admin_1</span>, <span class="va">admin_2</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu">slice_head</span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="op">-</span><span class="va">n_admin_1</span><span class="op">)</span>
    
    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">contact_admin_1</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span>
      <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="http://jkunst.com/highcharter/reference/highchart.html">highchart</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_title.html">hc_title</a></span><span class="op">(</span>text  <span class="op">=</span> <span class="st">"No data to plot"</span><span class="op">)</span><span class="op">)</span>
    <span class="op">}</span>
    
    <span class="va">color_df</span> <span class="op">&lt;-</span> 
      <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>admin_1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">contact_admin_1</span><span class="op">$</span><span class="va">admin_1</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">add_column</span><span class="op">(</span>color_lvl_1 <span class="op">=</span> <span class="va">highcharter_palette</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>
    
    <span class="va">contact_admin_1_list</span> <span class="op">&lt;-</span> 
      <span class="va">contact_admin_1</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/data_to_hierarchical.html">data_to_hierarchical</a></span><span class="op">(</span>group_vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">admin_1</span>, 
                                          <span class="va">admin_2</span><span class="op">)</span>, 
                           size_var <span class="op">=</span> <span class="va">n_admin_2</span>, 
                           colors<span class="op">=</span> <span class="va">color_df</span><span class="op">$</span><span class="va">color_lvl_1</span><span class="op">)</span>
    
    
    <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Type: "</span>, <span class="st">"n = "</span><span class="op">)</span>
    <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"{point.name}"</span>, <span class="st">"{point.value}"</span><span class="op">)</span>
    <span class="va">tltip</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://jkunst.com/highcharter/reference/tooltip_table.html">tooltip_table</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span>
    
    
    <span class="va">output_highchart</span> <span class="op">&lt;-</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/highchart.html">highchart</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_chart.html">hc_chart</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"sunburst"</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_add_series.html">hc_add_series</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">contact_admin_1_list</span>,
                    allowDrillToNode <span class="op">=</span> <span class="cn">TRUE</span>,
                    levelIsConstant <span class="op">=</span> <span class="cn">FALSE</span>,
                    <span class="co">#textOverflow = "clip",</span>
                    levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>level <span class="op">=</span> <span class="fl">1</span>,
                                       dataLabels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>enabled <span class="op">=</span> <span class="cn">TRUE</span>,
                                                         color <span class="op">=</span> <span class="st">"#FFFFFF"</span>,
                                                         style <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>textOverflow <span class="op">=</span> <span class="st">"clip"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, 
                                  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>level <span class="op">=</span> <span class="fl">2</span>, 
                                       dataLabels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>enabled <span class="op">=</span> <span class="cn">TRUE</span>, 
                                                         color <span class="op">=</span> <span class="st">"#FFFFFF"</span>,
                                                         style <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>textOverflow <span class="op">=</span> <span class="st">"clip"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, 
                                  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>level <span class="op">=</span> <span class="fl">3</span>,
                                       dataLabels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>enabled <span class="op">=</span> <span class="cn">TRUE</span>, 
                                                         color <span class="op">=</span> <span class="st">"#FFFFFF"</span>,
                                                         style <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>textOverflow <span class="op">=</span> <span class="st">"clip"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_plotOptions.html">hc_plotOptions</a></span><span class="op">(</span>sunburst <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>dataLabels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>enabled <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_tooltip.html">hc_tooltip</a></span><span class="op">(</span>useHTML <span class="op">=</span> <span class="cn">TRUE</span>, 
                 headerFormat <span class="op">=</span> <span class="st">""</span>, pointFormat <span class="op">=</span> <span class="va">tltip</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_exporting.html">hc_exporting</a></span><span class="op">(</span>enabled <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
    
    <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"pptx"</span>, <span class="st">"docx"</span>, <span class="st">"pdf"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
      
      <span class="va">output_highchart</span> <span class="op">&lt;-</span>
        <span class="va">output_highchart</span> <span class="op">%&gt;%</span> 
        <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_exporting.html">hc_exporting</a></span><span class="op">(</span>enabled <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_plotOptions.html">hc_plotOptions</a></span><span class="op">(</span>series <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>animation <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
        <span class="fu">html_webshot</span><span class="op">(</span><span class="op">)</span>
      <span class="co"># no need to return anything. html_webshot prints automatically</span>
    <span class="op">}</span>
    
    <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"html (page)"</span>, <span class="st">"html (slides)"</span>, <span class="st">"shiny"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
      
      <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">output_highchart</span><span class="op">)</span>
      
    <span class="op">}</span>
    
  <span class="op">}</span></code></pre></div>
</div>
<div id="active_contacts_today_table" class="section level2">
<h2 class="hasAnchor">
<a href="#active_contacts_today_table" class="anchor"></a>active_contacts_today_table</h2>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">active_contacts_today_table</span> <span class="op">&lt;-</span> 
  <span class="kw">function</span><span class="op">(</span><span class="va">contacts_df_long</span>, <span class="va">todays_date</span>, <span class="va">report_format</span> <span class="op">=</span> <span class="st">"shiny"</span><span class="op">)</span><span class="op">{</span>
    <span class="co">## filter out dates that are past the input days date ("future follow-up" rows)</span>
    <span class="va">contacts_df_long_filt</span> <span class="op">&lt;-</span> 
      <span class="va">contacts_df_long</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">follow_up_date</span> <span class="op">==</span> <span class="va">todays_date</span><span class="op">)</span>

    <span class="va">data_to_plot</span> <span class="op">&lt;-</span> 
      <span class="va">contacts_df_long_filt</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">row_id</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="co"># slice long frame</span>
      <span class="fu">slice_head</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">admin_1</span>, <span class="va">admin_2</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu">count</span><span class="op">(</span><span class="va">admin_1</span>, <span class="va">admin_2</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">admin_1</span>, <span class="va">admin_2</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>percent <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fl">100</span> <span class="op">*</span> <span class="va">n</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">admin_1</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>admin_1_sum <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>admin_1_percent <span class="op">=</span> <span class="va">admin_1_sum</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="op">-</span><span class="va">admin_1_percent</span>, <span class="op">-</span><span class="va">n</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span>`Admin level 1` <span class="op">=</span> <span class="va">admin_1</span>, 
             `Admin level 2` <span class="op">=</span> <span class="va">admin_2</span>, 
             `No. under surveillance` <span class="op">=</span> <span class="va">n</span>,
             `%` <span class="op">=</span> <span class="va">percent</span><span class="op">)</span>
    
    
    
    
    <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"shiny"</span>,<span class="st">"html (page)"</span>, <span class="st">"html (slides)"</span>, <span class="st">"pdf"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
      
      <span class="va">output_table</span> <span class="op">&lt;-</span>  
        <span class="va">data_to_plot</span> <span class="op">%&gt;%</span>
        <span class="fu"><a href="https://glin.github.io/reactable/reference/reactable.html">reactable</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>`No. under surveillance` <span class="op">=</span> <span class="fu"><a href="https://glin.github.io/reactable/reference/colDef.html">colDef</a></span><span class="op">(</span>cell <span class="op">=</span> <span class="fu"><a href="https://kcuilla.github.io/reactablefmtr/reference/data_bars_gradient.html">data_bars_gradient</a></span><span class="op">(</span><span class="va">data_to_plot</span>, 
                                                                                     colors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">peach</span>, <span class="va">bright_yellow_crayola</span><span class="op">)</span>,
                                                                                     background <span class="op">=</span> <span class="st">"transparent"</span><span class="op">)</span>,
                                                           style <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>fontFamily <span class="op">=</span> <span class="st">"Courier"</span>, whiteSpace <span class="op">=</span> <span class="st">"pre"</span>, fontSize <span class="op">=</span> <span class="fl">13</span><span class="op">)</span><span class="op">)</span>, 
                                 `Admin level 1` <span class="op">=</span> <span class="fu"><a href="https://glin.github.io/reactable/reference/colDef.html">colDef</a></span><span class="op">(</span>style <span class="op">=</span> <span class="fu"><a href="http://jkunst.com/highcharter/reference/highcharter-exports.html">JS</a></span><span class="op">(</span><span class="st">"function(rowInfo, colInfo, state) {
                                                          var firstSorted = state.sorted[0]
                                                          // Merge cells if unsorted or sorting by admin_1
                                                          if (!firstSorted || firstSorted.id === 'Admin level 1') {
                                                          var prevRow = state.pageRows[rowInfo.viewIndex - 1]
                                                          if (prevRow &amp;&amp; rowInfo.row['Admin level 1'] === prevRow['Admin level 1']) {
                                                          return { visibility: 'hidden' }
                                                          }
                                                          }}"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,
                  striped <span class="op">=</span> <span class="cn">TRUE</span>,
                  highlight <span class="op">=</span> <span class="cn">TRUE</span>,
                  defaultPageSize <span class="op">=</span> <span class="fl">15</span><span class="op">)</span>
    <span class="op">}</span>
    
    
    <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"pptx"</span>,<span class="st">"docx"</span>, <span class="st">"pdf"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
      
      <span class="va">output_table</span> <span class="op">&lt;-</span> 
        <span class="va">data_to_plot</span> <span class="op">%&gt;%</span> 
        <span class="fu">janitor</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/janitor/man/adorn_totals.html">adorn_totals</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
        <span class="fu"><a href="https://hughjonesd.github.io/huxtable/reference/huxtable.html">huxtable</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
        <span class="fu"><a href="https://hughjonesd.github.io/huxtable/reference/set-multiple.html">set_all_padding</a></span><span class="op">(</span><span class="fl">0.5</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu"><a href="https://hughjonesd.github.io/huxtable/reference/merge_repeated_rows.html">merge_repeated_rows</a></span><span class="op">(</span>col <span class="op">=</span> <span class="st">"Admin level 1"</span><span class="op">)</span> <span class="op">%&gt;%</span> 
        <span class="fu"><a href="https://hughjonesd.github.io/huxtable/reference/themes.html">theme_blue</a></span><span class="op">(</span><span class="op">)</span>
      
    <span class="op">}</span>
    
    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">output_table</span><span class="op">)</span>
    
    
  <span class="op">}</span></code></pre></div>
</div>
<div id="active_contacts_today_text" class="section level2">
<h2 class="hasAnchor">
<a href="#active_contacts_today_text" class="anchor"></a>active_contacts_today_text</h2>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">active_contacts_today_text</span> <span class="op">&lt;-</span> 
  <span class="kw">function</span><span class="op">(</span><span class="va">contacts_df_long</span>, <span class="va">todays_date</span>, <span class="va">report_format</span> <span class="op">=</span> <span class="st">"shiny"</span><span class="op">)</span><span class="op">{</span>
    
    <span class="co">## filter out dates that are past the input days date ("future follow-up" rows)</span>
    <span class="va">contacts_df_long_filt</span> <span class="op">&lt;-</span> 
      <span class="va">contacts_df_long</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">follow_up_date</span> <span class="op">&lt;=</span> <span class="va">todays_date</span><span class="op">)</span>
    
    <span class="va">data_to_plot</span> <span class="op">&lt;-</span> 
      <span class="va">contacts_df_long</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">row_id</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="co"># slice long frame</span>
      <span class="fu">slice_head</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">admin_1</span>, <span class="va">admin_2</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu">count</span><span class="op">(</span><span class="va">admin_1</span>, <span class="va">admin_2</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">admin_1</span>, <span class="va">admin_2</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>percent <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fl">100</span> <span class="op">*</span> <span class="va">n</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">admin_1</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>admin_1_sum <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>admin_1_percent <span class="op">=</span> <span class="va">admin_1_sum</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">admin_1</span>, 
             <span class="va">admin_1_sum</span>,
             <span class="va">admin_1_percent</span>,
             <span class="va">admin_2</span>, 
             admin_2_sum <span class="op">=</span> <span class="va">n</span>,
             admin_2_percent <span class="op">=</span> <span class="va">percent</span><span class="op">)</span>
    
    <span class="va">admin_1_w_most_contacts</span> <span class="op">&lt;-</span> 
      <span class="va">data_to_plot</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="op">-</span><span class="va">admin_1_percent</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="va">.</span><span class="op">$</span><span class="va">admin_1</span> <span class="op">%&gt;%</span> <span class="va">.</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>
    
    <span class="va">n_contacts_in_admin_1_w_most_contacts</span> <span class="op">&lt;-</span> 
      <span class="va">data_to_plot</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="op">-</span><span class="va">admin_1_percent</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="va">.</span><span class="op">$</span><span class="va">admin_1_sum</span> <span class="op">%&gt;%</span> <span class="va">.</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>
    
    <span class="va">pct_contacts_in_admin_1_w_most_contacts</span> <span class="op">&lt;-</span> 
      <span class="va">data_to_plot</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="op">-</span><span class="va">admin_1_percent</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="va">.</span><span class="op">$</span><span class="va">admin_1_percent</span> <span class="op">%&gt;%</span> <span class="va">.</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">%&gt;%</span> 
      <span class="fu">magrittr</span><span class="fu">::</span><span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">multiply_by</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">.</span>, <span class="st">"%"</span><span class="op">)</span>
    
    
    <span class="va">info</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"&lt;br&gt;
            &lt;span style='color: rgb(97, 189, 109);'&gt;ℹ:&lt;/span&gt;
            &lt;font size='1'&gt;The table and plots show the count of contacts currently under follow-up. &lt;/font&gt;"</span><span class="op">)</span>
    
    <span class="va">str1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op">(</span><span class="st">"&lt;br&gt;The level 1 division with the most contacts under surveillance at present is &lt;b&gt; {admin_1_w_most_contacts}&lt;/b&gt;, 
                 with &lt;b&gt;{n_contacts_in_admin_1_w_most_contacts}&lt;/b&gt; contacts (&lt;b&gt;{pct_contacts_in_admin_1_w_most_contacts}&lt;/b&gt; of the total)"</span> <span class="op">)</span>
    
    
    <span class="va">output_text</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/htmltools/man/HTML.html">HTML</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">info</span>, <span class="va">str1</span>, sep <span class="op">=</span> <span class="st">'&lt;br/&gt;'</span><span class="op">)</span><span class="op">)</span>
    
    
    <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"pptx"</span>, <span class="st">"docx"</span>, <span class="st">"pdf"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
      <span class="va">output_text</span> <span class="op">%&gt;%</span>
        <span class="fu"><a href="https://rdrr.io/r/base/rawConversion.html">charToRaw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu"><a href="http://xml2.r-lib.org/reference/read_xml.html">read_html</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu"><a href="https://rvest.tidyverse.org/reference/html_text.html">html_text2</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu">str_trim</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu">pander</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pander/man/pandoc.p.return.html">pandoc.p</a></span><span class="op">(</span><span class="op">)</span>
      <span class="co"># no need to return anything. pandoc.p prints automatically</span>
    <span class="op">}</span>
    
    <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"shiny"</span>, <span class="st">"html (page)"</span>, <span class="st">"html (slides)"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
      <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">output_text</span><span class="op">)</span>
    <span class="op">}</span>
    
    
  <span class="op">}</span></code></pre></div>
</div>
</div>
<div id="active_contacts_historical" class="section level1">
<h1 class="hasAnchor">
<a href="#active_contacts_historical" class="anchor"></a>active_contacts_historical</h1>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<span class="co"># ~ active_contacts_historical  -----------</span>
<span class="co"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></code></pre></div>
<p>Functions showing how many contacts were under surveillance at each time point, segregated by region. ## active_contacts_historical_row_title</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">active_contacts_historical_row_title</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">report_format</span> <span class="op">=</span> <span class="st">"shiny"</span><span class="op">)</span><span class="op">{</span>
  <span class="co">## doesn't need to a function at the moment. </span>
  <span class="co">## But we leave it there in case we want to take in an input or two</span>
  
  <span class="va">output_text</span> <span class="op">&lt;-</span> <span class="st">"Contacts under surveillance, trend over time"</span>
    
  <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"pptx"</span>, <span class="st">"docx"</span>, <span class="st">"pdf"</span>, <span class="st">"html (page)"</span>, <span class="st">"html (slides)"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">output_text</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://rdrr.io/r/base/rawConversion.html">charToRaw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="http://xml2.r-lib.org/reference/read_xml.html">read_html</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://rvest.tidyverse.org/reference/html_text.html">html_text2</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu">str_trim</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu">pander</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pander/man/pandoc.header.return.html">pandoc.header</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>
    <span class="co"># no need to return anything. pandoc.p prints automatically</span>
  <span class="op">}</span>
  
  <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"shiny"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/htmltools/man/builder.html">h3</a></span><span class="op">(</span><span class="va">output_text</span>,
              style <span class="op">=</span> <span class="st">"display: inline;"</span><span class="op">)</span> <span class="op">)</span>
  <span class="op">}</span>
  
  
<span class="op">}</span></code></pre></div>
<div id="active_contacts_historical_bar_chart" class="section level2">
<h2 class="hasAnchor">
<a href="#active_contacts_historical_bar_chart" class="anchor"></a>active_contacts_historical_bar_chart</h2>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">active_contacts_historical_bar_chart</span> <span class="op">&lt;-</span> 
  <span class="kw">function</span><span class="op">(</span><span class="va">contacts_df_long</span>, <span class="va">todays_date</span>, <span class="va">report_format</span> <span class="op">=</span> <span class="st">"shiny"</span><span class="op">)</span><span class="op">{</span>
    
   <span class="co">## filter out dates that are past the input days date ("future follow-up" rows)</span>
    <span class="va">contacts_df_long_filt</span> <span class="op">&lt;-</span> 
      <span class="va">contacts_df_long</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">follow_up_date</span> <span class="op">&lt;=</span> <span class="va">todays_date</span><span class="op">)</span>
    
    <span class="va">data_to_plot</span> <span class="op">&lt;-</span> 
      <span class="va">contacts_df_long_filt</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">admin_1</span>, <span class="va">follow_up_date</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">follow_up_date</span>, <span class="va">admin_1</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">count</span><span class="op">(</span><span class="va">admin_1</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">admin_1</span>, <span class="va">follow_up_date</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">bind_rows</span><span class="op">(</span><span class="fu">tibble</span><span class="op">(</span>follow_up_date <span class="op">=</span>  <span class="fu"><a href="https://rdrr.io/r/base/seq.Date.html">seq.Date</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">.</span><span class="op">$</span><span class="va">follow_up_date</span><span class="op">)</span>, 
                                                  to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">.</span><span class="op">$</span><span class="va">follow_up_date</span><span class="op">)</span>, 
                                                  by <span class="op">=</span> <span class="st">"day"</span><span class="op">)</span>, 
                       admin_1 <span class="op">=</span> <span class="st">"temporary"</span>
      <span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">complete</span><span class="op">(</span><span class="va">follow_up_date</span>, <span class="va">admin_1</span>, fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">admin_1</span> <span class="op">!=</span> <span class="st">"temporary"</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="co"># admin_1 with the most cases should be at the top</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">admin_1</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>total <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>admin_1 <span class="op">=</span> <span class="fu">fct_rev</span><span class="op">(</span><span class="fu">fct_reorder</span><span class="op">(</span><span class="va">admin_1</span>, <span class="va">total</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
    
    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data_to_plot</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span>
      <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="http://jkunst.com/highcharter/reference/highchart.html">highchart</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_title.html">hc_title</a></span><span class="op">(</span>text  <span class="op">=</span> <span class="st">"No data to plot"</span><span class="op">)</span><span class="op">)</span>
    <span class="op">}</span>
    
    <span class="va">output_highchart</span> <span class="op">&lt;-</span> 
      <span class="va">data_to_plot</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hchart.html">hchart</a></span><span class="op">(</span><span class="st">"column"</span>, <span class="fu"><a href="http://jkunst.com/highcharter/reference/hcaes.html">hcaes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">follow_up_date</span>, y <span class="op">=</span> <span class="va">n</span>, group <span class="op">=</span> <span class="va">admin_1</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_yAxis.html">hc_yAxis</a></span><span class="op">(</span>visible <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_plotOptions.html">hc_plotOptions</a></span><span class="op">(</span>column <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>stacking <span class="op">=</span> <span class="st">"normal"</span>, 
                                   pointPadding <span class="op">=</span> <span class="fl">0</span>, 
                                   groupPadding <span class="op">=</span> <span class="fl">0</span>, 
                                   borderWidth<span class="op">=</span> <span class="fl">0.05</span>,
                                   stickyTracking <span class="op">=</span> <span class="cn">T</span>
      <span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_plotOptions.html">hc_plotOptions</a></span><span class="op">(</span>column <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>states <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>inactive <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>opacity <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_xAxis.html">hc_xAxis</a></span><span class="op">(</span>title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>text <span class="op">=</span> <span class="st">"Date"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_yAxis.html">hc_yAxis</a></span><span class="op">(</span>title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>text <span class="op">=</span> <span class="st">"No of contacts that were under surveillance"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_exporting.html">hc_exporting</a></span><span class="op">(</span>enabled <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
    
    
    <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"pptx"</span>, <span class="st">"docx"</span>, <span class="st">"pdf"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
      
      <span class="va">output_highchart</span> <span class="op">&lt;-</span>
        <span class="va">output_highchart</span> <span class="op">%&gt;%</span> 
        <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_exporting.html">hc_exporting</a></span><span class="op">(</span>enabled <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_plotOptions.html">hc_plotOptions</a></span><span class="op">(</span>series <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>animation <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
        <span class="fu">html_webshot</span><span class="op">(</span><span class="op">)</span>
      <span class="co"># no need to return anything. html_webshot prints automatically</span>
    <span class="op">}</span>
    
    <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"html (page)"</span>, <span class="st">"html (slides)"</span>, <span class="st">"shiny"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
      
      <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">output_highchart</span><span class="op">)</span>
      
    <span class="op">}</span>

  <span class="op">}</span></code></pre></div>
</div>
<div id="active_contacts_historical_bar_chart_relative" class="section level2">
<h2 class="hasAnchor">
<a href="#active_contacts_historical_bar_chart_relative" class="anchor"></a>active_contacts_historical_bar_chart_relative</h2>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">active_contacts_historical_bar_chart_relative</span> <span class="op">&lt;-</span> 
  <span class="kw">function</span><span class="op">(</span><span class="va">contacts_df_long</span>, <span class="va">todays_date</span>, <span class="va">report_format</span> <span class="op">=</span> <span class="st">"shiny"</span><span class="op">)</span><span class="op">{</span>
    
   <span class="co">## filter out dates that are past the input days date ("future follow-up" rows)</span>
    <span class="va">contacts_df_long_filt</span> <span class="op">&lt;-</span> 
      <span class="va">contacts_df_long</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">follow_up_date</span> <span class="op">&lt;=</span> <span class="va">todays_date</span> <span class="op">)</span>
    
    <span class="va">data_to_plot</span> <span class="op">&lt;-</span> 
      <span class="va">contacts_df_long_filt</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">admin_1</span>, <span class="va">follow_up_date</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">follow_up_date</span>, <span class="va">admin_1</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">count</span><span class="op">(</span><span class="va">admin_1</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">follow_up_date</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>prop <span class="op">=</span> <span class="va">n</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>prop <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">prop</span>, digits <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">admin_1</span>, <span class="va">follow_up_date</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">bind_rows</span><span class="op">(</span><span class="fu">tibble</span><span class="op">(</span>follow_up_date <span class="op">=</span>  <span class="fu"><a href="https://rdrr.io/r/base/seq.Date.html">seq.Date</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">.</span><span class="op">$</span><span class="va">follow_up_date</span><span class="op">)</span>, 
                                                  to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">.</span><span class="op">$</span><span class="va">follow_up_date</span><span class="op">)</span>, 
                                                  by <span class="op">=</span> <span class="st">"day"</span><span class="op">)</span>, 
                       admin_1 <span class="op">=</span> <span class="st">"temporary"</span>
      <span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">complete</span><span class="op">(</span><span class="va">follow_up_date</span>, <span class="va">admin_1</span>, fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">0</span>, prop <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">admin_1</span> <span class="op">!=</span> <span class="st">"temporary"</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="co"># admin_1 with the most cases should be at the top</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">admin_1</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>total <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>admin_1 <span class="op">=</span> <span class="fu">fct_rev</span><span class="op">(</span><span class="fu">fct_reorder</span><span class="op">(</span><span class="va">admin_1</span>, <span class="va">total</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
    
    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data_to_plot</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span>
      <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="http://jkunst.com/highcharter/reference/highchart.html">highchart</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_title.html">hc_title</a></span><span class="op">(</span>text  <span class="op">=</span> <span class="st">"No data to plot"</span><span class="op">)</span><span class="op">)</span>
    <span class="op">}</span>
    
    <span class="va">output_highchart</span> <span class="op">&lt;-</span> 
      <span class="va">data_to_plot</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hchart.html">hchart</a></span><span class="op">(</span><span class="st">"column"</span>, <span class="fu"><a href="http://jkunst.com/highcharter/reference/hcaes.html">hcaes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">follow_up_date</span>, y <span class="op">=</span> <span class="va">prop</span>, group <span class="op">=</span> <span class="va">admin_1</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_yAxis.html">hc_yAxis</a></span><span class="op">(</span>visible <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_plotOptions.html">hc_plotOptions</a></span><span class="op">(</span>column <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>stacking <span class="op">=</span> <span class="st">"normal"</span>, 
                                   pointPadding <span class="op">=</span> <span class="fl">0</span>, 
                                   groupPadding <span class="op">=</span> <span class="fl">0</span>, 
                                   borderWidth<span class="op">=</span> <span class="fl">0.05</span>,
                                   stickyTracking <span class="op">=</span> <span class="cn">T</span>
      <span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_plotOptions.html">hc_plotOptions</a></span><span class="op">(</span>column <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>states <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>inactive <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>opacity <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_xAxis.html">hc_xAxis</a></span><span class="op">(</span>title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>text <span class="op">=</span> <span class="st">"Date"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_yAxis.html">hc_yAxis</a></span><span class="op">(</span>title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>text <span class="op">=</span> <span class="st">"% of all contacts that were under surveillance"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_exporting.html">hc_exporting</a></span><span class="op">(</span>enabled <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
    
    
    <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"pptx"</span>, <span class="st">"docx"</span>, <span class="st">"pdf"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>

      <span class="va">output_highchart</span> <span class="op">&lt;-</span>
        <span class="va">output_highchart</span> <span class="op">%&gt;%</span> 
        <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_exporting.html">hc_exporting</a></span><span class="op">(</span>enabled <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_plotOptions.html">hc_plotOptions</a></span><span class="op">(</span>series <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>animation <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
        <span class="fu">html_webshot</span><span class="op">(</span><span class="op">)</span>
      <span class="co"># no need to return anything. html_webshot prints automatically</span>
    <span class="op">}</span>
    
    <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"html (page)"</span>, <span class="st">"html (slides)"</span>, <span class="st">"shiny"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
      
      <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">output_highchart</span><span class="op">)</span>
      
    <span class="op">}</span>
    
  <span class="op">}</span></code></pre></div>
</div>
<div id="active_contacts_historical_text" class="section level2">
<h2 class="hasAnchor">
<a href="#active_contacts_historical_text" class="anchor"></a>active_contacts_historical_text</h2>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">active_contacts_historical_text</span> <span class="op">&lt;-</span> 
  <span class="kw">function</span><span class="op">(</span><span class="va">contacts_df_long</span>, <span class="va">todays_date</span>, <span class="va">report_format</span> <span class="op">=</span> <span class="st">"shiny"</span><span class="op">)</span><span class="op">{</span>
    
   <span class="co">## filter out dates that are past the input days date ("future follow-up" rows)</span>
    <span class="va">contacts_df_long_filt</span> <span class="op">&lt;-</span> 
      <span class="va">contacts_df_long</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">follow_up_date</span> <span class="op">&lt;=</span> <span class="va">todays_date</span><span class="op">)</span>
    
    
    <span class="va">data_to_plot</span> <span class="op">&lt;-</span> 
      <span class="va">contacts_df_long_filt</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">admin_1</span>, <span class="va">follow_up_date</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">follow_up_date</span>, <span class="va">admin_1</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">count</span><span class="op">(</span><span class="va">admin_1</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">admin_1</span>, <span class="va">follow_up_date</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">bind_rows</span><span class="op">(</span><span class="fu">tibble</span><span class="op">(</span>follow_up_date <span class="op">=</span>  <span class="fu"><a href="https://rdrr.io/r/base/seq.Date.html">seq.Date</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">.</span><span class="op">$</span><span class="va">follow_up_date</span><span class="op">)</span>, 
                                                  to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">.</span><span class="op">$</span><span class="va">follow_up_date</span><span class="op">)</span>, 
                                                  by <span class="op">=</span> <span class="st">"day"</span><span class="op">)</span>, 
                       admin_1 <span class="op">=</span> <span class="st">"temporary"</span>
      <span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">complete</span><span class="op">(</span><span class="va">follow_up_date</span>, <span class="va">admin_1</span>, fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">admin_1</span> <span class="op">!=</span> <span class="st">"temporary"</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="co"># admin_1 with the most cases should be at the top</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">admin_1</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>total <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>admin_1 <span class="op">=</span> <span class="fu">fct_rev</span><span class="op">(</span><span class="fu">fct_reorder</span><span class="op">(</span><span class="va">admin_1</span>, <span class="va">total</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
    
    
    <span class="va">max_n_under_surveillance</span> <span class="op">&lt;-</span> 
      <span class="va">data_to_plot</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">follow_up_date</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>total_that_day <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">slice_head</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="op">-</span><span class="va">total_that_day</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="va">.</span><span class="op">$</span><span class="va">total_that_day</span> <span class="op">%&gt;%</span> 
      <span class="va">.</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>
    
    <span class="va">date_of_max_n_under_surveillance</span> <span class="op">&lt;-</span> 
      <span class="va">data_to_plot</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">follow_up_date</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>total_that_day <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">slice_head</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="op">-</span><span class="va">total_that_day</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="va">.</span><span class="op">$</span><span class="va">follow_up_date</span> <span class="op">%&gt;%</span> 
      <span class="va">.</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>  <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">format.Date</a></span><span class="op">(</span><span class="st">"%b %d, %Y"</span><span class="op">)</span>
      
    
    
    <span class="va">info</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"&lt;br&gt;
            &lt;span style='color: rgb(97, 189, 109);'&gt;ℹ:&lt;/span&gt;
            &lt;font size='1'&gt;
            The plots show the number of contacts under surveillance on each day, whether or not they were successfully contacted.
            &lt;/font&gt;"</span><span class="op">)</span>
    <span class="va">str1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op">(</span><span class="st">"&lt;br&gt;The day on which the highest number contacts were under surveillance was &lt;b&gt;{date_of_max_n_under_surveillance}&lt;/b&gt;, 
                 with &lt;b&gt;{max_n_under_surveillance}&lt;/b&gt; contacts under surveillance."</span> <span class="op">)</span>

    <span class="va">output_text</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/htmltools/man/HTML.html">HTML</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">info</span>, <span class="va">str1</span>, sep <span class="op">=</span> <span class="st">'&lt;br/&gt;'</span><span class="op">)</span><span class="op">)</span>
    
    <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"pptx"</span>,<span class="st">"docx"</span>, <span class="st">"pdf"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
      
      <span class="va">output_text</span> <span class="op">&lt;-</span> 
        <span class="va">output_text</span> <span class="op">%&gt;%</span> 
        <span class="fu"><a href="https://rdrr.io/r/base/rawConversion.html">charToRaw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
        <span class="fu"><a href="http://xml2.r-lib.org/reference/read_xml.html">read_html</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
        <span class="fu"><a href="https://rvest.tidyverse.org/reference/html_text.html">html_text2</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
        <span class="fu">str_trim</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
        <span class="fu">pander</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pander/man/pandoc.p.return.html">pandoc.p</a></span><span class="op">(</span><span class="op">)</span>
      <span class="co"># no need to return anything. pandoc.p prints automatically</span>
    <span class="op">}</span>
    
    <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"shiny"</span>, <span class="st">"html (page)"</span>, <span class="st">"html (slides)"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
      <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">output_text</span><span class="op">)</span>
    <span class="op">}</span>
    
    
  <span class="op">}</span></code></pre></div>
</div>
</div>
<div id="contacts_per_case" class="section level1">
<h1 class="hasAnchor">
<a href="#contacts_per_case" class="anchor"></a>contacts_per_case</h1>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<span class="co"># ~ contacts_per_case  -----------</span>
<span class="co"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></code></pre></div>
<p>Functions that output the number of contacts linked to each case At the moment (May 13, 2021), the Go.Data app version has no information for this column. ## total_contacts_per_case_donut_plot</p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">total_contacts_per_case_donut_plot</span> <span class="op">&lt;-</span> 
  <span class="kw">function</span><span class="op">(</span><span class="va">contacts_df_long</span>, <span class="va">report_format</span> <span class="op">=</span> <span class="st">"shiny"</span><span class="op">)</span><span class="op">{</span>
    
    
    <span class="va">data_to_plot</span> <span class="op">&lt;-</span> 
      <span class="va">contacts_df_long</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">row_id</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="co"># slice long frame</span>
      <span class="fu">slice_head</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="co"># count cases per linked_case_id</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">linked_case_id</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>linked_case_id <span class="op">=</span> <span class="fu">fct_lump_n</span><span class="op">(</span><span class="va">linked_case_id</span>, <span class="fl">20</span>, ties.method <span class="op">=</span> <span class="st">"first"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">count</span><span class="op">(</span><span class="va">linked_case_id</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="op">-</span><span class="va">n</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">linked_case_id</span> <span class="op">==</span> <span class="st">"Other"</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>hc_label <span class="op">=</span> <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op">(</span><span class="st">"{linked_case_id}: {n}"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>`Case ID` <span class="op">=</span> <span class="va">linked_case_id</span>,
             `Total linked contacts` <span class="op">=</span> <span class="va">n</span><span class="op">)</span>
    
    
    <span class="va">color_df</span> <span class="op">&lt;-</span> 
      <span class="fu">tibble</span><span class="op">(</span>`Case ID` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">data_to_plot</span><span class="op">$</span><span class="va">`Case ID`</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">add_column</span><span class="op">(</span>color_lvl_1 <span class="op">=</span> <span class="va">highcharter_palette</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>
    
    <span class="va">number_of_cases</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data_to_plot</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span>
    
    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data_to_plot</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span>
      <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="http://jkunst.com/highcharter/reference/highchart.html">highchart</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_title.html">hc_title</a></span><span class="op">(</span>text  <span class="op">=</span> <span class="st">"No data to plot"</span><span class="op">)</span><span class="op">)</span>
    <span class="op">}</span>
    
    
    <span class="va">output_highchart</span> <span class="op">&lt;-</span> 
      <span class="va">data_to_plot</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">`Case ID`</span> <span class="op">!=</span> <span class="st">"Other"</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co">## Franck's orders</span>
      <span class="fu">left_join</span><span class="op">(</span><span class="va">color_df</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hchart.html">hchart</a></span><span class="op">(</span><span class="st">"pie"</span>, <span class="fu"><a href="http://jkunst.com/highcharter/reference/hcaes.html">hcaes</a></span><span class="op">(</span>name <span class="op">=</span> <span class="va">`Case ID`</span> ,
                             y <span class="op">=</span> <span class="va">`Total linked contacts`</span>, 
                             color <span class="op">=</span> <span class="va">color_lvl_1</span><span class="op">)</span>,
             name <span class="op">=</span> <span class="st">"n "</span>,
             showInLegend <span class="op">=</span> <span class="cn">TRUE</span>,
             dataLabels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>enabled <span class="op">=</span> <span class="cn">TRUE</span>,
                               style <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>fontSize <span class="op">=</span> <span class="fl">12</span>, lineHeight <span class="op">=</span> <span class="fl">15</span><span class="op">)</span>,
                               format <span class="op">=</span> <span class="st">'{point.hc_label}'</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_exporting.html">hc_exporting</a></span><span class="op">(</span>enabled <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_xAxis.html">hc_xAxis</a></span><span class="op">(</span>categories <span class="op">=</span> <span class="va">data_to_plot</span><span class="op">$</span><span class="va">`Case ID`</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_subtitle.html">hc_subtitle</a></span><span class="op">(</span>text <span class="op">=</span> <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op">(</span><span class="st">"Contacts per case for the &lt;b&gt;{number_of_cases}&lt;/b&gt; 
                              cases with the most contacts"</span><span class="op">)</span>, 
                  useHTML <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_legend.html">hc_legend</a></span><span class="op">(</span>enabled <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
    
    
    
    <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"pptx"</span>, <span class="st">"docx"</span>, <span class="st">"pdf"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
      
      <span class="va">output_highchart</span> <span class="op">&lt;-</span>
        <span class="va">output_highchart</span> <span class="op">%&gt;%</span> 
        <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_exporting.html">hc_exporting</a></span><span class="op">(</span>enabled <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_plotOptions.html">hc_plotOptions</a></span><span class="op">(</span>series <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>animation <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
        <span class="fu">html_webshot</span><span class="op">(</span><span class="op">)</span>
      <span class="co"># no need to return anything. html_webshot prints automatically</span>
    <span class="op">}</span>
    
    <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"html (page)"</span>, <span class="st">"html (slides)"</span>, <span class="st">"shiny"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
      
      <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">output_highchart</span><span class="op">)</span>
      
    <span class="op">}</span>
    
    
  <span class="op">}</span></code></pre></div>
<div id="total_contacts_per_case_table" class="section level2">
<h2 class="hasAnchor">
<a href="#total_contacts_per_case_table" class="anchor"></a>total_contacts_per_case_table</h2>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">total_contacts_per_case_table</span> <span class="op">&lt;-</span> 
  <span class="kw">function</span><span class="op">(</span><span class="va">contacts_df_long</span>, <span class="va">report_format</span> <span class="op">=</span> <span class="st">"shiny"</span><span class="op">)</span><span class="op">{</span>
    
    <span class="va">data_to_plot</span> <span class="op">&lt;-</span> 
      <span class="va">contacts_df_long</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">row_id</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="co"># slice long frame</span>
      <span class="fu">slice_head</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="co"># count cases per linked_case_id</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">linked_case_id</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>linked_case_id <span class="op">=</span> <span class="fu">fct_lump_n</span><span class="op">(</span><span class="va">linked_case_id</span>, <span class="fl">20</span>, ties.method <span class="op">=</span> <span class="st">"first"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">count</span><span class="op">(</span><span class="va">linked_case_id</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="op">-</span><span class="va">n</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">linked_case_id</span> <span class="op">==</span> <span class="st">"Other"</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>`Case ID` <span class="op">=</span> <span class="va">linked_case_id</span>,
             `Total linked contacts` <span class="op">=</span> <span class="va">n</span><span class="op">)</span>
    
    <span class="va">number_of_cases</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data_to_plot</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span>
    <span class="va">table_title</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/htmltools/man/HTML.html">HTML</a></span><span class="op">(</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op">(</span><span class="st">"Contacts per case for the {number_of_cases} 
                              cases with the most contacts"</span><span class="op">)</span><span class="op">)</span>

    
    <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"shiny"</span>,<span class="st">"html (page)"</span>, <span class="st">"html (slides)"</span>, <span class="st">"pdf"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
      
      <span class="va">output_table</span> <span class="op">&lt;-</span>  
        <span class="va">data_to_plot</span> <span class="op">%&gt;%</span>
        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">`Case ID`</span> <span class="op">!=</span> <span class="st">"Other"</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co">## Franck's orders</span>
        <span class="fu"><a href="https://glin.github.io/reactable/reference/reactable.html">reactable</a></span><span class="op">(</span>
          columns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
            `Total linked contacts` <span class="op">=</span> <span class="fu"><a href="https://glin.github.io/reactable/reference/colDef.html">colDef</a></span><span class="op">(</span>cell <span class="op">=</span> <span class="fu"><a href="https://kcuilla.github.io/reactablefmtr/reference/data_bars_gradient.html">data_bars_gradient</a></span><span class="op">(</span><span class="va">data_to_plot</span>,
                                                                       colors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">peach</span>, <span class="va">bright_yellow_crayola</span><span class="op">)</span>,
                                                                       background <span class="op">=</span> <span class="st">"transparent"</span><span class="op">)</span>,
                                             style <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>fontFamily <span class="op">=</span> <span class="st">"Courier"</span>,
                                                          whiteSpace <span class="op">=</span> <span class="st">"pre"</span>,
                                                          fontSize <span class="op">=</span> <span class="fl">13</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,
          striped <span class="op">=</span> <span class="cn">TRUE</span>,
          highlight <span class="op">=</span> <span class="cn">TRUE</span>,
          defaultPageSize <span class="op">=</span> <span class="fl">15</span><span class="op">)</span>
      
      <span class="va">output_table</span> <span class="op">&lt;-</span> 
        <span class="fu"><a href="https://rdrr.io/pkg/htmltools/man/tag.html">tagList</a></span><span class="op">(</span>
          <span class="fu"><a href="https://rdrr.io/pkg/htmltools/man/builder.html">div</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/htmltools/man/builder.html">h5</a></span><span class="op">(</span><span class="va">table_title</span><span class="op">)</span>,  style <span class="op">=</span> <span class="st">"text-align: center; font-weight: bold"</span><span class="op">)</span>,
          <span class="va">output_table</span><span class="op">)</span>
    <span class="op">}</span>
    
    
    <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"pptx"</span>,<span class="st">"docx"</span>, <span class="st">"pdf"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
      
      <span class="va">output_table</span> <span class="op">&lt;-</span> 
        <span class="va">data_to_plot</span> <span class="op">%&gt;%</span>
        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">`Case ID`</span> <span class="op">!=</span> <span class="st">"Other"</span><span class="op">)</span> <span class="op">%&gt;%</span> 
        <span class="fu"><a href="https://hughjonesd.github.io/huxtable/reference/huxtable.html">huxtable</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
        <span class="fu"><a href="https://hughjonesd.github.io/huxtable/reference/set-multiple.html">set_all_padding</a></span><span class="op">(</span><span class="fl">0.5</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu"><a href="https://hughjonesd.github.io/huxtable/reference/themes.html">theme_blue</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
        <span class="fu">huxtable</span><span class="fu">::</span><span class="fu"><a href="https://hughjonesd.github.io/huxtable/reference/caption.html">set_caption</a></span><span class="op">(</span><span class="va">table_title</span><span class="op">)</span>
      
      
    <span class="op">}</span>
    
    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">output_table</span><span class="op">)</span>
    
  <span class="op">}</span></code></pre></div>
</div>
<div id="total_contacts_per_case_bar_chart" class="section level2">
<h2 class="hasAnchor">
<a href="#total_contacts_per_case_bar_chart" class="anchor"></a>total_contacts_per_case_bar_chart</h2>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">total_contacts_per_case_bar_chart</span> <span class="op">&lt;-</span> 
  <span class="kw">function</span><span class="op">(</span><span class="va">contacts_df_long</span>, <span class="va">report_format</span> <span class="op">=</span> <span class="st">"shiny"</span><span class="op">)</span><span class="op">{</span>
    
    <span class="va">data_to_plot</span> <span class="op">&lt;-</span> 
      <span class="va">contacts_df_long</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">row_id</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="co"># slice long frame</span>
      <span class="fu">slice_head</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="co"># count cases per id</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">linked_case_id</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>linked_case_id <span class="op">=</span> <span class="fu">fct_lump_n</span><span class="op">(</span><span class="va">linked_case_id</span>, <span class="fl">20</span>, ties.method <span class="op">=</span> <span class="st">"first"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">count</span><span class="op">(</span><span class="va">linked_case_id</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>pct <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fl">100</span> <span class="op">*</span> <span class="va">n</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>hc_label <span class="op">=</span> <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op">(</span><span class="st">"{n}"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="op">-</span><span class="va">n</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">linked_case_id</span> <span class="op">==</span> <span class="st">"Other"</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>`Case ID` <span class="op">=</span> <span class="va">linked_case_id</span>,
             `Total linked contacts` <span class="op">=</span> <span class="va">n</span><span class="op">)</span>
    
    <span class="va">color_df</span> <span class="op">&lt;-</span> 
      <span class="fu">tibble</span><span class="op">(</span>`Case ID` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">data_to_plot</span><span class="op">$</span><span class="va">`Case ID`</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">add_column</span><span class="op">(</span>color_lvl_1 <span class="op">=</span> <span class="va">highcharter_palette</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>
    
    <span class="va">number_of_cases</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data_to_plot</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span>
    
    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data_to_plot</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span>
      <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="http://jkunst.com/highcharter/reference/highchart.html">highchart</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_title.html">hc_title</a></span><span class="op">(</span>text  <span class="op">=</span> <span class="st">"No data to plot"</span><span class="op">)</span><span class="op">)</span>
    <span class="op">}</span>
    
    
    <span class="va">output_highchart</span> <span class="op">&lt;-</span> 
      <span class="va">data_to_plot</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">`Case ID`</span> <span class="op">!=</span> <span class="st">"Other"</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co">## Franck's orders</span>
      <span class="fu">left_join</span><span class="op">(</span><span class="va">color_df</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hchart.html">hchart</a></span><span class="op">(</span><span class="st">"column"</span>, <span class="fu"><a href="http://jkunst.com/highcharter/reference/hcaes.html">hcaes</a></span><span class="op">(</span>name <span class="op">=</span> <span class="va">`Case ID`</span> ,
                             y <span class="op">=</span> <span class="va">`Total linked contacts`</span>, 
                             color <span class="op">=</span> <span class="va">color_lvl_1</span><span class="op">)</span>,
             name <span class="op">=</span> <span class="st">"n "</span>,
             showInLegend <span class="op">=</span> <span class="cn">TRUE</span>,
             dataLabels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>enabled <span class="op">=</span> <span class="cn">TRUE</span>,
                               style <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>fontSize <span class="op">=</span> <span class="fl">12</span>, lineHeight <span class="op">=</span> <span class="fl">15</span><span class="op">)</span>,
                               format <span class="op">=</span> <span class="st">'{point.hc_label}'</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_exporting.html">hc_exporting</a></span><span class="op">(</span>enabled <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_xAxis.html">hc_xAxis</a></span><span class="op">(</span>categories <span class="op">=</span> <span class="va">data_to_plot</span><span class="op">$</span><span class="va">`Case ID`</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_subtitle.html">hc_subtitle</a></span><span class="op">(</span>text <span class="op">=</span> <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op">(</span><span class="st">"Contacts per case for the &lt;b&gt;{number_of_cases}&lt;/b&gt; 
                              cases with the most contacts"</span><span class="op">)</span>, 
                  useHTML <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_legend.html">hc_legend</a></span><span class="op">(</span>enabled <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
    
    
    
    <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"pptx"</span>, <span class="st">"docx"</span>, <span class="st">"pdf"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>

      <span class="va">output_highchart</span> <span class="op">&lt;-</span>
        <span class="va">output_highchart</span> <span class="op">%&gt;%</span> 
        <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_exporting.html">hc_exporting</a></span><span class="op">(</span>enabled <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_plotOptions.html">hc_plotOptions</a></span><span class="op">(</span>series <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>animation <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
        <span class="fu">html_webshot</span><span class="op">(</span><span class="op">)</span>
      <span class="co"># no need to return anything. html_webshot prints automatically</span>
    <span class="op">}</span>
    
    <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"html (page)"</span>, <span class="st">"html (slides)"</span>, <span class="st">"shiny"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
      
      <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">output_highchart</span><span class="op">)</span>
      
    <span class="op">}</span>
    
  <span class="op">}</span></code></pre></div>
</div>
<div id="total_contacts_per_case_text" class="section level2">
<h2 class="hasAnchor">
<a href="#total_contacts_per_case_text" class="anchor"></a>total_contacts_per_case_text</h2>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">total_contacts_per_case_text</span> <span class="op">&lt;-</span> 
  <span class="kw">function</span><span class="op">(</span><span class="va">contacts_df_long</span>, <span class="va">report_format</span> <span class="op">=</span> <span class="st">"shiny"</span><span class="op">)</span><span class="op">{</span>

    <span class="va">data_to_plot</span> <span class="op">&lt;-</span> 
      <span class="va">contacts_df_long</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">row_id</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="co"># slice long frame</span>
      <span class="fu">slice_head</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="co"># count cases per linked_case_id</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">linked_case_id</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">count</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="op">-</span><span class="va">n</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span>`Case ID` <span class="op">=</span> <span class="va">linked_case_id</span>, 
             `Total linked contacts` <span class="op">=</span> <span class="va">n</span>
      <span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span>
    
    <span class="va">median_number_of_contacts_per_case</span> <span class="op">&lt;-</span> 
      <span class="va">data_to_plot</span><span class="op">$</span><span class="va">`Total linked contacts`</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span><span class="op">(</span><span class="op">)</span>
    
    <span class="va">iqr_number_of_contacts_per_case</span> <span class="op">&lt;-</span> 
      <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">data_to_plot</span><span class="op">$</span><span class="va">`Total linked contacts`</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="fl">1</span><span class="op">)</span>, 
             <span class="st">"-"</span>,
             <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">data_to_plot</span><span class="op">$</span><span class="va">`Total linked contacts`</span> <span class="op">)</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span>, <span class="fl">1</span><span class="op">)</span> <span class="op">)</span>
    
    <span class="va">min_number_of_contacts_per_case</span> <span class="op">&lt;-</span> 
      <span class="va">data_to_plot</span><span class="op">$</span><span class="va">`Total linked contacts`</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="op">)</span>
    
    <span class="va">max_number_of_contacts_per_case</span> <span class="op">&lt;-</span> 
      <span class="va">data_to_plot</span><span class="op">$</span><span class="va">`Total linked contacts`</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="op">)</span>
    
    
    
    <span class="va">info</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"&lt;br&gt;
            &lt;span style='color: rgb(97, 189, 109);'&gt;ℹ:&lt;/span&gt;
            &lt;font size='1'&gt;
            The plots show the number of contacts linked to each case.
            &lt;/font&gt;"</span><span class="op">)</span>

    <span class="va">str1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op">(</span><span class="st">"&lt;br&gt;The &lt;b&gt;median&lt;/b&gt; number of contacts per case is &lt;b&gt;{median_number_of_contacts_per_case}&lt;/b&gt;, (&lt;b&gt;IQR:{iqr_number_of_contacts_per_case}&lt;/b&gt;) 
                 with a &lt;b&gt;minimum&lt;/b&gt; of &lt;b&gt;{min_number_of_contacts_per_case}&lt;/b&gt; and a maximum of &lt;b&gt;{max_number_of_contacts_per_case}&lt;/b&gt;"</span> <span class="op">)</span>

    <span class="va">output_text</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/htmltools/man/HTML.html">HTML</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">info</span>, <span class="va">str1</span>, sep <span class="op">=</span> <span class="st">'&lt;br/&gt;'</span><span class="op">)</span><span class="op">)</span>
    
    
    <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"pptx"</span>,<span class="st">"docx"</span>, <span class="st">"pdf"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
      
      <span class="va">output_text</span> <span class="op">&lt;-</span> 
        <span class="va">output_text</span> <span class="op">%&gt;%</span> 
        <span class="fu"><a href="https://rdrr.io/r/base/rawConversion.html">charToRaw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
        <span class="fu"><a href="http://xml2.r-lib.org/reference/read_xml.html">read_html</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
        <span class="fu"><a href="https://rvest.tidyverse.org/reference/html_text.html">html_text2</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
        <span class="fu">str_trim</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
        <span class="fu">pander</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pander/man/pandoc.p.return.html">pandoc.p</a></span><span class="op">(</span><span class="op">)</span>
      <span class="co"># no need to return anything. pandoc.p prints automatically</span>
    <span class="op">}</span>
    
    <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"shiny"</span>, <span class="st">"html (page)"</span>, <span class="st">"html (slides)"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
      <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">output_text</span><span class="op">)</span>
    <span class="op">}</span>
    
  <span class="op">}</span></code></pre></div>
</div>
</div>
<div id="contacts_per_link_type" class="section level1">
<h1 class="hasAnchor">
<a href="#contacts_per_link_type" class="anchor"></a>contacts_per_link_type</h1>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<span class="co"># ~ contacts_per_link_type  -----------</span>
<span class="co"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></code></pre></div>
<p>Functions that output the number of contacts for each type of link (e.g. family) At the moment (May 13, 2021), the Go.Data app version has no information for this column. ## total_contacts_per_link_type_donut_plot</p>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">total_contacts_per_link_type_donut_plot</span> <span class="op">&lt;-</span> 
  <span class="kw">function</span><span class="op">(</span><span class="va">contacts_df_long</span>, <span class="va">report_format</span> <span class="op">=</span> <span class="st">"shiny"</span><span class="op">)</span><span class="op">{</span>
    
    
    <span class="va">data_to_plot</span> <span class="op">&lt;-</span> 
      <span class="va">contacts_df_long</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">row_id</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="co"># slice long frame</span>
      <span class="fu">slice_head</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="co"># count cases per id</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">link_with_the_case</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">count</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="op">-</span><span class="va">n</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span>`Link with the case` <span class="op">=</span> <span class="va">link_with_the_case</span>, 
             `Number of contacts` <span class="op">=</span> <span class="va">n</span><span class="op">)</span>
    
    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data_to_plot</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span>
      <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="http://jkunst.com/highcharter/reference/highchart.html">highchart</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_title.html">hc_title</a></span><span class="op">(</span>text  <span class="op">=</span> <span class="st">"No data to plot"</span><span class="op">)</span><span class="op">)</span>
    <span class="op">}</span>

    <span class="va">output_highchart</span> <span class="op">&lt;-</span> 
      <span class="va">data_to_plot</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hchart.html">hchart</a></span><span class="op">(</span><span class="st">"pie"</span>, <span class="fu"><a href="http://jkunst.com/highcharter/reference/hcaes.html">hcaes</a></span><span class="op">(</span>name <span class="op">=</span> <span class="va">`Link with the case`</span>, y <span class="op">=</span> <span class="va">`Number of contacts`</span> <span class="op">)</span>,
             innerSize <span class="op">=</span> <span class="st">"40%"</span>,
             name <span class="op">=</span> <span class="st">"n"</span>,
             showInLegend <span class="op">=</span> <span class="cn">TRUE</span>,
             dataLabels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>enabled <span class="op">=</span> <span class="cn">TRUE</span>,
                               style <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>fontSize <span class="op">=</span> <span class="fl">12</span>, lineHeight <span class="op">=</span> <span class="fl">15</span><span class="op">)</span>,
                               format <span class="op">=</span> <span class="st">'{point.name}: {point.y}, ({point.percentage:.1f} %)'</span><span class="op">)</span><span class="op">)</span>  <span class="op">%&gt;%</span>
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_exporting.html">hc_exporting</a></span><span class="op">(</span>enabled <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
      
      
      
      <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"pptx"</span>, <span class="st">"docx"</span>, <span class="st">"pdf"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>

        <span class="va">output_highchart</span> <span class="op">&lt;-</span>
          <span class="va">output_highchart</span> <span class="op">%&gt;%</span> 
          <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_exporting.html">hc_exporting</a></span><span class="op">(</span>enabled <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">%&gt;%</span>
          <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_plotOptions.html">hc_plotOptions</a></span><span class="op">(</span>series <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>animation <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
          <span class="fu">html_webshot</span><span class="op">(</span><span class="op">)</span>
        <span class="co"># no need to return anything. html_webshot prints automatically</span>
      <span class="op">}</span>
    
    <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"html (page)"</span>, <span class="st">"html (slides)"</span>, <span class="st">"shiny"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
      
      <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">output_highchart</span><span class="op">)</span>
      
    <span class="op">}</span>
    
  <span class="op">}</span></code></pre></div>
<div id="total_contacts_per_link_type_bar_chart" class="section level2">
<h2 class="hasAnchor">
<a href="#total_contacts_per_link_type_bar_chart" class="anchor"></a>total_contacts_per_link_type_bar_chart</h2>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">total_contacts_per_link_type_bar_chart</span> <span class="op">&lt;-</span> 
  <span class="kw">function</span><span class="op">(</span><span class="va">contacts_df_long</span>, <span class="va">report_format</span> <span class="op">=</span> <span class="st">"shiny"</span><span class="op">)</span><span class="op">{</span>

    
    <span class="va">data_to_plot</span> <span class="op">&lt;-</span> 
      <span class="va">contacts_df_long</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">row_id</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="co"># slice long frame</span>
      <span class="fu">slice_head</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="co"># count cases per id</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">link_with_the_case</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">count</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>pct <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fl">100</span> <span class="op">*</span> <span class="va">n</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>hc_label <span class="op">=</span> <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op">(</span><span class="st">"{n}&lt;br&gt;({pct}%)"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="op">-</span><span class="va">n</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span>`Link with the case` <span class="op">=</span> <span class="va">link_with_the_case</span>, 
             `Number of contacts` <span class="op">=</span> <span class="va">n</span>, 
             <span class="va">hc_label</span><span class="op">)</span>
    
    <span class="va">color_df</span> <span class="op">&lt;-</span> 
      <span class="fu">tibble</span><span class="op">(</span>`Link with the case` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">data_to_plot</span><span class="op">$</span><span class="va">`Link with the case`</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">add_column</span><span class="op">(</span>color_lvl_1 <span class="op">=</span> <span class="va">highcharter_palette</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>
    
    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data_to_plot</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span>
      <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="http://jkunst.com/highcharter/reference/highchart.html">highchart</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_title.html">hc_title</a></span><span class="op">(</span>text  <span class="op">=</span> <span class="st">"No data to plot"</span><span class="op">)</span><span class="op">)</span>
    <span class="op">}</span>
    
    
    <span class="va">output_highchart</span> <span class="op">&lt;-</span> 
      <span class="va">data_to_plot</span> <span class="op">%&gt;%</span>
      <span class="fu">left_join</span><span class="op">(</span><span class="va">color_df</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hchart.html">hchart</a></span><span class="op">(</span><span class="st">"column"</span>, <span class="fu"><a href="http://jkunst.com/highcharter/reference/hcaes.html">hcaes</a></span><span class="op">(</span>name <span class="op">=</span> <span class="va">`Link with the case`</span> ,
                             y <span class="op">=</span> <span class="va">`Number of contacts`</span>, 
                             color <span class="op">=</span> <span class="va">color_lvl_1</span><span class="op">)</span>,
             name <span class="op">=</span> <span class="st">"n "</span>,
             showInLegend <span class="op">=</span> <span class="cn">TRUE</span>,
             dataLabels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>enabled <span class="op">=</span> <span class="cn">TRUE</span>,
                               style <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>fontSize <span class="op">=</span> <span class="fl">12</span>, lineHeight <span class="op">=</span> <span class="fl">15</span><span class="op">)</span>,
                               format <span class="op">=</span> <span class="st">'{point.hc_label}'</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_exporting.html">hc_exporting</a></span><span class="op">(</span>enabled <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_xAxis.html">hc_xAxis</a></span><span class="op">(</span>categories <span class="op">=</span> <span class="va">data_to_plot</span><span class="op">$</span><span class="va">`Link with the case`</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_legend.html">hc_legend</a></span><span class="op">(</span>enabled <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
    
    <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"pptx"</span>, <span class="st">"docx"</span>, <span class="st">"pdf"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>

      <span class="va">output_highchart</span> <span class="op">&lt;-</span>
        <span class="va">output_highchart</span> <span class="op">%&gt;%</span> 
        <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_exporting.html">hc_exporting</a></span><span class="op">(</span>enabled <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu"><a href="http://jkunst.com/highcharter/reference/hc_plotOptions.html">hc_plotOptions</a></span><span class="op">(</span>series <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>animation <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
        <span class="fu">html_webshot</span><span class="op">(</span><span class="op">)</span>
      <span class="co"># no need to return anything. html_webshot prints automatically</span>
    <span class="op">}</span>
    
    <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"html (page)"</span>, <span class="st">"html (slides)"</span>, <span class="st">"shiny"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
      
      <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">output_highchart</span><span class="op">)</span>
      
    <span class="op">}</span>
    
  <span class="op">}</span></code></pre></div>
</div>
<div id="total_contacts_per_link_type_text" class="section level2">
<h2 class="hasAnchor">
<a href="#total_contacts_per_link_type_text" class="anchor"></a>total_contacts_per_link_type_text</h2>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">total_contacts_per_link_type_text</span> <span class="op">&lt;-</span>
  <span class="kw">function</span><span class="op">(</span><span class="va">contacts_df_long</span>, <span class="va">report_format</span> <span class="op">=</span> <span class="st">"shiny"</span><span class="op">)</span><span class="op">{</span>

    
    <span class="va">data_to_plot</span> <span class="op">&lt;-</span>
      <span class="va">contacts_df_long</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">row_id</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="co"># slice long frame</span>
      <span class="fu">slice_head</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="co"># count cases per id</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">link_with_the_case</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu">count</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="op">-</span><span class="va">n</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Percent <span class="op">=</span> <span class="fu"><a href="https://scales.r-lib.org/reference/label_percent.html">percent</a></span><span class="op">(</span><span class="va">n</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span>`Link with the case` <span class="op">=</span> <span class="va">link_with_the_case</span>,
             `Number of contacts` <span class="op">=</span> <span class="va">n</span>,
             <span class="va">Percent</span><span class="op">)</span>
    
    <span class="va">link_type_with_most_contacts</span> <span class="op">&lt;-</span>
      <span class="va">data_to_plot</span> <span class="op">%&gt;%</span>
      <span class="va">.</span><span class="op">$</span><span class="va">`Link with the case`</span> <span class="op">%&gt;%</span>
      <span class="va">.</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>
    
    <span class="va">number_of_contacts_link_type_with_most_contacts</span> <span class="op">&lt;-</span>
      <span class="va">data_to_plot</span> <span class="op">%&gt;%</span>
      <span class="va">.</span><span class="op">$</span><span class="va">`Number of contacts`</span> <span class="op">%&gt;%</span>
      <span class="va">.</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>
    
    <span class="va">percent_link_type_with_most_contacts</span> <span class="op">&lt;-</span>
      <span class="va">data_to_plot</span> <span class="op">%&gt;%</span>
      <span class="va">.</span><span class="op">$</span><span class="va">Percent</span> <span class="op">%&gt;%</span>
      <span class="va">.</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>
    
  
    <span class="va">info</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"&lt;br&gt;
            &lt;span style='color: rgb(97, 189, 109);'&gt;ℹ:&lt;/span&gt;
            &lt;font size='1'&gt;
            The plots show the number of contacts per type of link. The categories have been cleaned and condensed.
            Access the data in tabular form by clicking on the top-right button.
            &lt;/font&gt;"</span><span class="op">)</span>
    
    <span class="va">str1</span> <span class="op">&lt;-</span>
      <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op">(</span>
        <span class="st">"&lt;br&gt;The most common link category is &lt;b&gt;'{link_type_with_most_contacts}'&lt;/b&gt;,
                 with &lt;b&gt;{number_of_contacts_link_type_with_most_contacts}&lt;/b&gt; contacts (&lt;b&gt;{percent_link_type_with_most_contacts}&lt;/b&gt;)."</span>
      <span class="op">)</span>
    
    <span class="va">output_text</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/htmltools/man/HTML.html">HTML</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">info</span>, <span class="va">str1</span>, sep <span class="op">=</span> <span class="st">'&lt;br/&gt;'</span><span class="op">)</span><span class="op">)</span>
    
    <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"pptx"</span>,<span class="st">"docx"</span>, <span class="st">"pdf"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
      
      <span class="va">output_text</span> <span class="op">&lt;-</span> 
        <span class="va">output_text</span> <span class="op">%&gt;%</span> 
        <span class="fu"><a href="https://rdrr.io/r/base/rawConversion.html">charToRaw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
        <span class="fu"><a href="http://xml2.r-lib.org/reference/read_xml.html">read_html</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
        <span class="fu"><a href="https://rvest.tidyverse.org/reference/html_text.html">html_text2</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
        <span class="fu">str_trim</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
        <span class="fu">pander</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pander/man/pandoc.p.return.html">pandoc.p</a></span><span class="op">(</span><span class="op">)</span>
      <span class="co"># no need to return anything. pandoc.p prints automatically</span>
    <span class="op">}</span>
    
    <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"shiny"</span>, <span class="st">"html (page)"</span>, <span class="st">"html (slides)"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
      <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">output_text</span><span class="op">)</span>
    <span class="op">}</span>
    
    
  <span class="op">}</span></code></pre></div>
</div>
</div>
<div id="outputs-pertaining-to-active-contacts" class="section level1">
<h1 class="hasAnchor">
<a href="#outputs-pertaining-to-active-contacts" class="anchor"></a>OUTPUTS PERTAINING TO ACTIVE CONTACTS</h1>
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<span class="co"># ~ OUTPUTS PERTAINING TO ACTIVE CONTACTS ----</span>
<span class="co">#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></code></pre></div>
</div>
<div id="active_contacts_bar_and_snake" class="section level1">
<h1 class="hasAnchor">
<a href="#active_contacts_bar_and_snake" class="anchor"></a>active_contacts_bar_and_snake</h1>
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<span class="co"># ~ active_contacts_bar_and_snake ------</span>
<span class="co"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></code></pre></div>
<p>Graphs and tables showing active contacts by status ## active_contacts_breakdown_bar_chart</p>
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">active_contacts_breakdown_bar_chart</span> <span class="op">&lt;-</span> 
  <span class="kw">function</span><span class="op">(</span><span class="va">contacts_df_long</span>, <span class="va">todays_date</span>, <span class="va">report_format</span> <span class="op">=</span> <span class="st">"shiny"</span>, <span class="va">legend_df</span><span class="op">)</span><span class="op">{</span>
    
    
    <span class="va">active_contacts</span> <span class="op">&lt;-</span>
      <span class="va">contacts_df_long</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">row_id</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="co">## keep active cases. </span>
      <span class="co">## active cases are those whose last day of follow-up is today or any day past today</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">follow_up_date</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span> <span class="op">&gt;=</span> <span class="va">todays_date</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="co">## AND whose first day of follow_up is today or anyday before today. BUT this is actually redundant since read_file already removes all IDs for which follow-up had not begun by date of review</span>
      <span class="co"># filter(min(follow_up_date, na.rm = T) &lt;= todays_date) %&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span>
    
    <span class="co"># # to be fed to plotter</span>
    <span class="co"># colors &lt;- </span>
    <span class="co">#   active_contacts %&gt;% </span>
    <span class="co">#   select(follow_up_status, colors) %&gt;% </span>
    <span class="co">#   unique.data.frame()</span>
    
    <span class="va">data_to_plot</span> <span class="op">&lt;-</span>
      <span class="va">active_contacts</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">follow_up_date</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">count</span><span class="op">(</span><span class="va">follow_up_status</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">complete</span><span class="op">(</span><span class="va">follow_up_date</span>, <span class="va">follow_up_status</span>, fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>total <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>prop <span class="op">=</span> <span class="va">n</span><span class="op">/</span><span class="va">total</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>text <span class="op">=</span> <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op">(</span><span class="st">"&lt;b&gt;Date:&lt;/b&gt; {format.Date(follow_up_date,  format = '%b %d' )}
                        &lt;b&gt;{follow_up_status}:&lt;/b&gt; {n}
                        "</span><span class="op">)</span><span class="op">)</span> 
    
    <span class="va">ggplot_to_convert</span> <span class="op">&lt;-</span>
      <span class="va">data_to_plot</span> <span class="op">%&gt;%</span>
      <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">follow_up_date</span>, y <span class="op">=</span> <span class="va">n</span>, fill <span class="op">=</span> <span class="va">follow_up_status</span>, text <span class="op">=</span> <span class="va">text</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
      <span class="fu">geom_col</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
      <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Follow up date"</span>, y <span class="op">=</span> <span class="st">"Count"</span><span class="op">)</span> <span class="op">+</span>
      <span class="fu">scale_fill_manual</span><span class="op">(</span>breaks <span class="op">=</span> <span class="va">legend_df</span><span class="op">$</span><span class="va">breaks</span>, values <span class="op">=</span> <span class="va">legend_df</span><span class="op">$</span><span class="va">colors</span>,
                        name <span class="op">=</span> <span class="st">"&lt;br&gt; &lt;br&gt; &lt;br&gt; &lt;br&gt; &lt;br&gt; &lt;br&gt; &lt;br&gt; &lt;br&gt;"</span><span class="op">)</span>  <span class="co">## push legend off plotly. too troublesome</span>
    
    <span class="va">output_plotly</span> <span class="op">&lt;-</span>  
      <span class="fu"><a href="https://docs.ropensci.org/plotly/reference/ggplotly.html">ggplotly</a></span><span class="op">(</span><span class="va">ggplot_to_convert</span>, tooltip <span class="op">=</span> <span class="st">"text"</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">plotly</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/plotly/reference/layout.html">layout</a></span><span class="op">(</span>legend<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>orientation <span class="op">=</span> <span class="st">"h"</span>,
                                  x <span class="op">=</span> <span class="fl">0.5</span>, 
                                  xanchor <span class="op">=</span> <span class="st">"center"</span>,
                                  y <span class="op">=</span> <span class="fl">1.0</span>, 
                                  yanchor <span class="op">=</span> <span class="st">"bottom"</span>,
                                  title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>text<span class="op">=</span> <span class="st">""</span><span class="op">)</span>, 
                                  bgcolor <span class="op">=</span> <span class="st">"rgba(0,0,0,0)"</span>
      <span class="op">)</span>, 
      font <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>family <span class="op">=</span> <span class="st">"Avenir"</span>,
                  size <span class="op">=</span> <span class="fl">12</span>,
                  color <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span>
      <span class="co">## Don't know where the axis labels are at the moment. Don't care too much</span>
      <span class="co">#, </span>
      <span class="co"># xaxis = list(title = "Follow up date"), </span>
      <span class="co"># yaxis = list(title = "Row ID")</span>
      <span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">plotly</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/plotly/reference/style.html">style</a></span><span class="op">(</span>hoverlabel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>bordercolor <span class="op">=</span> <span class="st">"transparent"</span>, 
                                      font <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>family <span class="op">=</span> <span class="st">"Avenir"</span>, <span class="co">## bizarre that you have to duplicat font settings</span>
                                                  color <span class="op">=</span> <span class="st">"white"</span>, 
                                                  size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span><span class="op">)</span> <span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">plotly</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/plotly/reference/config.html">config</a></span><span class="op">(</span>displaylogo <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">plotly</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/plotly/reference/config.html">config</a></span><span class="op">(</span>modeBarButtonsToRemove <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"zoomIn2d"</span>, <span class="st">"zoomOut2d"</span>, <span class="st">"autoScale2d"</span>, 
                                                <span class="st">"hoverClosestCartesian"</span>, <span class="st">"hoverCompareCartesian"</span>, 
                                                <span class="st">"toggleSpikelines"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">plotly</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/plotly/reference/layout.html">layout</a></span><span class="op">(</span>plot_bgcolor  <span class="op">=</span> <span class="st">"rgba(0, 0, 0, 0)"</span>,
                     paper_bgcolor <span class="op">=</span> <span class="st">"rgba(0, 0, 0, 0)"</span><span class="op">)</span> 
    
    
    <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"pptx"</span>, <span class="st">"docx"</span>, <span class="st">"pdf"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
      
      <span class="co">## webshot is not working when deployed to shinyapps.io</span>
      <span class="va">output_ggplot</span> <span class="op">&lt;-</span> 
        <span class="va">ggplot_to_convert</span> <span class="op">+</span> 
        <span class="fu">scale_fill_manual</span><span class="op">(</span>breaks <span class="op">=</span> <span class="va">legend_df</span><span class="op">$</span><span class="va">breaks</span>, values <span class="op">=</span> <span class="va">legend_df</span><span class="op">$</span><span class="va">colors</span>,
                          name <span class="op">=</span> <span class="st">""</span><span class="op">)</span>
      <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">output_ggplot</span><span class="op">)</span>
    <span class="op">}</span>
    
    <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"html (page)"</span>, <span class="st">"html (slides)"</span>, <span class="st">"shiny"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
      <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">output_plotly</span><span class="op">)</span>
    <span class="op">}</span>
  <span class="op">}</span></code></pre></div>
<div id="active_contacts_breakdown_table" class="section level2">
<h2 class="hasAnchor">
<a href="#active_contacts_breakdown_table" class="anchor"></a>active_contacts_breakdown_table</h2>
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">active_contacts_breakdown_table</span> <span class="op">&lt;-</span> 
  <span class="kw">function</span><span class="op">(</span><span class="va">contacts_df_long</span>, <span class="va">todays_date</span>, <span class="va">download</span> <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">{</span>
    
    
    <span class="va">active_contacts</span> <span class="op">&lt;-</span>
      <span class="va">contacts_df_long</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">row_id</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="co">## keep active cases. </span>
      <span class="co">## active cases whose last day of follow-up is today any day past today</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">follow_up_date</span><span class="op">)</span> <span class="op">&gt;=</span> <span class="va">todays_date</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="co">## AND whose first day of follow_up is today or anyday before today</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">follow_up_date</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span> <span class="op">&lt;=</span> <span class="va">todays_date</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span>
    
    <span class="va">colors</span> <span class="op">&lt;-</span> 
      <span class="va">active_contacts</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">follow_up_status</span>, <span class="va">colors</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique.data.frame</a></span><span class="op">(</span><span class="op">)</span>
    
    
    <span class="va">data_to_plot</span> <span class="op">&lt;-</span>
      <span class="va">active_contacts</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">follow_up_date</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">count</span><span class="op">(</span><span class="va">follow_up_status</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">complete</span><span class="op">(</span><span class="va">follow_up_date</span>, <span class="va">follow_up_status</span>, fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="co"># replace 0s with NA for Upcoming follow ups before today's date</span>
      <span class="co"># and replace 0s with NA for past follow ups after today's date</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">follow_up_status</span> <span class="op">==</span> <span class="st">"Suivi futur"</span> <span class="op">&amp;</span> 
                          <span class="va">follow_up_date</span> <span class="op">&lt;=</span> <span class="va">todays_date</span>, 
                        <span class="cn">NA_integer_</span>, 
                        <span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>prop <span class="op">=</span> <span class="va">n</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>hc_ttip <span class="op">=</span> <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op">(</span><span class="st">"&lt;b&gt;Date:&lt;/b&gt; {format.Date(follow_up_date,  format = '%b %d')}
                        &lt;b&gt;{follow_up_status}:&lt;/b&gt; {n}
                        "</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">follow_up_status</span><span class="op">)</span> <span class="op">%&gt;%</span>   <span class="co"># arranging is necessary so that that colors are pulled in the right order for highcharter</span>
      <span class="fu">left_join</span><span class="op">(</span><span class="va">colors</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">pivot_wider</span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">follow_up_status</span>, values_from <span class="op">=</span> <span class="va">n</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span>Date <span class="op">=</span> <span class="va">follow_up_date</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html">everything</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
    
    <span class="kw">if</span> <span class="op">(</span><span class="va">download</span> <span class="op">==</span> <span class="cn">TRUE</span><span class="op">)</span><span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">data_to_plot</span><span class="op">)</span>
    
    <span class="va">data_to_plot</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://glin.github.io/reactable/reference/reactable.html">reactable</a></span><span class="op">(</span>searchable <span class="op">=</span> <span class="cn">TRUE</span>,
                striped <span class="op">=</span> <span class="cn">TRUE</span>,
                highlight <span class="op">=</span> <span class="cn">TRUE</span>,
                defaultPageSize <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>
    
    
    
  <span class="op">}</span></code></pre></div>
</div>
<div id="active_contacts_breakdown_table_download" class="section level2">
<h2 class="hasAnchor">
<a href="#active_contacts_breakdown_table_download" class="anchor"></a>active_contacts_breakdown_table_download</h2>
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">active_contacts_breakdown_table_download</span> <span class="op">&lt;-</span> 
  <span class="kw">function</span><span class="op">(</span><span class="op">)</span><span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/downloadHandler.html">downloadHandler</a></span><span class="op">(</span>
      filename <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"follow_up_summary.csv"</span><span class="op">)</span>,
      
      content <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">file</span><span class="op">)</span><span class="op">{</span>
        <span class="va">file_to_write</span> <span class="op">&lt;-</span> <span class="fu">active_contacts_breakdown_table</span><span class="op">(</span><span class="fu">read_file_filtered_reactive</span><span class="op">(</span><span class="op">)</span>, 
                                                         <span class="va">input</span><span class="op">$</span><span class="va">select_date_of_review</span>, 
                                                         download <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
        <span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.csv</a></span><span class="op">(</span><span class="va">file_to_write</span>, <span class="va">file</span><span class="op">)</span><span class="op">}</span>
      
    <span class="op">)</span>
    
  <span class="op">}</span></code></pre></div>
</div>
<div id="active_contacts_timeline_snake_plot" class="section level2">
<h2 class="hasAnchor">
<a href="#active_contacts_timeline_snake_plot" class="anchor"></a>active_contacts_timeline_snake_plot</h2>
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">active_contacts_timeline_snake_plot</span> <span class="op">&lt;-</span> 
  <span class="kw">function</span><span class="op">(</span><span class="va">contacts_df_long</span>, <span class="va">todays_date</span>, <span class="va">report_format</span> <span class="op">=</span> <span class="st">"shiny"</span>, <span class="va">legend_df</span><span class="op">)</span><span class="op">{</span>
  
    
    <span class="va">active_contacts</span> <span class="op">&lt;-</span>
      <span class="va">contacts_df_long</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">row_id</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="co">## keep active cases. </span>
      <span class="co">## active cases are those whose last day of follow-up is today or any day past today</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">follow_up_date</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span> <span class="op">&gt;=</span> <span class="va">todays_date</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="co">## AND whose first day of follow_up is today or anyday before today. BUT this is actually redundant since read_file already removes all IDs for which follow-up had not begun by date of review</span>
      <span class="co"># filter(min(follow_up_date, na.rm = T) &lt;= todays_date) %&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span>
    
    <span class="va">data_to_plot</span> <span class="op">&lt;-</span>
      <span class="va">active_contacts</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>text <span class="op">=</span> <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op">(</span><span class="st">"&lt;b&gt;ID: &lt;/b&gt; {contact_id}
                         &lt;b&gt;Date: &lt;/b&gt; {format.Date(follow_up_date, format = '%b %d')} (day {follow_up_day})
                         &lt;b&gt;Status: &lt;/b&gt; {follow_up_status}
                         "</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">contact_id</span>, <span class="va">row_id</span>, <span class="va">follow_up_day</span>, <span class="va">follow_up_date</span>, <span class="va">follow_up_status</span>, <span class="va">row_id</span>, <span class="va">text</span>, <span class="va">colors</span><span class="op">)</span> 
    
    
    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data_to_plot</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span>
      <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span> <span class="op">(</span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"No data to plot"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://docs.ropensci.org/plotly/reference/ggplotly.html">ggplotly</a></span><span class="op">(</span><span class="op">)</span> <span class="op">)</span>
    <span class="op">}</span>

      <span class="va">segment_x_start</span> <span class="op">&lt;-</span> 
        <span class="va">active_contacts</span> <span class="op">%&gt;%</span> 
        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">row_id</span><span class="op">)</span> <span class="op">%&gt;%</span> 
        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">follow_up_date</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">follow_up_date</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">follow_up_date</span><span class="op">)</span> <span class="op">%&gt;%</span> 
        <span class="fu">pull</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>
    
      <span class="va">segment_x_end</span> <span class="op">&lt;-</span> 
        <span class="va">active_contacts</span> <span class="op">%&gt;%</span> 
        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">row_id</span><span class="op">)</span> <span class="op">%&gt;%</span> 
        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">follow_up_date</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">follow_up_date</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">follow_up_date</span><span class="op">)</span> <span class="op">%&gt;%</span> 
        <span class="fu">pull</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>
      
      <span class="va">segment_y</span> <span class="op">&lt;-</span> 
        <span class="va">active_contacts</span> <span class="op">%&gt;%</span> 
        <span class="va">.</span><span class="op">$</span><span class="va">row_id</span> <span class="op">%&gt;%</span> 
        <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="op">)</span>
    
    
      <span class="va">ggplot_to_convert</span> <span class="op">&lt;-</span> 
        <span class="va">data_to_plot</span> <span class="op">%&gt;%</span>
        <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">follow_up_date</span>, y <span class="op">=</span> <span class="va">row_id</span>, color <span class="op">=</span> <span class="va">follow_up_status</span>, text <span class="op">=</span> <span class="va">text</span>, 
                   customdata <span class="op">=</span> <span class="va">row_id</span>
                   <span class="co">#, </span>
                   <span class="co">#customdata = selected_id_and_follow_up</span>
                   <span class="op">)</span><span class="op">)</span> <span class="op">+</span>
         <span class="fu">annotate</span><span class="op">(</span><span class="st">"segment"</span>, x <span class="op">=</span> <span class="va">segment_x_start</span>, xend <span class="op">=</span> <span class="va">segment_x_end</span>, y <span class="op">=</span> <span class="va">segment_y</span>, yend <span class="op">=</span> <span class="va">segment_y</span>, 
                  color <span class="op">=</span> <span class="st">"grey"</span>, size <span class="op">=</span> <span class="fl">0.25</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span>
         <span class="fu">geom_point</span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.6</span><span class="op">)</span> <span class="op">+</span>
         <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Follow up date"</span>, y <span class="op">=</span> <span class="st">"Row ID"</span><span class="op">)</span> <span class="op">+</span>
         <span class="fu">scale_size_continuous</span><span class="op">(</span>range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2.3</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
         <span class="fu">scale_color_manual</span><span class="op">(</span>breaks <span class="op">=</span> <span class="va">legend_df</span><span class="op">$</span><span class="va">breaks</span>, values <span class="op">=</span> <span class="va">legend_df</span><span class="op">$</span><span class="va">colors</span>,
                            name <span class="op">=</span> <span class="st">"&lt;br&gt; &lt;br&gt; &lt;br&gt; &lt;br&gt; &lt;br&gt; &lt;br&gt; &lt;br&gt; &lt;br&gt;"</span><span class="op">)</span>  <span class="co">## push legend off plotly. too troublesome</span>
    
      
      <span class="va">output_plotly</span> <span class="op">&lt;-</span> 
        <span class="fu"><a href="https://docs.ropensci.org/plotly/reference/ggplotly.html">ggplotly</a></span><span class="op">(</span><span class="va">ggplot_to_convert</span>, tooltip <span class="op">=</span> <span class="st">"text"</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="co"># plotly::layout(autosize = T, width = 500, height = 500)%&gt;%</span>
        <span class="fu"><a href="https://docs.ropensci.org/plotly/reference/event_register.html">event_register</a></span><span class="op">(</span><span class="st">"plotly_selecting"</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu">plotly</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/plotly/reference/layout.html">layout</a></span><span class="op">(</span>dragmode <span class="op">=</span> <span class="st">"select"</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu">plotly</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/plotly/reference/layout.html">layout</a></span><span class="op">(</span>legend<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>itemsizing<span class="op">=</span><span class="st">'constant'</span>,
                                    orientation <span class="op">=</span> <span class="st">"h"</span>,
                                    x <span class="op">=</span> <span class="fl">0.5</span>,
                                    xanchor <span class="op">=</span> <span class="st">"center"</span>,
                                    y <span class="op">=</span> <span class="fl">1.0</span>,
                                    yanchor <span class="op">=</span> <span class="st">"bottom"</span>,
                                    bgcolor <span class="op">=</span> <span class="st">"rgba(0, 0, 0, 0)"</span>
                                    <span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu">plotly</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/plotly/reference/layout.html">layout</a></span><span class="op">(</span>font <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>family <span class="op">=</span> <span class="st">"Avenir"</span>,
                           size <span class="op">=</span> <span class="fl">12</span>,
                           color <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu">plotly</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/plotly/reference/style.html">style</a></span><span class="op">(</span>hoverlabel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>bordercolor <span class="op">=</span> <span class="st">"transparent"</span>,
                                font <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>family <span class="op">=</span> <span class="st">"Avenir"</span>, <span class="co">## bizarre that you have to duplicat font settings</span>
                                            color <span class="op">=</span> <span class="st">"white"</span>,
                                            size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span><span class="op">)</span> <span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu">plotly</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/plotly/reference/layout.html">layout</a></span><span class="op">(</span>plot_bgcolor  <span class="op">=</span> <span class="st">"rgba(0, 0, 0, 0)"</span>,
               paper_bgcolor <span class="op">=</span> <span class="st">"rgba(0, 0, 0, 0)"</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu">plotly</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/plotly/reference/config.html">config</a></span><span class="op">(</span>displaylogo <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu">plotly</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/plotly/reference/config.html">config</a></span><span class="op">(</span>modeBarButtonsToRemove <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"zoomIn2d"</span>, <span class="st">"zoomOut2d"</span>, <span class="st">"autoScale2d"</span>,
                                          <span class="st">"hoverClosestCartesian"</span>, <span class="st">"hoverCompareCartesian"</span>,
                                          <span class="st">"toggleSpikelines"</span>
                                          <span class="op">)</span><span class="op">)</span>
    
    
    <span class="co"># ## go into the internals of plotly to change point size. (calling plotly_json(output_plotly) is helpful for this)</span>
    <span class="co"># ## there is probably a better way to achieve this</span>
    <span class="co"># for (i in 1:length(output_plotly$x$data)){</span>
    <span class="co">#   for (j in 1:length(output_plotly$x$data[[i]]$marker$size)){</span>
    <span class="co">#     ## if the point is larger than 8 units</span>
    <span class="co">#     if (output_plotly$x$data[[i]]$marker$size[[j]] &gt; 7) {</span>
    <span class="co">#       ## force it to be 8 units</span>
    <span class="co">#       output_plotly$x$data[[i]]$marker$size[[j]] &lt;- 7 }</span>
    <span class="co">#   }</span>
    <span class="co"># }</span>
    
    <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"pptx"</span>, <span class="st">"docx"</span>, <span class="st">"pdf"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
      
      <span class="co">## webshot is not working when deployed to shinyapps.io</span>
      <span class="va">output_ggplot</span> <span class="op">&lt;-</span> 
        <span class="va">ggplot_to_convert</span> <span class="op">+</span> 
        <span class="fu">scale_color_manual</span><span class="op">(</span>breaks <span class="op">=</span> <span class="va">legend_df</span><span class="op">$</span><span class="va">breaks</span>, values <span class="op">=</span> <span class="va">legend_df</span><span class="op">$</span><span class="va">colors</span>,
                           name <span class="op">=</span> <span class="st">""</span><span class="op">)</span>
      
      <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">output_ggplot</span><span class="op">)</span>

    <span class="op">}</span>
    
    
    <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"html (page)"</span>, <span class="st">"html (slides)"</span>, <span class="st">"shiny"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
      
      <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">output_plotly</span><span class="op">)</span>
      
    <span class="op">}</span>
    
  <span class="op">}</span></code></pre></div>
</div>
<div id="active_contacts_snake_plot_selected_table" class="section level2">
<h2 class="hasAnchor">
<a href="#active_contacts_snake_plot_selected_table" class="anchor"></a>active_contacts_snake_plot_selected_table</h2>
<div class="sourceCode" id="cb63"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">active_contacts_snake_plot_selected_table</span> <span class="op">&lt;-</span> 
  <span class="kw">function</span><span class="op">(</span><span class="va">contacts_df_long</span>, <span class="va">selected_ids</span>,  <span class="va">download</span> <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span>
    
    <span class="va">data_to_plot</span> <span class="op">&lt;-</span> 
      <span class="va">contacts_df_long</span> <span class="op">%&gt;%</span> 
      <span class="co">#mutate(id_and_follow_up = paste(row_id, follow_up_date, sep = "_")) %&gt;% </span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">row_id</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">selected_ids</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span>ID <span class="op">=</span> <span class="va">contact_id</span>, 
             `Follow-up day` <span class="op">=</span> <span class="va">follow_up_day</span>, 
             `Follow-up date` <span class="op">=</span> <span class="va">follow_up_date</span>,
             `Follow-up state` <span class="op">=</span> <span class="va">follow_up_status</span><span class="op">)</span>
    
    <span class="kw">if</span> <span class="op">(</span><span class="va">download</span> <span class="op">==</span> <span class="cn">TRUE</span><span class="op">)</span><span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">data_to_plot</span><span class="op">)</span>
    
    <span class="va">data_to_plot</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://glin.github.io/reactable/reference/reactable.html">reactable</a></span><span class="op">(</span>groupBy <span class="op">=</span> <span class="st">"ID"</span>, 
                columns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>`Follow-up state` <span class="op">=</span> <span class="fu"><a href="https://glin.github.io/reactable/reference/colDef.html">colDef</a></span><span class="op">(</span>aggregate <span class="op">=</span> <span class="st">"frequency"</span><span class="op">)</span>
                <span class="op">)</span>,
                searchable <span class="op">=</span> <span class="cn">TRUE</span>,
                striped <span class="op">=</span> <span class="cn">TRUE</span>,
                highlight <span class="op">=</span> <span class="cn">TRUE</span>,
                defaultPageSize <span class="op">=</span> <span class="fl">15</span><span class="op">)</span>
    
    
  <span class="op">}</span></code></pre></div>
</div>
<div id="active_contacts_snake_plot_selected_table_download" class="section level2">
<h2 class="hasAnchor">
<a href="#active_contacts_snake_plot_selected_table_download" class="anchor"></a>active_contacts_snake_plot_selected_table_download</h2>
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">active_contacts_snake_plot_selected_table_download</span> <span class="op">&lt;-</span> 
    <span class="kw">function</span><span class="op">(</span><span class="op">)</span><span class="op">{</span>
      <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/downloadHandler.html">downloadHandler</a></span><span class="op">(</span>
        filename <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"snake_plot_selected.csv"</span><span class="op">)</span>,
        
        content <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">file</span><span class="op">)</span><span class="op">{</span>
          <span class="va">file_to_write</span> <span class="op">&lt;-</span> <span class="fu">active_contacts_snake_plot_selected_table</span><span class="op">(</span><span class="fu">read_file_filtered_reactive</span><span class="op">(</span><span class="op">)</span>, 
                                                                     <span class="fu"><a href="https://docs.ropensci.org/plotly/reference/event_data.html">event_data</a></span><span class="op">(</span><span class="st">"plotly_selecting"</span><span class="op">)</span><span class="op">$</span><span class="va">customdata</span>, 
                                                                     download <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
          <span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.csv</a></span><span class="op">(</span><span class="va">file_to_write</span>, <span class="va">file</span><span class="op">)</span><span class="op">}</span>
        
      <span class="op">)</span>
    

    
    
  <span class="op">}</span></code></pre></div>
</div>
<div id="active_contacts_timeline_table" class="section level2">
<h2 class="hasAnchor">
<a href="#active_contacts_timeline_table" class="anchor"></a>active_contacts_timeline_table</h2>
<div class="sourceCode" id="cb65"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">active_contacts_timeline_table</span> <span class="op">&lt;-</span> 
  <span class="kw">function</span><span class="op">(</span><span class="va">contacts_df_long</span>, <span class="va">todays_date</span>, <span class="va">download</span> <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">{</span>
    
    
    
    <span class="va">data_to_plot</span> <span class="op">&lt;-</span>
      <span class="va">contacts_df_long</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">row_id</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="co">## keep active cases. </span>
      <span class="co">## active cases are those whose last day of follow-up is today or any day past today</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">follow_up_date</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span> <span class="op">&gt;=</span> <span class="va">todays_date</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="co">## AND whose first day of follow_up is today or anyday before today. BUT this is actually redundant since read_file already removes all IDs for which follow-up had not begun by date of review</span>
      <span class="co"># filter(min(follow_up_date, na.rm = T) &lt;= todays_date) %&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span>ID <span class="op">=</span> <span class="va">contact_id</span>, 
             `Follow-up day` <span class="op">=</span> <span class="va">follow_up_day</span>, 
             `Follow-up date` <span class="op">=</span> <span class="va">follow_up_date</span>,
             `Follow-up status` <span class="op">=</span> <span class="va">follow_up_status</span><span class="op">)</span>
    
    <span class="kw">if</span> <span class="op">(</span><span class="va">download</span> <span class="op">==</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">{</span>
      <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">data_to_plot</span><span class="op">)</span>
      <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
        
        <span class="va">data_to_plot</span> <span class="op">%&gt;%</span> 
          <span class="fu"><a href="https://glin.github.io/reactable/reference/reactable.html">reactable</a></span><span class="op">(</span>searchable <span class="op">=</span> <span class="cn">TRUE</span>,
                    striped <span class="op">=</span> <span class="cn">TRUE</span>,
                    highlight <span class="op">=</span> <span class="cn">TRUE</span>,
                    defaultPageSize <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>
        
      <span class="op">}</span>
      
  <span class="op">}</span></code></pre></div>
</div>
<div id="active_contacts_timeline_table_download" class="section level2">
<h2 class="hasAnchor">
<a href="#active_contacts_timeline_table_download" class="anchor"></a>active_contacts_timeline_table_download</h2>
<div class="sourceCode" id="cb66"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">active_contacts_timeline_table_download</span> <span class="op">&lt;-</span> 
  <span class="kw">function</span><span class="op">(</span><span class="va">contacts_df_long</span>, <span class="va">todays_date</span><span class="op">)</span><span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/downloadHandler.html">downloadHandler</a></span><span class="op">(</span>
      filename <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="st">"follow_up_timelines.csv"</span>,
      
      content <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">file</span><span class="op">)</span><span class="op">{</span>
        <span class="va">file_to_write</span> <span class="op">&lt;-</span> <span class="fu">active_contacts_timeline_table</span><span class="op">(</span><span class="va">contacts_df_long</span>, 
                                                        <span class="va">todays_date</span>, 
                                                        download <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
        <span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.csv</a></span><span class="op">(</span><span class="va">file_to_write</span>, <span class="va">file</span><span class="op">)</span><span class="op">}</span>
      
    <span class="op">)</span>
    
  <span class="op">}</span></code></pre></div>
</div>
<div id="active_contacts_timeline_text" class="section level2">
<h2 class="hasAnchor">
<a href="#active_contacts_timeline_text" class="anchor"></a>active_contacts_timeline_text</h2>
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">active_contacts_timeline_text</span> <span class="op">&lt;-</span> 
  <span class="kw">function</span><span class="op">(</span><span class="va">contacts_df_long</span>, <span class="va">todays_date</span>, <span class="va">report_format</span> <span class="op">=</span> <span class="st">"shiny"</span><span class="op">)</span><span class="op">{</span>
  
  
  <span class="va">n_active_contacts</span> <span class="op">&lt;-</span>
    <span class="va">contacts_df_long</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">row_id</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="co">## keep active cases. </span>
    <span class="co">## active cases whose last day of follow-up is today or any day past today</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">follow_up_date</span><span class="op">)</span> <span class="op">&gt;=</span> <span class="va">todays_date</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="co">## AND whose first day of follow_up is today or anyday before today</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">follow_up_date</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span> <span class="op">&lt;=</span> <span class="va">todays_date</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="va">.</span><span class="op">$</span><span class="va">row_id</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="op">)</span>
  
  
  <span class="va">info</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"&lt;br&gt;
            &lt;span style='color: rgb(97, 189, 109);'&gt;ℹ:&lt;/span&gt;
            &lt;font size='1'&gt;
            The plots track the status of each active contact over all 10 days of follow-up.
            &lt;/font&gt;"</span><span class="op">)</span>
  
  <span class="va">str1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op">(</span><span class="st">"&lt;br&gt;There are &lt;b&gt;{n_active_contacts}&lt;/b&gt; active contacts"</span><span class="op">)</span>
  
  <span class="va">output_text</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/htmltools/man/HTML.html">HTML</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">info</span>, <span class="va">str1</span>, sep <span class="op">=</span> <span class="st">'&lt;br/&gt;'</span><span class="op">)</span><span class="op">)</span>
  
  <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"pptx"</span>,<span class="st">"docx"</span>, <span class="st">"pdf"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
    
    <span class="va">output_text</span> <span class="op">&lt;-</span> 
      <span class="va">output_text</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://rdrr.io/r/base/rawConversion.html">charToRaw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="http://xml2.r-lib.org/reference/read_xml.html">read_html</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://rvest.tidyverse.org/reference/html_text.html">html_text2</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">str_trim</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">pander</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pander/man/pandoc.p.return.html">pandoc.p</a></span><span class="op">(</span><span class="op">)</span>
    <span class="co"># no need to return anything. pandoc.p prints automatically</span>
  <span class="op">}</span>
  
  <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"shiny"</span>, <span class="st">"html (page)"</span>, <span class="st">"html (slides)"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">output_text</span><span class="op">)</span>
  <span class="op">}</span>
  
  
<span class="op">}</span></code></pre></div>
</div>
</div>
<div id="lost_contacts" class="section level1">
<h1 class="hasAnchor">
<a href="#lost_contacts" class="anchor"></a>lost_contacts</h1>
<div class="sourceCode" id="cb68"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<span class="co"># ~ lost_contacts ------</span>
<span class="co"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></code></pre></div>
<p>Tables (and their download handlers) summarizing the number of individuals lost to follow-up ## contacts_lost_24_to_72_hours_table</p>
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">contacts_lost_24_to_72_hours_table</span> <span class="op">&lt;-</span> 
  <span class="kw">function</span><span class="op">(</span><span class="va">contacts_df_long</span>, <span class="va">todays_date</span>, <span class="va">report_format</span> <span class="op">=</span> <span class="st">"shiny"</span>, <span class="va">download</span> <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">{</span>
    
    <span class="va">contacts_df_long_filtered</span> <span class="op">&lt;-</span> 
      <span class="va">contacts_df_long</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">row_id</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="co">## keep active cases. </span>
      <span class="co">## active cases are those whose last day of follow-up is today or any day past today</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">follow_up_date</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span> <span class="op">&gt;=</span> <span class="va">todays_date</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="co">## AND whose first day of follow_up is today or anyday before today. BUT this is actually redundant since read_file already removes all IDs for which follow-up had not begun by date of review</span>
      <span class="co"># filter(min(follow_up_date, na.rm = T) &lt;= todays_date) %&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">follow_up_status_simple</span> <span class="op">!=</span> <span class="st">"Suivi futur"</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="co">### remove not generated follow-ups. Not relevant for this calculation </span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">follow_up_status_simple</span> <span class="op">!=</span> <span class="st">"Not generated"</span><span class="op">)</span>
      
    
    <span class="va">active_contacts_count</span> <span class="op">&lt;-</span> 
      <span class="va">contacts_df_long</span> <span class="op">%&gt;%</span>
       <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">follow_up_date</span> <span class="op">==</span> <span class="va">todays_date</span><span class="op">)</span> <span class="op">%&gt;%</span> 
       <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="op">)</span>
    
    
    <span class="co">## if there is no data, early return with empty table</span>
    <span class="kw">if</span><span class="op">(</span><span class="va">active_contacts_count</span><span class="op">==</span> <span class="fl">0</span><span class="op">)</span><span class="op">{</span>
      
      <span class="kw">if</span> <span class="op">(</span><span class="va">download</span> <span class="op">==</span> <span class="cn">TRUE</span> <span class="op">)</span> <span class="op">{</span>
        <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span>
          <span class="st">"No data to show"</span> <span class="op">%&gt;%</span> 
            <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="op">)</span>
        <span class="op">)</span>
      <span class="op">}</span>
      
      <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"shiny"</span>, <span class="st">"html (page)"</span>, <span class="st">"html (slides)"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
        <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span>
          <span class="st">"No data to show"</span> <span class="op">%&gt;%</span> 
            <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
            <span class="fu"><a href="https://glin.github.io/reactable/reference/reactable.html">reactable</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">}</span>
      
      <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"pdf"</span>, <span class="st">"pptx"</span>, <span class="st">"docx"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
        <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span>
          <span class="st">"No data to show"</span> <span class="op">%&gt;%</span> 
            <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
            <span class="fu"><a href="https://hughjonesd.github.io/huxtable/reference/huxtable.html">huxtable</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
            <span class="fu"><a href="https://hughjonesd.github.io/huxtable/reference/themes.html">theme_blue</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">}</span>
    <span class="op">}</span>
    
    <span class="va">seen_not_seen_today</span> <span class="op">&lt;-</span>
      <span class="va">contacts_df_long_filtered</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">follow_up_date</span> <span class="op">==</span> <span class="va">todays_date</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">admin_2</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">count</span><span class="op">(</span><span class="va">follow_up_status_simple</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">bind_rows</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>follow_up_status_simple <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Seen"</span>, <span class="st">"Not seen"</span><span class="op">)</span>, 
                           admin_2 <span class="op">=</span> <span class="st">"!!+temporary"</span>,
                           n <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">complete</span><span class="op">(</span><span class="va">admin_2</span>, <span class="va">follow_up_status_simple</span>, 
               fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">admin_2</span> <span class="op">!=</span> <span class="st">"!!+temporary"</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">pivot_wider</span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">follow_up_status_simple</span>, values_from <span class="op">=</span> <span class="va">n</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://rdrr.io/pkg/janitor/man/clean_names.html">clean_names</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>total <span class="op">=</span> <span class="va">not_seen</span> <span class="op">+</span> <span class="va">seen</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>pct_not_seen <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/label_percent.html">percent</a></span><span class="op">(</span><span class="va">not_seen</span><span class="op">/</span> <span class="va">total</span>, accuracy <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span>`Admin level 2` <span class="op">=</span> <span class="va">admin_2</span>, 
             `No under surveillance` <span class="op">=</span> <span class="va">total</span>, 
             `Not seen today` <span class="op">=</span> <span class="va">not_seen</span>, 
             `% Not seen` <span class="op">=</span> <span class="va">pct_not_seen</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">rename_with</span><span class="op">(</span>.cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">`No under surveillance`</span>, <span class="va">`Not seen today`</span>, <span class="va">`% Not seen`</span><span class="op">)</span>, 
                  .fn <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Today."</span>, <span class="va">.x</span><span class="op">)</span><span class="op">)</span>
      
      
    <span class="va">seen_not_seen_past_two_days</span> <span class="op">&lt;-</span> 
      <span class="va">contacts_df_long_filtered</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">follow_up_date</span> <span class="op">&gt;=</span> <span class="va">todays_date</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>counter <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">contact_id</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>number_of_days <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">counter</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">number_of_days</span> <span class="op">&gt;=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">contact_id</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>follow_up_status_simple <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/all.html">all</a></span><span class="op">(</span><span class="va">follow_up_status_simple</span> <span class="op">==</span> <span class="st">"Not seen"</span><span class="op">)</span>,
                                          <span class="st">"Not seen"</span>,
                                          <span class="st">"Seen"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">slice_head</span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">admin_2</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">count</span><span class="op">(</span><span class="va">follow_up_status_simple</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">bind_rows</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>follow_up_status_simple <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Seen"</span>, <span class="st">"Not seen"</span><span class="op">)</span>, 
                           admin_2 <span class="op">=</span> <span class="st">"!!+temporary"</span>,
                           n <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">complete</span><span class="op">(</span><span class="va">admin_2</span>, <span class="va">follow_up_status_simple</span>, 
               fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">admin_2</span> <span class="op">!=</span> <span class="st">"!!+temporary"</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">pivot_wider</span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">follow_up_status_simple</span>, values_from <span class="op">=</span> <span class="va">n</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://rdrr.io/pkg/janitor/man/clean_names.html">clean_names</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>total <span class="op">=</span> <span class="va">not_seen</span> <span class="op">+</span> <span class="va">seen</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>pct_not_seen <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/label_percent.html">percent</a></span><span class="op">(</span><span class="va">not_seen</span><span class="op">/</span> <span class="va">total</span>, accuracy <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span>`Admin level 2` <span class="op">=</span> <span class="va">admin_2</span>, 
             `No under surveillance` <span class="op">=</span> <span class="va">total</span>, 
             `Not seen past 2d` <span class="op">=</span> <span class="va">not_seen</span>, 
             `% Not seen` <span class="op">=</span> <span class="va">pct_not_seen</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">rename_with</span><span class="op">(</span>.cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">`No under surveillance`</span>, <span class="va">`Not seen past 2d`</span>, <span class="va">`% Not seen`</span><span class="op">)</span>,
                  .fn <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Past 2d."</span>, <span class="va">.x</span><span class="op">)</span><span class="op">)</span>
    
    
    
    <span class="va">seen_not_seen_past_three_days</span> <span class="op">&lt;-</span> 
      <span class="va">contacts_df_long_filtered</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">follow_up_date</span> <span class="op">&gt;=</span> <span class="va">todays_date</span> <span class="op">-</span> <span class="fl">2</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>counter <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">contact_id</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>number_of_days <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">counter</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">number_of_days</span> <span class="op">&gt;=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">contact_id</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>follow_up_status_simple <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/all.html">all</a></span><span class="op">(</span><span class="va">follow_up_status_simple</span> <span class="op">==</span> <span class="st">"Not seen"</span><span class="op">)</span>,
                                         <span class="st">"Not seen"</span>,
                                         <span class="st">"Seen"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">slice_head</span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">admin_2</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">count</span><span class="op">(</span><span class="va">follow_up_status_simple</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">bind_rows</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>follow_up_status_simple <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Seen"</span>, <span class="st">"Not seen"</span><span class="op">)</span>, 
                           admin_2 <span class="op">=</span> <span class="st">"!!+temporary"</span>,
                           n <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">complete</span><span class="op">(</span><span class="va">admin_2</span>, <span class="va">follow_up_status_simple</span>, 
               fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">admin_2</span> <span class="op">!=</span> <span class="st">"!!+temporary"</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">pivot_wider</span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">follow_up_status_simple</span>, values_from <span class="op">=</span> <span class="va">n</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://rdrr.io/pkg/janitor/man/clean_names.html">clean_names</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>total <span class="op">=</span> <span class="va">not_seen</span> <span class="op">+</span> <span class="va">seen</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>pct_not_seen <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/label_percent.html">percent</a></span><span class="op">(</span><span class="va">not_seen</span><span class="op">/</span> <span class="va">total</span>, accuracy <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span>`Admin level 2` <span class="op">=</span> <span class="va">admin_2</span>, 
             `No under surveillance` <span class="op">=</span> <span class="va">total</span>, 
             `Not seen past 3d` <span class="op">=</span> <span class="va">not_seen</span>, 
             `% Not seen` <span class="op">=</span> <span class="va">pct_not_seen</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">rename_with</span><span class="op">(</span>.cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">`No under surveillance`</span>, <span class="va">`Not seen past 3d`</span>, <span class="va">`% Not seen`</span><span class="op">)</span>,
                  .fn <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Past 3d."</span>, <span class="va">.x</span><span class="op">)</span><span class="op">)</span>
    
    
    <span class="co">## Number of days covered.</span>
    <span class="co">## If there has only been one active date, we do not want the table to show any inactives for the past 2 days, or 3 days etc)</span>
     <span class="va">number_of_days_covered</span> <span class="op">&lt;-</span> 
       <span class="va">contacts_df_long_filtered</span> <span class="op">%&gt;%</span>
       <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">follow_up_status</span> <span class="op">!=</span> <span class="st">"Suivi futur"</span><span class="op">)</span> <span class="op">%&gt;%</span> 
       <span class="fu">count</span><span class="op">(</span><span class="va">follow_up_date</span><span class="op">)</span> <span class="op">%&gt;%</span> 
       <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="op">)</span>
    
    
    <span class="co"># only show "not seen in past day" if there was only one day. etc.</span>
    <span class="va">data_to_plot</span> <span class="op">&lt;-</span> 
      <span class="va">seen_not_seen_today</span> <span class="op">%&gt;%</span> 
      <span class="op">{</span><span class="kw">if</span> <span class="op">(</span><span class="va">number_of_days_covered</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span><span class="op">{</span>
        <span class="fu">left_join</span><span class="op">(</span><span class="va">.</span>, <span class="va">seen_not_seen_past_two_days</span><span class="op">)</span><span class="op">}</span>
        <span class="kw">else</span> <span class="op">{</span><span class="va">.</span><span class="op">}</span>
         <span class="op">}</span> <span class="op">%&gt;%</span> 
      <span class="op">{</span><span class="kw">if</span> <span class="op">(</span><span class="va">number_of_days_covered</span> <span class="op">&gt;</span> <span class="fl">2</span><span class="op">)</span><span class="op">{</span>
        <span class="fu">left_join</span><span class="op">(</span><span class="va">.</span>, <span class="va">seen_not_seen_past_three_days</span><span class="op">)</span><span class="op">}</span>
        <span class="kw">else</span> <span class="op">{</span><span class="va">.</span><span class="op">}</span>
      <span class="op">}</span>
    
    
    <span class="co">## if data is to for download, return at this stage</span>
    <span class="kw">if</span> <span class="op">(</span><span class="va">download</span> <span class="op">==</span> <span class="cn">TRUE</span> <span class="op">)</span> <span class="op">{</span>
      <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">data_to_plot</span><span class="op">)</span>
    <span class="op">}</span>
    

    
    <span class="kw">if</span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data_to_plot</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span><span class="op">{</span>
      <span class="va">no_data_message</span> <span class="op">&lt;-</span> 
        <span class="st">"No data to show"</span> <span class="op">%&gt;%</span> 
        <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
        <span class="fu"><a href="https://rdrr.io/pkg/gt/man/gt.html">gt</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
        <span class="fu"><a href="https://rdrr.io/pkg/gt/man/fmt_markdown.html">fmt_markdown</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu"><a href="https://rdrr.io/pkg/gt/man/tab_options.html">tab_options</a></span><span class="op">(</span>column_labels.hidden <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>
      
      <span class="fu">return_html_or_webshot</span><span class="op">(</span><span class="va">no_data_message</span>, <span class="va">report_format</span><span class="op">)</span>
    <span class="op">}</span>
    
    
    <span class="va">output_table</span> <span class="op">&lt;-</span> 
      <span class="va">data_to_plot</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://rdrr.io/pkg/gt/man/gt.html">gt</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://rdrr.io/pkg/gt/man/fmt_missing.html">fmt_missing</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html">everything</a></span><span class="op">(</span><span class="op">)</span>, missing_text <span class="op">=</span> <span class="st">"-"</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="op">{</span><span class="kw">if</span> <span class="op">(</span><span class="va">number_of_days_covered</span> <span class="op">&gt;</span> <span class="fl">2</span><span class="op">)</span><span class="op">{</span>
        <span class="fu"><a href="https://rdrr.io/pkg/gt/man/data_color.html">data_color</a></span><span class="op">(</span><span class="va">.</span>, columns <span class="op">=</span> <span class="st">"Past 3d.Not seen past 3d"</span>, 
                 colors <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/col_numeric.html">col_numeric</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/paletteer/man/paletteer_d.html">paletteer_d</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"ggsci::red_material"</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="op">)</span>, 
                                              domain <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">seen_not_seen_past_three_days</span><span class="op">$</span><span class="va">`Past 3d.Not seen past 3d`</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="fl">4</span><span class="op">)</span>
                                              <span class="op">)</span>,
                 autocolor_text <span class="op">=</span> <span class="cn">F</span> <span class="op">)</span><span class="op">}</span> 
        <span class="kw">else</span> <span class="op">{</span><span class="va">.</span><span class="op">}</span> <span class="op">}</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://rdrr.io/pkg/gt/man/tab_spanner_delim.html">tab_spanner_delim</a></span><span class="op">(</span>delim <span class="op">=</span> <span class="st">"."</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://rdrr.io/pkg/gt/man/tab_style.html">tab_style</a></span><span class="op">(</span>locations <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/gt/man/cells_column_labels.html">cells_column_labels</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html">everything</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>,
                style <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/gt/man/cell_borders.html">cell_borders</a></span><span class="op">(</span>sides <span class="op">=</span> <span class="st">"bottom"</span>, weight <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/gt/man/px.html">px</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span><span class="op">)</span>,
                     <span class="fu"><a href="https://rdrr.io/pkg/gt/man/cell_text.html">cell_text</a></span><span class="op">(</span>weight <span class="op">=</span> <span class="st">"bold"</span>, size <span class="op">=</span> <span class="st">"small"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://rdrr.io/pkg/gt/man/tab_style.html">tab_style</a></span><span class="op">(</span>locations <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/gt/man/cells_column_spanners.html">cells_column_spanners</a></span><span class="op">(</span>spanners <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html">everything</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>,
                style <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/gt/man/cell_text.html">cell_text</a></span><span class="op">(</span>weight <span class="op">=</span> <span class="st">"bold"</span>, size <span class="op">=</span> <span class="st">"large"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://rdrr.io/pkg/gt/man/opt_row_striping.html">opt_row_striping</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="op">{</span><span class="kw">if</span> <span class="op">(</span><span class="va">number_of_days_covered</span> <span class="op">&gt;</span> <span class="fl">2</span><span class="op">)</span><span class="op">{</span>
      <span class="fu"><a href="https://rdrr.io/pkg/gt/man/tab_source_note.html">tab_source_note</a></span><span class="op">(</span><span class="va">.</span>, source_note <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/gt/man/md.html">md</a></span><span class="op">(</span><span class="st">"*Not seen in past 2/3 days means not seen on **any** of the past 2/3 days"</span><span class="op">)</span><span class="op">)</span>
      <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span><span class="va">.</span><span class="op">}</span> <span class="op">}</span>
    
    
    
    <span class="co">## for static outputs, webshot</span>
    <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"pptx"</span>, <span class="st">"docx"</span>, <span class="st">"pdf"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
        <span class="fu">gt_webshot</span><span class="op">(</span><span class="va">output_table</span><span class="op">)</span> 
    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
      <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">output_table</span><span class="op">)</span>
    <span class="op">}</span>
    
  <span class="op">}</span></code></pre></div>
<div id="contacts_lost_24_to_72_hours_table_download" class="section level2">
<h2 class="hasAnchor">
<a href="#contacts_lost_24_to_72_hours_table_download" class="anchor"></a>contacts_lost_24_to_72_hours_table_download</h2>
<div class="sourceCode" id="cb70"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">contacts_lost_24_to_72_hours_table_download</span> <span class="op">&lt;-</span> 
  <span class="kw">function</span><span class="op">(</span><span class="op">)</span><span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/downloadHandler.html">downloadHandler</a></span><span class="op">(</span>
      filename <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"contacts_lost_summary.csv"</span><span class="op">)</span>,
      
      content <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">file</span><span class="op">)</span><span class="op">{</span>
        <span class="va">file_to_write</span> <span class="op">&lt;-</span> <span class="fu">contacts_lost_24_to_72_hours_table</span><span class="op">(</span><span class="fu">read_file_filtered_reactive</span><span class="op">(</span><span class="op">)</span>, 
                                                            <span class="va">input</span><span class="op">$</span><span class="va">select_date_of_review</span>, 
                                                            download <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
        <span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.csv</a></span><span class="op">(</span><span class="va">file_to_write</span>, <span class="va">file</span><span class="op">)</span><span class="op">}</span>
      
    <span class="op">)</span>
    
  <span class="op">}</span></code></pre></div>
</div>
<div id="lost_contacts_linelist_table" class="section level2">
<h2 class="hasAnchor">
<a href="#lost_contacts_linelist_table" class="anchor"></a>lost_contacts_linelist_table</h2>
<div class="sourceCode" id="cb71"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">lost_contacts_linelist_table</span> <span class="op">&lt;-</span> 
  <span class="kw">function</span><span class="op">(</span><span class="va">contacts_df_long</span>, <span class="va">todays_date</span>, <span class="va">download</span> <span class="op">=</span> <span class="cn">FALSE</span>, <span class="va">report_format</span> <span class="op">=</span> <span class="st">"shiny"</span><span class="op">)</span><span class="op">{</span>
    
    <span class="va">contacts_df_long_filtered</span> <span class="op">&lt;-</span> 
      <span class="va">contacts_df_long</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">row_id</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="co">## keep active cases. </span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">follow_up_date</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span> <span class="op">&gt;=</span> <span class="va">todays_date</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">follow_up_status_simple</span> <span class="op">!=</span> <span class="st">"Suivi futur"</span><span class="op">)</span>
    
    <span class="co">## first isolate those who were missing in past three days</span>
    <span class="va">seen_not_seen_past_three_days</span> <span class="op">&lt;-</span> 
      <span class="va">contacts_df_long_filtered</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">follow_up_date</span> <span class="op">&gt;=</span> <span class="va">todays_date</span> <span class="op">-</span> <span class="fl">2</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>counter <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">contact_id</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>number_of_days <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">counter</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">number_of_days</span> <span class="op">&gt;=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">contact_id</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>follow_up_status_simple <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/all.html">all</a></span><span class="op">(</span><span class="va">follow_up_status_simple</span> <span class="op">==</span> <span class="st">"Not seen"</span><span class="op">)</span>,
                                         <span class="st">"Not seen"</span>,
                                         <span class="st">"Seen"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">follow_up_status_simple</span> <span class="op">==</span> <span class="st">"Not seen"</span><span class="op">)</span>
    
    
    <span class="co">## if there is no data, early return with empty table</span>
    <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">seen_not_seen_past_three_days</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span><span class="op">{</span>
           
           <span class="kw">if</span> <span class="op">(</span><span class="va">download</span> <span class="op">==</span> <span class="cn">TRUE</span> <span class="op">)</span> <span class="op">{</span>
             <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span>
               <span class="st">"No data to show"</span> <span class="op">%&gt;%</span> 
                 <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="op">)</span>
             <span class="op">)</span>
           <span class="op">}</span>
           
           <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"shiny"</span>, <span class="st">"html (page)"</span>, <span class="st">"html (slides)"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
           <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span>
             <span class="st">"No data to show"</span> <span class="op">%&gt;%</span> 
               <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
               <span class="fu"><a href="https://glin.github.io/reactable/reference/reactable.html">reactable</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">}</span>
           
           <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"pdf"</span>, <span class="st">"pptx"</span>, <span class="st">"docx"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
             <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span>
               <span class="st">"No data to show"</span> <span class="op">%&gt;%</span> 
                 <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
                 <span class="fu"><a href="https://hughjonesd.github.io/huxtable/reference/huxtable.html">huxtable</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
                 <span class="fu"><a href="https://hughjonesd.github.io/huxtable/reference/themes.html">theme_blue</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">}</span>
    <span class="op">}</span>
    
    
    <span class="co">## filter out lost-to-follow-up individuals from the regular data frame</span>
    <span class="va">data_to_plot</span> <span class="op">&lt;-</span> 
      <span class="va">contacts_df_long</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">contact_id</span> <span class="op">%in%</span> <span class="va">seen_not_seen_past_three_days</span><span class="op">$</span><span class="va">contact_id</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span>ID <span class="op">=</span> <span class="va">contact_id</span>, 
             `Admin level 2` <span class="op">=</span> <span class="va">admin_2</span>, 
             Dates <span class="op">=</span> <span class="va">follow_up_date</span>, 
             `Follow-up Day` <span class="op">=</span> <span class="va">follow_up_day</span>,
             `Follow-up States` <span class="op">=</span> <span class="va">follow_up_status</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">ID</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">Dates</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span>  <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/gtools/man/mixedsort.html">mixedorder</a></span><span class="op">(</span><span class="va">ID</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
    
    <span class="co">## if there is no data, early return with empty table</span>
    <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data_to_plot</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span><span class="op">{</span>
      
      <span class="kw">if</span> <span class="op">(</span><span class="va">download</span> <span class="op">==</span> <span class="cn">TRUE</span> <span class="op">)</span> <span class="op">{</span>
        <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span>
          <span class="st">"No data to show"</span> <span class="op">%&gt;%</span> 
            <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="op">)</span>
        <span class="op">)</span>
      <span class="op">}</span>
      
      <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"shiny"</span>, <span class="st">"html (page)"</span>, <span class="st">"html (slides)"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
        <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span>
          <span class="st">"No data to show"</span> <span class="op">%&gt;%</span> 
            <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
            <span class="fu"><a href="https://glin.github.io/reactable/reference/reactable.html">reactable</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">}</span>
      
      <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"pdf"</span>, <span class="st">"pptx"</span>, <span class="st">"docx"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
        <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span>
          <span class="st">"No data to show"</span> <span class="op">%&gt;%</span> 
            <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
            <span class="fu"><a href="https://hughjonesd.github.io/huxtable/reference/huxtable.html">huxtable</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
            <span class="fu"><a href="https://hughjonesd.github.io/huxtable/reference/themes.html">theme_blue</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">}</span>
    <span class="op">}</span>
    
    <span class="co">## if there is data, do it over with real data</span>
    
    
    <span class="co">## if data is to for download, return at this stage</span>
    <span class="kw">if</span> <span class="op">(</span><span class="va">download</span> <span class="op">==</span> <span class="cn">TRUE</span> <span class="op">)</span> <span class="op">{</span>
        <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">data_to_plot</span><span class="op">)</span>
      <span class="op">}</span>
    

    <span class="co">## create output reacttable</span>
    <span class="va">output_table</span> <span class="op">&lt;-</span> <span class="va">data_to_plot</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://glin.github.io/reactable/reference/reactable.html">reactable</a></span><span class="op">(</span>groupBy <span class="op">=</span> <span class="st">"ID"</span>, 
                columns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>`Follow-up States` <span class="op">=</span> <span class="fu"><a href="https://glin.github.io/reactable/reference/colDef.html">colDef</a></span><span class="op">(</span>aggregate <span class="op">=</span> <span class="st">"frequency"</span><span class="op">)</span>, 
                               `Admin level 2` <span class="op">=</span> <span class="fu"><a href="https://glin.github.io/reactable/reference/colDef.html">colDef</a></span><span class="op">(</span>aggregate <span class="op">=</span> <span class="st">"unique"</span><span class="op">)</span>
                               <span class="op">)</span>,
                searchable <span class="op">=</span> <span class="cn">TRUE</span>,
                striped <span class="op">=</span> <span class="cn">TRUE</span>,
                highlight <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> 

        
    <span class="co">## title depending on number of days</span>
    <span class="va">number_of_days_covered</span> <span class="op">&lt;-</span> 
      <span class="va">contacts_df_long_filtered</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">follow_up_status</span> <span class="op">!=</span> <span class="st">"Suivi futur"</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">count</span><span class="op">(</span><span class="va">follow_up_date</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="op">)</span>
    
    <span class="va">table_title_init</span> <span class="op">&lt;-</span> <span class="st">"Contacts not seen in the past day"</span>
    <span class="kw">if</span> <span class="op">(</span><span class="va">number_of_days_covered</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span> <span class="va">table_title_init</span> <span class="op">&lt;-</span> <span class="st">"Contacts not seen in the past 2 days"</span>
    <span class="kw">if</span> <span class="op">(</span><span class="va">number_of_days_covered</span> <span class="op">&gt;</span> <span class="fl">2</span><span class="op">)</span> <span class="va">table_title_init</span> <span class="op">&lt;-</span> <span class="st">"Contacts not seen in the past 3 days"</span>
    
    <span class="va">table_title</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/htmltools/man/builder.html">h4</a></span><span class="op">(</span><span class="va">table_title_init</span><span class="op">)</span>
    
    <span class="co">## for static outputs, use huxtable</span>
    <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"pptx"</span>, <span class="st">"docx"</span>, <span class="st">"pdf"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
      
      <span class="va">output_table</span> <span class="op">&lt;-</span>
        <span class="va">data_to_plot</span> <span class="op">%&gt;%</span> 
        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">ID</span><span class="op">)</span> <span class="op">%&gt;%</span> 
        <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
        <span class="fu">split_long_df</span><span class="op">(</span><span class="fl">15</span><span class="op">)</span> <span class="op">%&gt;%</span> 
        <span class="fu"><a href="https://hughjonesd.github.io/huxtable/reference/huxtable.html">huxtable</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
        <span class="fu"><a href="https://hughjonesd.github.io/huxtable/reference/set-multiple.html">set_all_padding</a></span><span class="op">(</span><span class="fl">0.5</span><span class="op">)</span> <span class="op">%&gt;%</span>
        <span class="fu"><a href="https://hughjonesd.github.io/huxtable/reference/themes.html">theme_blue</a></span><span class="op">(</span><span class="op">)</span>

    <span class="op">}</span>
    
    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>table_title <span class="op">=</span> <span class="va">table_title</span>, 
                output_table <span class="op">=</span> <span class="va">output_table</span>
                <span class="op">)</span><span class="op">)</span>
    
  <span class="op">}</span></code></pre></div>
</div>
<div id="lost_contacts_linelist_table_download" class="section level2">
<h2 class="hasAnchor">
<a href="#lost_contacts_linelist_table_download" class="anchor"></a>lost_contacts_linelist_table_download</h2>
<div class="sourceCode" id="cb72"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">lost_contacts_linelist_table_download</span> <span class="op">&lt;-</span> 
  <span class="kw">function</span><span class="op">(</span><span class="op">)</span><span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/downloadHandler.html">downloadHandler</a></span><span class="op">(</span>
      filename <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"lost_contacts_linelist.csv"</span><span class="op">)</span>,
      
      content <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">file</span><span class="op">)</span><span class="op">{</span>
        <span class="va">file_to_write</span> <span class="op">&lt;-</span> <span class="fu">lost_contacts_linelist_table</span><span class="op">(</span><span class="fu">read_file_filtered_reactive</span><span class="op">(</span><span class="op">)</span>, 
                                                      <span class="va">input</span><span class="op">$</span><span class="va">select_date_of_review</span>, 
                                                      download <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
        <span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.csv</a></span><span class="op">(</span><span class="va">file_to_write</span>, <span class="va">file</span><span class="op">)</span><span class="op">}</span>
      
    <span class="op">)</span>
    
  <span class="op">}</span></code></pre></div>
</div>
<div id="lost_contacts_linelist_text" class="section level2">
<h2 class="hasAnchor">
<a href="#lost_contacts_linelist_text" class="anchor"></a>lost_contacts_linelist_text</h2>
<div class="sourceCode" id="cb73"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">lost_contacts_linelist_text</span> <span class="op">&lt;-</span> 
  <span class="kw">function</span><span class="op">(</span><span class="va">contacts_df_long</span>, <span class="va">todays_date</span>, <span class="va">report_format</span> <span class="op">=</span> <span class="st">"shiny"</span><span class="op">)</span><span class="op">{</span>
    
    <span class="va">lost_contacts_table</span> <span class="op">&lt;-</span> 
      <span class="fu">lost_contacts_linelist_table</span><span class="op">(</span><span class="va">contacts_df_long</span>, 
                                 <span class="va">todays_date</span>, 
                                 download <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
    
    <span class="co">### if there is no data,</span>
    <span class="kw">if</span> <span class="op">(</span><span class="va">lost_contacts_table</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">==</span> <span class="st">"No data to show"</span><span class="op">)</span><span class="op">{</span>
      
      <span class="va">info</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/htmltools/man/HTML.html">HTML</a></span><span class="op">(</span><span class="st">"&lt;br&gt;
         &lt;span style='color: rgb(97, 189, 109);'&gt;ℹ:&lt;/span&gt;
         &lt;font size='1'&gt;
         The tables track the contacts who should be under surveillance but have not been followed for an extended period.
                    &lt;/font&gt;"</span><span class="op">)</span>
      
      <span class="va">str1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op">(</span><span class="st">"&lt;br&gt;&lt;br&gt;
                   No lost to follow-up (LTFU) contacts to show. 
                   (An LTFU contact is a contact that has not been seen for more than two days.)"</span><span class="op">)</span>
      
      <span class="va">output_text</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/htmltools/man/HTML.html">HTML</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">info</span>, <span class="va">str1</span>, sep <span class="op">=</span> <span class="st">'&lt;br/&gt;'</span><span class="op">)</span><span class="op">)</span>
      
      <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"pptx"</span>,<span class="st">"docx"</span>, <span class="st">"pdf"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
        
        <span class="va">output_text</span> <span class="op">&lt;-</span> 
          <span class="va">output_text</span> <span class="op">%&gt;%</span> 
          <span class="fu"><a href="https://rdrr.io/r/base/rawConversion.html">charToRaw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
          <span class="fu"><a href="http://xml2.r-lib.org/reference/read_xml.html">read_html</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
          <span class="fu"><a href="https://rvest.tidyverse.org/reference/html_text.html">html_text2</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
          <span class="fu">str_trim</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
          <span class="fu">pander</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pander/man/pandoc.p.return.html">pandoc.p</a></span><span class="op">(</span><span class="op">)</span>
        <span class="co"># no need to return anything. pandoc.p prints automatically</span>
        <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu">pander</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pander/man/pandoc.p.return.html">pandoc.p</a></span><span class="op">(</span><span class="st">" "</span><span class="op">)</span><span class="op">)</span>
      <span class="op">}</span>
      
      <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"shiny"</span>, <span class="st">"html (page)"</span>, <span class="st">"html (slides)"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
        <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">output_text</span><span class="op">)</span>
      <span class="op">}</span>
      
      
    <span class="op">}</span>
    
    <span class="co">## if there is data, do it all over again, but with actual numbers</span>
    
    <span class="va">number_of_contacts_lost</span> <span class="op">&lt;-</span>  
    <span class="va">lost_contacts_table</span> <span class="op">%&gt;%</span> 
      <span class="fu">pull</span><span class="op">(</span><span class="va">ID</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="op">)</span>
    
    <span class="va">info</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/htmltools/man/HTML.html">HTML</a></span><span class="op">(</span><span class="st">"&lt;br&gt;
         &lt;span style='color: rgb(97, 189, 109);'&gt;ℹ:&lt;/span&gt;
         &lt;font size='1'&gt;
         The tables track the contacts who should be under surveillance but have not been followed for an extended period.
                    &lt;/font&gt;"</span><span class="op">)</span>
    
    <span class="va">str1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op">(</span><span class="st">"&lt;br&gt;&lt;br&gt;
                 &lt;b&gt;{number_of_contacts_lost}&lt;/b&gt; contacts have not been seen for the past three days."</span><span class="op">)</span>
    
    <span class="va">output_text</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/htmltools/man/HTML.html">HTML</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">info</span>, <span class="va">str1</span>, sep <span class="op">=</span> <span class="st">'&lt;br/&gt;'</span><span class="op">)</span><span class="op">)</span>
    
    <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"pptx"</span>,<span class="st">"docx"</span>, <span class="st">"pdf"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
      
      <span class="va">output_text</span> <span class="op">&lt;-</span> 
        <span class="va">output_text</span> <span class="op">%&gt;%</span> 
        <span class="fu"><a href="https://rdrr.io/r/base/rawConversion.html">charToRaw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
        <span class="fu"><a href="http://xml2.r-lib.org/reference/read_xml.html">read_html</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
        <span class="fu"><a href="https://rvest.tidyverse.org/reference/html_text.html">html_text2</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
        <span class="fu">str_trim</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
        <span class="fu">pander</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pander/man/pandoc.p.return.html">pandoc.p</a></span><span class="op">(</span><span class="op">)</span>
      <span class="co"># no need to return anything. pandoc.p prints automatically</span>
      
      
    <span class="op">}</span>
    
    <span class="kw">if</span> <span class="op">(</span><span class="va">report_format</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"shiny"</span>, <span class="st">"html (page)"</span>, <span class="st">"html (slides)"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
      <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">output_text</span><span class="op">)</span>
      <span class="op">}</span>
    
    <span class="op">}</span></code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Kene David Nwosu.</p>
</div>

<div class="pkgdown">
  <p>Made with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1, using <a href="https://preferably.amirmasoudabdol.name/?source=footer">preferably</a> template.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
